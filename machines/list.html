<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Listado de M치quinas</h4>
        <button class="btn btn-success btn-sm" onclick="appLoad('machines/new.html')">
            <i class="fas fa-plus me-1"></i> Nueva M치quina
        </button>
    </div>

    <div class="mb-3">
        <input type="text" id="machine-search" class="form-control" placeholder="Buscar m치quina...">
    </div>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Serial</th>
                    <th>N칰mero</th>
                    <th>Modelo / Marca</th>
                    <th>Cliente</th>
                    <th>Ubicaci칩n</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="machines-tbody">
                <tr>
                    <td colspan="6" class="text-center">Cargando m치quinas...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    if (typeof locationsCache === 'undefined') {
    locationsCache = [];
}
function loadMachineDetail(id) {
    // Guardar el ID en sessionStorage o variable global
    sessionStorage.setItem('selectedMachineId', id);
    appLoad('machines/detail.html');
}

    async function loadLocations() {
        try {
            locationsCache = await locationService.list();
        } catch (err) {
            console.error("Error cargando locations:", err);
            showAlert("No se pudieron cargar las ubicaciones", "danger");
            locationsCache = [];
        }
    }

    async function loadMachines(query = "") {
        try {
            const machines = query 
                ? await machineService.search(query) 
                : await machineService.list();

            const tbody = document.getElementById("machines-tbody");
            tbody.innerHTML = "";

            if (machines && machines.length > 0) {
                machines.forEach(m => {
                    const loc = locationsCache.find(l => l.id === m.currentLocationId);
                    tbody.innerHTML += `
                        <tr>
                            <td>${m.companySerial || 'N/A'}</td>
                            <td>${m.companyNumber || ''}</td>
                            <td>
                                ${m.model || 'N/A'}<br>
                                <small>${m.brand || ''}</small>
                            </td>
                            <td>${m.customerName || 'N/A'}</td>
                            <td>${loc ? loc.name : ''}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="loadMachineDetail(${m.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="appLoad('machines/edit.html?id=${m.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteMachine(${m.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">No se encontraron m치quinas</td></tr>`;
            }
        } catch (error) {
            console.error("Error loading machines:", error);
            showAlert("Error cargando m치quinas", "danger");
        }
    }

    async function deleteMachine(id) {
        if (!confirm("쯉eguro que deseas eliminar esta m치quina?")) return;
        try {
            await machineService.delete(id);
            showAlert("M치quina eliminada", "success");
            loadMachines();
        } catch (error) {
            console.error("Error deleting machine:", error);
            showAlert("Error eliminando m치quina", "danger");
        }
    }

    // 游 Cargar locations primero y luego machines
    (async () => {
        await loadLocations();
        await loadMachines();
    })();

    document.getElementById("machine-search").addEventListener("input", (e) => {
        loadMachines(e.target.value);
    });



</script>