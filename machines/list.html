<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Listado de Máquinas</h4>
    <button class="btn btn-success btn-sm" onclick="appLoad('machines/new.html')">
      <i class="fas fa-plus me-1"></i> Nueva Máquina
    </button>
  </div>

  <div class="mb-3">
    <input type="text" id="machine-search" class="form-control" placeholder="Buscar máquina...">
  </div>

  <div class="table-responsive">
    <table class="table table-hover">
      <thead class="table-light">
        <tr>
          <th>Serial</th>
          <th>Número</th>
          <th>Modelo / Marca</th>
          <th>Cliente</th>
          <th>Ubicación</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="machines-tbody">
        <tr>
          <td colspan="6" class="text-center">Cargando máquinas...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
async function loadMachines(query = "") {
  try {
    // 👇 si no está inicializado el cache de locations, lo cargamos
    if (!locationsCache || locationsCache.length === 0) {
      locationsCache = await locationService.list();
    }

    const machines = query 
      ? await machineService.search(query) 
      : await machineService.list();

    const tbody = document.getElementById("machines-tbody");
    tbody.innerHTML = "";

    if (machines && machines.length > 0) {
      machines.forEach(m => {
        const loc = locationsCache.find(l => l.id === m.currentLocationId);

        tbody.innerHTML += `
          <tr>
            <td>${m.companySerial || 'N/A'}</td>
            <td>${m.companyNumber || ''}</td>
            <td>
              ${m.model || 'N/A'}<br>
              <small>${m.brand || ''}</small>
            </td>
            <td>${m.customerName || 'N/A'}</td>
            <td>${loc ? loc.name : ''}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="appLoad('machines/detail.html?id=${m.id}')">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-sm btn-warning" onclick="appLoad('machines/edit.html?id=${m.id}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteMachine(${m.id})">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });
    } else {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center">No se encontraron máquinas</td></tr>`;
    }
  } catch (error) {
    console.error("Error loading machines:", error);
    showAlert("Error cargando máquinas", "danger");
  }
}

async function deleteMachine(id) {
  if (!confirm("¿Seguro que deseas eliminar esta máquina?")) return;
  try {
    await machineService.delete(id);
    showAlert("Máquina eliminada", "success");
    loadMachines();
  } catch (error) {
    console.error("Error deleting machine:", error);
    showAlert("Error eliminando máquina", "danger");
  }
}

// 🚀 Cargar machines al iniciar
(async () => {
  await loadMachines();
})();

document.getElementById("machine-search").addEventListener("input", (e) => {
  loadMachines(e.target.value);
});
</script>
👉 Ahora list.html ya no declara locationsCache, solo lo usa.