<div class="card p-3">
  <h4>Crear M치quina</h4>
  <form id="form-create-machine" class="row g-3 needs-validation" novalidate>
    <div class="col-md-6">
      <label class="form-label">Serial (companySerial) *</label>
      <input class="form-control" name="companySerial" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">N칰mero (companyNumber)</label>
      <input class="form-control" name="companyNumber">
    </div>

    <div class="col-md-4">
      <label class="form-label">Modelo *</label>
      <input class="form-control" name="model" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Marca</label>
      <input class="form-control" name="brand">
    </div>
    <div class="col-md-2">
      <label class="form-label">A침o</label>
      <input type="number" class="form-control" name="year">
    </div>

    <div class="col-12">
      <label class="form-label">Notas de la m치quina</label>
      <textarea class="form-control" name="notes" rows="2"></textarea>
    </div>

    <!-- 游댳 Campos para la lectura inicial -->
    <div class="col-md-6">
      <label class="form-label">Lectura inicial *</label>
      <input type="number" class="form-control" name="initialReading" required value="0">
    </div>
    <div class="col-md-6">
      <label class="form-label">Notas de lectura</label>
      <input class="form-control" name="readingNotes" placeholder="Ej: Lectura inicial al instalar">
    </div>

    <!-- 游댳 Selector de estado -->
    <div class="col-md-6">
      <label class="form-label">Estado</label>
      <select class="form-select" name="status" required>
        <option value="BODEGA" selected>Bodega</option>
        <option value="INSTALADA">Instalada</option>
        <option value="MANTENIMIENTO">Mantenimiento</option>
        <option value="RETIRADA">Retirada</option>
      </select>
    </div>

<div class="col-md-6">
  <label class="form-label">Ubicaci칩n actual</label>
  <select class="form-select" name="currentLocationId" id="machine-location" required>
    <option value="">Seleccione una ubicaci칩n</option>
  </select>
</div>

    <div class="col-12">
      <button class="btn btn-success" type="submit">Crear</button>
      <button class="btn btn-outline-secondary" type="button" onclick="appLoad('machines/list.html')">Cancelar</button>
    </div>
  </form>
</div>

<script>
(async () => {
  try {
    // 游댳 Cargar ubicaciones
    const locations = await locationService.list();
    window.locationsCache = locations; // cache opcional
    const select = document.getElementById("machine-location");
    select.innerHTML = '<option value="">Seleccione una ubicaci칩n</option>';
    
    locations.forEach(loc => {
      const opt = document.createElement("option");
      opt.value = loc.id;
      opt.textContent = loc.name + (loc.address ? " - " + loc.address : "");
      select.appendChild(opt);
    });

    // 游댳 Cargar clientes y cachearlos
    window.customersCache = await customerService.list();

  } catch (err) {
    console.error("Error cargando datos", err);
    showAlert("No se pudieron cargar ubicaciones/clientes", "danger");
  }
})();

document.getElementById("form-create-machine").addEventListener("submit", async (e) => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));
  data.year = data.year ? parseInt(data.year) : null;
  data.currentLocationId = data.currentLocationId ? parseInt(data.currentLocationId) : null;

  // 游댳 Buscar el cliente seg칰n la ubicaci칩n elegida
  let selectedCustomerId = null;
  if (window.customersCache && data.currentLocationId) {
    const customer = window.customersCache.find(c => c.location && c.location.id === data.currentLocationId);
    if (customer) {
      selectedCustomerId = customer.id;
    }
  }

  // 游댳 Asignar el cliente al payload
  data.currentCustomerId = selectedCustomerId;

  try {
    await machineService.create(data);
    showAlert("M치quina creada correctamente", "success");
    appLoad("machines/list.html");
  } catch (err) {
    showAlert("Error creando m치quina: " + err.message, "danger");
  }
});

</script>