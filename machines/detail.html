
<<div class="card p-3">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h4 id="m-title">Máquina</h4>
      <p class="text-muted" id="m-sub">Detalle de máquina</p>
    </div>
    <div>
      <button class="btn btn-outline-secondary" onclick="appLoad('machines/edit.html?id='+__MID)">Editar</button>
      <button class="btn btn-success" onclick="appLoad('machines/service_requests.html')">Ver solicitudes</button>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <h6>Información</h6>
      <table class="table">
        <tbody id="m-info"></tbody>
      </table>
    </div>
    <div class="col-md-6">
      <h6>Estado y ubicación</h6>
      <table class="table">
        <tbody id="m-location"></tbody>
      </table>
      <button class="btn btn-sm btn-primary mt-2" onclick="showMoveForm()">Agregar movimiento</button>
      <div id="move-form" class="mt-2" style="display:none;">
        <select id="new-location" class="form-select mb-2"></select>
        <input type="text" id="move-reason" class="form-control mb-2" placeholder="Razón del movimiento">
        <button class="btn btn-success btn-sm" onclick="saveMovement()">Guardar movimiento</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="hideMoveForm()">Cancelar</button>
      </div>
    </div>
  </div>

  <h5>Historial de movimientos</h5>
  <div class="table-responsive mb-3"><table class="table" id="m-movements"></table></div>

  <h5>Lecturas (meter readings)</h5>
  <div class="table-responsive"><table class="table" id="m-meter"></table></div>
</div>

<script>
let machineData = null;
let locationsCache = [];

async function loadLocations() {
  try {
    const response = await fetch(API_BASE + "/locations");
    if (!response.ok) throw new Error("Error cargando ubicaciones");
    locationsCache = await response.json();
  } catch (err) {
    console.error("Error loading locations:", err);
    showAlert("Error cargando ubicaciones", "danger");
  }
}

async function loadDetail(){
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  if(!id) {
    showAlert("ID de máquina no especificado", "danger");
    return;
  }
  
  window.__MID = id;

  try {
    // Cargar ubicaciones primero
    await loadLocations();
    
    // Cargar datos de la máquina
    const response = await fetch(API_BASE + "/machines/" + id);
    if (!response.ok) throw new Error("Error cargando máquina");
    
    const result = await response.json();
    machineData = result.data || result;
    
    if (!machineData) {
      showAlert("Máquina no encontrada", "danger");
      return;
    }

    document.getElementById("m-title").innerText = machineData.companySerial || ('Máquina '+machineData.id);
    document.getElementById("m-sub").innerText = `${machineData.brand||''} ${machineData.model||''}`;

    document.getElementById("m-info").innerHTML = `
      <tr><th>Serial</th><td>${machineData.companySerial||''}</td></tr>
      <tr><th>Número</th><td>${machineData.companyNumber||''}</td></tr>
      <tr><th>Año</th><td>${machineData.year||''}</td></tr>
      <tr><th>Notas</th><td>${machineData.notes||''}</td></tr>
    `;

    const locName = locationsCache.find(l=>l.id===machineData.currentLocationId)?.name || 'N/A';
    document.getElementById("m-location").innerHTML = `
      <tr><th>Ubicación</th><td>${locName}</td></tr>
      <tr><th>Estado</th><td>${machineData.status || 'N/A'}</td></tr>
    `;

    // Cargar movimientos
    await loadMovements(id);
    
    // Cargar lecturas
    await loadMeterReadings(id);

  } catch(err){
    console.error("Error cargando detalle:", err);
    showAlert("Error cargando máquina: " + err.message,"danger");
  }
}

async function loadMovements(machineId) {
  try {
    const response = await fetch(API_BASE + "/machine-movements?machineId=" + machineId);
    if (!response.ok) throw new Error("Error cargando movimientos");
    
    const result = await response.json();
    const moves = result.data || result || [];
    
    const mvT = document.getElementById("m-movements");
    mvT.innerHTML = `
      <thead>
        <tr>
          <th>Fecha</th>
          <th>De</th>
          <th>A</th>
          <th>Tipo</th>
          <th>Razón</th>
        </tr>
      </thead>
      <tbody>
        ${moves.map(x => {
          const fromLoc = locationsCache.find(l=>l.id===x.fromLocationId)?.name || x.fromLocationId || '';
          const toLoc = locationsCache.find(l=>l.id===x.toLocationId)?.name || x.toLocationId || '';
          return `
            <tr>
              <td>${x.effectiveDate ? new Date(x.effectiveDate).toLocaleString() : 'N/A'}</td>
              <td>${fromLoc}</td>
              <td>${toLoc}</td>
              <td>${x.movementType||''}</td>
              <td>${x.reason||''}</td>
            </tr>`;
        }).join('') || '<tr><td colspan="5" class="text-center">No hay movimientos</td></tr>'}
      </tbody>
    `;
  } catch(err) {
    console.error("Error cargando movimientos:", err);
    document.getElementById("m-movements").innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error cargando movimientos</td></tr>';
  }
}

async function loadMeterReadings(machineId) {
  try {
    const response = await fetch(API_BASE + "/meter-readings?machineId=" + machineId);
    if (!response.ok) throw new Error("Error cargando lecturas");
    
    const result = await response.json();
    const meters = result.data || result || [];
    
    document.getElementById("m-meter").innerHTML = `
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Lectura</th>
          <th>Notas</th>
        </tr>
      </thead>
      <tbody>
        ${meters.map(mr => `
          <tr>
            <td>${mr.readingDate ? new Date(mr.readingDate).toLocaleString() : 'N/A'}</td>
            <td>${mr.reading || 'N/A'}</td>
            <td>${mr.notes || ''}</td>
          </tr>`
        ).join('') || '<tr><td colspan="3" class="text-center">No hay lecturas</td></tr>'}
      </tbody>
    `;
  } catch(err) {
    console.error("Error cargando lecturas:", err);
    document.getElementById("m-meter").innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error cargando lecturas</td></tr>';
  }
}

function showMoveForm(){
  const sel = document.getElementById("new-location");
  sel.innerHTML = '<option value="">Seleccione ubicación</option>' +
    locationsCache.map(l=>`<option value="${l.id}">${l.name}</option>`).join('');
  document.getElementById("move-form").style.display = "block";
}

function hideMoveForm(){
  document.getElementById("move-form").style.display = "none";
}

async function saveMovement(){
  const toId = document.getElementById("new-location").value;
  const reason = document.getElementById("move-reason").value;
  
  if(!toId){
    showAlert("Seleccione una ubicación destino", "warning");
    return;
  }

  try {
    const movementData = {
      machineId: __MID,
      fromLocationId: machineData.currentLocationId,
      toLocationId: parseInt(toId),
      movementType: "REUBICACION",
      reason: reason,
      effectiveDate: new Date().toISOString()
    };

    // Crear movimiento
    const response = await fetch(API_BASE + "/machine-movements", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(movementData)
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(errorText || "Error creando movimiento");
    }

    // Actualizar la ubicación actual de la máquina
    const updateResponse = await fetch(API_BASE + "/machines/" + __MID, {
      method: "PUT",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        ...machineData,
        currentLocationId: parseInt(toId)
      })
    });

    if (!updateResponse.ok) {
      throw new Error("Error actualizando ubicación de la máquina");
    }

    showAlert("Movimiento registrado correctamente","success");
    hideMoveForm();
    
    // Recargar los datos
    await loadDetail();
    
  } catch(err){
    console.error("Error guardando movimiento:", err);
    showAlert("Error al guardar movimiento: " + err.message,"danger");
  }
}

// Inicializar cuando se carga la página
document.addEventListener("DOMContentLoaded", function() {
  loadDetail();
});
</script>