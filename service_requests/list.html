<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Solicitudes de Servicio</h4>
    <button class="btn btn-success btn-sm" onclick="appLoad('service_requests/new.html')">
      <i class="fas fa-plus me-1"></i> Nueva Solicitud
    </button>
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Cliente</th>
          <th>MÃ¡quina</th>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Estado</th>
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody id="requests-table">
        <tr>
          <td colspan="7" class="text-center text-muted">Cargando solicitudes...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
    
(async function() {
  const tbody = document.getElementById("requests-table");

  try {
    // ðŸ‘‰ Definir caches globales para no re-declarar
    if (!window.customersCache || window.customersCache.length === 0) {
      window.customersCache = await customerService.list();
    }

    if (!window.machinesCache || window.machinesCache.length === 0) {
      window.machinesCache = await machineService.list();
    }

    const requests = await serviceRequestService.list();

    if (!requests || requests.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No hay solicitudes registradas</td></tr>`;
      return;
    }

    tbody.innerHTML = "";
    for (const r of requests) {
      const date = r.reportedAt ? new Date(r.reportedAt).toLocaleDateString() : "N/A";

      // Buscar cliente y mÃ¡quina en caches
      const customer = window.customersCache.find(c => c.id === r.customerId);
      const machine = window.machinesCache.find(m => m.id === r.machineId);

      tbody.innerHTML += `
        <tr>
          <td>${r.requestNumber || r.id}</td>
          <td>${customer ? customer.name : "Cliente N/A"}</td>
          <td>${machine ? machine.companySerial : "MÃ¡quina N/A"}</td>
          <td>${date}</td>
          <td>${r.serviceType || "N/A"}</td>
          <td><span class="badge ${r.status === "ABIERTA" ? "bg-warning" : "bg-success"}">${r.status}</span></td>
          <td class="text-end">
            <button class="btn btn-outline-primary btn-sm me-1" onclick="viewRequest(${r.id})">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-outline-secondary btn-sm me-1" onclick="editRequest(${r.id})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteRequest(${r.id})">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
    }
  } catch (err) {
    console.error("Error cargando solicitudes:", err);
    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error cargando solicitudes</td></tr>`;
  }
})();

function viewRequest(id) {
  sessionStorage.setItem("selectedRequestId", id);
  appLoad("service_requests/detail.html");
}

function editRequest(id) {
  sessionStorage.setItem("selectedRequestId", id);
  appLoad("service_requests/edit.html");
}

async function deleteRequest(id) {
  if (!confirm("Â¿Seguro que deseas eliminar esta solicitud?")) return;
  try {
    await serviceRequestService.remove(id);
    showAlert("Solicitud eliminada correctamente", "success");
    appLoad("service_requests/list.html");
  } catch (err) {
    showAlert("Error al eliminar: " + err.message, "danger");
  }
}
</script>