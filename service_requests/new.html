<div class="card p-3">
  <h4>Nueva Solicitud</h4>

  <!-- Informaci√≥n precargada (solo lectura) -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Informaci√≥n Precargada</h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <strong>Cliente:</strong>
          <span id="preloaded-customer-name"></span>
          <small id="preloaded-customer-nit" class="text-muted"></small>
        </div>
        <div class="col-md-6">
          <strong>M√°quina:</strong>
          <span id="preloaded-machine-serial"></span>
          <small id="preloaded-machine-number" class="text-muted"></small>
        </div>
      </div>
    </div>
  </div>

  <!-- Historial de solicitudes para esta m√°quina -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Solicitudes Anteriores de esta M√°quina</h6>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Seleccionar</th>
              <th>N√∫mero</th>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Causa Ra√≠z</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="previous-requests">
            <tr>
              <td colspan="6" class="text-center">Cargando solicitudes anteriores...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Formulario para completar -->
  <form id="form-new-request" class="row g-3">
    <input type="hidden" name="machineId" id="machine-id">
    <input type="hidden" name="customerId" id="customer-id">

    <div class="col-md-6">
      <label class="form-label">Canal *</label>
      <select name="reportedChannel" class="form-select" required>
        <option value="">Seleccione un canal</option>
        <option value="telefono">Tel√©fono</option>
        <option value="whatsapp">WhatsApp</option>
        <option value="email">Email</option>
        <option value="portal">Portal</option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Tipo de Servicio *</label>
      <select name="serviceType" class="form-select" required>
        <option value="">Seleccione un tipo</option>
        <option value="servicio_tecnico">Servicio T√©cnico</option>
        <option value="lectura_contador">Lectura de contador</option>
        <option value="remoto">Remoto</option>
        <option value="otro">otro</option>
      </select>
    </div>

    <div class="col-12">
      <label class="form-label">Causa Ra√≠z *</label>
      <select class="form-select" name="rootCauseId" id="root-cause-select" required>
        <option value="">Seleccione una causa ra√≠z</option>
        <!-- Las opciones se cargar√°n con JavaScript -->
      </select>
      <div id="root-cause-categories" class="mt-2"></div>
    </div>

    <div class="col-12">
      <label class="form-label">Descripci√≥n *</label>
      <textarea class="form-control" name="description" rows="3" required></textarea>
    </div>

    <div class="col-12">
      <label class="form-label">Solicitud repetida de (opcional)</label>
      <select name="repeatedOfRequestId" class="form-select" id="repeated-request">
        <option value="">No es una solicitud repetida</option>
        <!-- Las opciones se llenar√°n con JavaScript -->
      </select>
    </div>

    <div class="col-12">
      <button class="btn btn-success" type="submit">Crear Solicitud</button>
      <button class="btn btn-outline-secondary" type="button"
        onclick="appLoad('service_requests/list.html')">Cancelar</button>
    </div>
  </form>
</div>

<script>
  (async function () {
    // Cargar datos precargados desde sessionStorage
    const machineId = sessionStorage.getItem('selectedMachineId');
    const customerId = sessionStorage.getItem('selectedCustomerId');
    const machineSerial = sessionStorage.getItem('selectedMachineSerial');
    const machineNumber = sessionStorage.getItem('selectedMachineNumber');
    const customerName = sessionStorage.getItem('selectedCustomerName');
    const customerNit = sessionStorage.getItem('selectedCustomerNit');

    // Mostrar informaci√≥n precargada
    document.getElementById('preloaded-customer-name').textContent = customerName || 'N/A';
    document.getElementById('preloaded-customer-nit').textContent = customerNit ? `(NIT: ${customerNit})` : '';
    document.getElementById('preloaded-machine-serial').textContent = machineSerial || 'N/A';
    document.getElementById('preloaded-machine-number').textContent = machineNumber ? `(N√∫mero: ${machineNumber})` : '';

    // Establecer valores en campos ocultos
    if (machineId) document.getElementById('machine-id').value = machineId;
    if (customerId) document.getElementById('customer-id').value = customerId;

    // Cargar solicitudes anteriores para esta m√°quina
    if (machineId) {
      await loadPreviousRequests(machineId);
    }

    await loadRootCauses();

    // Limpiar el sessionStorage despu√©s de usar los valores
    sessionStorage.removeItem('selectedMachineId');
    sessionStorage.removeItem('selectedCustomerId');
    sessionStorage.removeItem('selectedMachineSerial');
    sessionStorage.removeItem('selectedMachineNumber');
    sessionStorage.removeItem('selectedCustomerName');
    sessionStorage.removeItem('selectedCustomerNit');
  })();

  async function loadPreviousRequests(machineId) {
    try {
      const requests = await serviceRequestService.list();
      const machineRequests = requests.filter(r => r.machineId == machineId);

      const tbody = document.getElementById('previous-requests');
      const select = document.getElementById('repeated-request');

      if (machineRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay solicitudes anteriores para esta m√°quina</td></tr>';
        return;
      }

      // Limpiar y llenar la tabla y el select
      tbody.innerHTML = '';
      select.innerHTML = '<option value="">No es una solicitud repetida</option>';

      machineRequests.forEach(request => {
        const date = request.reportedAt ? new Date(request.reportedAt).toLocaleDateString() : 'N/A';

        // Agregar a la tabla
        tbody.innerHTML += `
        <tr>
          <td>
            <input type="radio" name="selectedPreviousRequest" value="${request.id}" 
                   onchange="document.getElementById('repeated-request').value = this.value">
          </td>
          <td>${request.requestNumber || request.id}</td>
          <td>${date}</td>
          <td>${request.serviceType || 'N/A'}</td>
          <td>${request.rootCause || 'N/A'}</td>
          <td><span class="badge ${request.status === 'CERRADA' ? 'bg-success' : 'bg-warning'}">${request.status || 'N/A'}</span></td>
        </tr>
      `;

        // Agregar al select
        const option = document.createElement('option');
        option.value = request.id;
        option.textContent = `${request.requestNumber || request.id} - ${request.rootCause || 'Sin causa'} (${date})`;
        select.appendChild(option);
      });

    } catch (err) {
      console.error("Error cargando solicitudes anteriores:", err);
      document.getElementById('previous-requests').innerHTML =
        '<tr><td colspan="6" class="text-center text-danger">Error cargando solicitudes anteriores</td></tr>';
    }
  }


  async function loadRootCauses() {
    console.log("üîç Intentando cargar causas ra√≠z...");

    try {
      // Usa el servicio que definimos
      const groupedCauses = await rootCauseService.getGrouped();
      console.log("‚úÖ Causas ra√≠z recibidas:", groupedCauses);

      const select = document.getElementById('root-cause-select');
      const categoriesDiv = document.getElementById('root-cause-categories');

      // Limpiar select
      select.innerHTML = '<option value="">Seleccione una causa ra√≠z</option>';

      // Si no hay datos, mostrar mensaje
      if (!groupedCauses || Object.keys(groupedCauses).length === 0) {
        categoriesDiv.innerHTML = '<div class="alert alert-warning">No hay causas ra√≠z configuradas</div>';
        return;
      }

      // Crear botones de categor√≠as
      let categoriesHtml = '<div class="btn-group flex-wrap" role="group">';
      for (const [category, causes] of Object.entries(groupedCauses)) {
        categoriesHtml += `
        <button type="button" class="btn btn-outline-secondary btn-sm m-1" 
                onclick="filterRootCauses('${category}')">
          ${category}
        </button>
      `;
      }
      categoriesHtml += '</div>';
      categoriesDiv.innerHTML = categoriesHtml;

      // Almacenar todas las causas para filtrado
      window.allRootCauses = [];
      for (const [category, causes] of Object.entries(groupedCauses)) {
        causes.forEach(cause => {
          window.allRootCauses.push({
            id: cause.id,
            name: cause.name,
            category: category
          });

          // Agregar al select
          const option = document.createElement('option');
          option.value = cause.id;
          option.textContent = `${category} - ${cause.name}`;
          option.setAttribute('data-category', category);
          select.appendChild(option);
        });
      }

    } catch (err) {
      console.error("‚ùå Error cargando causas ra√≠z:", err);

      // Mostrar mensaje de error en la interfaz
      const categoriesDiv = document.getElementById('root-cause-categories');
      if (categoriesDiv) {
        categoriesDiv.innerHTML = `
        <div class="alert alert-danger">
          <strong>Error cargando causas ra√≠z:</strong><br>
          ${err.message}<br>
          <small>Verificando endpoints...</small>
        </div>
      `;
      }

      // Intentar cargar datos hardcodeados como respaldo
      loadHardcodedRootCauses();
    }
  }

  // Funci√≥n de respaldo con datos hardcodeados
  function loadHardcodedRootCauses() {
    console.log("‚ö†Ô∏è Cargando causas ra√≠z hardcodeadas...");

    const groupedCauses = {
      "CONTADORES / LECTURAS": [
        { id: 1, name: "CONTADOR", category: "CONTADORES / LECTURAS" },
        { id: 2, name: "TOMA DE CONTADORES", category: "CONTADORES / LECTURAS" },
        { id: 3, name: "LECTURA DE CONTADOR", category: "CONTADORES / LECTURAS" },
        { id: 4, name: "CONTADORES", category: "CONTADORES / LECTURAS" },
        { id: 5, name: "CONTADOR INICIAL", category: "CONTADORES / LECTURAS" }
      ],
      "TONER / TINTA": [
        { id: 6, name: "RECARGA TONER / DE TONER", category: "TONER / TINTA" },
        { id: 7, name: "REVISI√ìN / REVISION / REVICION DE TONER", category: "TONER / TINTA" },
        { id: 8, name: "TONER", category: "TONER / TINTA" },
        { id: 9, name: "CARGA DE TONER", category: "TONER / TINTA" },
        { id: 10, name: "CAMBIO DE TONER", category: "TONER / TINTA" }
      ]
    };

    const select = document.getElementById('root-cause-select');
    const categoriesDiv = document.getElementById('root-cause-categories');

    // Limpiar select
    select.innerHTML = '<option value="">Seleccione una causa ra√≠z</option>';

    // Crear botones de categor√≠as
    let categoriesHtml = '<div class="btn-group flex-wrap" role="group">';
    for (const [category, causes] of Object.entries(groupedCauses)) {
      categoriesHtml += `
      <button type="button" class="btn btn-outline-secondary btn-sm m-1" 
              onclick="filterRootCauses('${category}')">
        ${category}
      </button>
    `;

      causes.forEach(cause => {
        // Almacenar para filtrado
        if (!window.allRootCauses) window.allRootCauses = [];
        window.allRootCauses.push(cause);

        // Agregar al select
        const option = document.createElement('option');
        option.value = cause.id;
        option.textContent = `${category} - ${cause.name}`;
        option.setAttribute('data-category', category);
        select.appendChild(option);
      });
    }
    categoriesHtml += '</div>';

    if (categoriesDiv) {
      categoriesDiv.innerHTML = `
      ${categoriesHtml}
      <div class="alert alert-info mt-2">
        <small>‚ö†Ô∏è Usando datos de prueba. Verifica que el endpoint /root-causes/grouped est√© disponible.</small>
      </div>
    `;
    }

    console.log("‚úÖ Causas ra√≠z hardcodeadas cargadas");
  }









  document.getElementById("form-new-request").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);


    // Convertir rootCauseId a n√∫mero si existe
    if (data.rootCauseId) {
      data.rootCauseId = parseInt(data.rootCauseId);
    }


    // Agregar la fecha de asignaci√≥n autom√°ticamente
    //data.assignedAt = new Date().toISOString();

    console.log("üì§ Enviando datos:", data);

    try {
      const result = await serviceRequestService.create(data);
      console.log("‚úÖ Solicitud creada:", result);
      showAlert("Solicitud creada correctamente", "success");
      setTimeout(() => {
        appLoad('service_requests/list.html');
      }, 1500);
    } catch (err) {
      console.error("‚ùå Error al crear:", err);
      showAlert("Error al crear: " + err.message, "danger");
    }
  });







</script>