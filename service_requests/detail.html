<div class="card p-3">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h4 id="request-title">Detalle Solicitud</h4>
      <p class="text-muted" id="request-sub">Información completa de la solicitud</p>
    </div>
    <div>
      <button class="btn btn-outline-secondary me-2" onclick="editRequest()">
        <i class="fas fa-edit me-1"></i> Editar
      </button>
      <button class="btn btn-outline-dark" onclick="appLoad('service_requests/list.html')">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </button>
    </div>
  </div>

  <!-- Información de la Solicitud -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Información de la Solicitud</h6>
    </div>
    <div class="card-body">
      <dl class="row mb-0">
        <dt class="col-sm-3">Número</dt>
        <dd class="col-sm-9" id="req-number"></dd>

        <dt class="col-sm-3">Estado</dt>
        <dd class="col-sm-9" id="req-status"></dd>

        <dt class="col-sm-3">Tipo</dt>
        <dd class="col-sm-9" id="req-type"></dd>

        <dt class="col-sm-3">Canal</dt>
        <dd class="col-sm-9" id="req-channel"></dd>

        <dt class="col-sm-3">Fecha Reporte</dt>
        <dd class="col-sm-9" id="req-date"></dd>

        <dt class="col-sm-3">Causa Raíz</dt>
        <dd class="col-sm-9" id="req-root"></dd>

        <dt class="col-sm-3">Descripción</dt>
        <dd class="col-sm-9" id="req-desc"></dd>

        <dt class="col-sm-3">Resolución</dt>
        <dd class="col-sm-9" id="req-resolution"></dd>

        <dt class="col-sm-3">Repetida de</dt>
        <dd class="col-sm-9" id="req-repeated"></dd>
      </dl>
    </div>
  </div>

  <!-- Información del Cliente -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Cliente Asociado</h6>
    </div>
    <div class="card-body">
      <p><strong id="client-name"></strong> <span class="text-muted" id="client-nit"></span></p>
    </div>
  </div>

  <!-- Información de la Máquina -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Máquina Asociada</h6>
    </div>
    <div class="card-body">
      <p><strong id="machine-serial"></strong> <span class="text-muted" id="machine-number"></span></p>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const id = sessionStorage.getItem("selectedRequestId");
  if (!id) {
    showAlert("No se seleccionó solicitud", "warning");
    appLoad("service_requests/list.html");
    return;
  }

  try {
    const req = await serviceRequestService.get(id);

    if (!req) {
      showAlert("Solicitud no encontrada", "danger");
      appLoad("service_requests/list.html");
      return;
    }

    // Título y subtítulo
    document.getElementById("request-title").textContent = `Solicitud #${req.requestNumber}`;
    document.getElementById("request-sub").textContent = req.description || "Detalle de la solicitud";

    // Datos principales
    document.getElementById("req-number").textContent = req.requestNumber || req.id;
    document.getElementById("req-status").innerHTML = `<span class="badge ${req.status === "ABIERTA" ? "bg-warning" : "bg-success"}">${req.status}</span>`;
    document.getElementById("req-type").textContent = req.serviceType || "N/A";
    document.getElementById("req-channel").textContent = req.reportedChannel || "N/A";
    document.getElementById("req-date").textContent = req.reportedAt ? new Date(req.reportedAt).toLocaleString() : "N/A";
    document.getElementById("req-root").textContent = req.rootCause || "N/A";
    document.getElementById("req-desc").textContent = req.description || "N/A";
    document.getElementById("req-resolution").textContent = req.resolution || "Pendiente";
    document.getElementById("req-repeated").textContent = req.repeatedOfRequestId ? `#${req.repeatedOfRequestId}` : "No";

    // Cliente asociado
    document.getElementById("client-name").textContent = req.customerName || "Cliente N/A";
    document.getElementById("client-nit").textContent = req.customerNit ? `(NIT: ${req.customerNit})` : "";

    // Máquina asociada
    document.getElementById("machine-serial").textContent = req.machineSerial || "Máquina N/A";
    document.getElementById("machine-number").textContent = req.machineNumber ? `(Número: ${req.machineNumber})` : "";

  } catch (err) {
    console.error("Error cargando detalle:", err);
    showAlert("Error cargando detalle", "danger");
  }
});

function editRequest() {
  const id = sessionStorage.getItem("selectedRequestId");
  sessionStorage.setItem("selectedRequestId", id);
  appLoad("service_requests/edit.html");
}
</script>