<div class="card p-3">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h4 id="sr-title">Solicitud de Servicio</h4>
      <p class="text-muted" id="sr-sub">Detalle de solicitud</p>
    </div>
    <div>
      <button class="btn btn-success me-2" id="btn-create-visit">
        <i class="fas fa-plus me-1"></i> Crear Visita Técnica
      </button>
      <button class="btn btn-outline-secondary" onclick="appLoad('service_requests/list.html')">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </button>
    </div>
  </div>

  <!-- Información básica -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Información de la Solicitud</h6>
    </div>
    <div class="card-body">
      <table class="table table-sm">
        <tbody id="sr-info"></tbody>
      </table>
    </div>
  </div>

  <!-- Cliente -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Cliente Asociado</h6>
    </div>
    <div class="card-body">
      <table class="table table-sm">
        <tbody id="sr-customer"></tbody>
      </table>
    </div>
  </div>

  <!-- Máquina -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Máquina Asociada</h6>
    </div>
    <div class="card-body">
      <table class="table table-sm">
        <tbody id="sr-machine"></tbody>
      </table>
    </div>
  </div>

  <!-- Visitas técnicas -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Visitas Técnicas</h6>
    </div>
    <div class="card-body">
      <table class="table table-sm" id="sr-visits">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Técnico</th>
            <th>Notas</th>
            <th>Resuelto</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
 (async function () {
    // Obtener el ID de la solicitud de la URL o sessionStorage
    const params = new URLSearchParams(location.search);
    const id = params.get("id") || sessionStorage.getItem("selectedRequestId");
    
    if (!id) {
      showAlert("ID de solicitud no especificado", "danger");
      return appLoad("service_requests/list.html");
    }

    // Guardar el ID para uso posterior
    sessionStorage.setItem("selectedRequestId", id);
    window.__SRID = id;

    try {
      const r = await serviceRequestService.get(id);
      if (!r) {
        showAlert("Solicitud no encontrada", "warning");
        return appLoad("service_requests/list.html");
      }

      document.getElementById("sr-title").innerText = "Solicitud #" + (r.requestNumber || r.id);
      document.getElementById("sr-sub").innerText = r.serviceType || "Solicitud de servicio";

      // Información básica
      document.getElementById("sr-info").innerHTML = `
         <tr><th>ID</th><td>${r.id}</td></tr>
    <tr><th>Número</th><td>${r.requestNumber || "N/A"}</td></tr>
    <tr><th>Estado</th><td><span class="badge ${r.status === 'CERRADA' ? 'bg-success' : 'bg-warning'}">${r.status || 'N/A'}</span></td></tr>
    <tr><th>Tipo</th><td>${r.serviceType || "N/A"}</td></tr>
    <tr><th>Descripción</th><td>${r.description || "N/A"}</td></tr>
    <tr><th>Causa raíz</th><td>
        ${r.rootCauseName ? 
            `<strong>${r.rootCauseName}</strong>` : 
            (r.rootCause || "N/A")
        }
        ${r.rootCauseCategory ? `<br><small class="text-muted">${r.rootCauseCategory}</small>` : ''}
    </td></tr>
`;

      // Cliente
      if (r.customerId) {
        try {
          const c = await customerService.get(r.customerId);
          document.getElementById("sr-customer").innerHTML = c ? `
            <tr><th>Nombre</th><td>${c.name || 'N/A'}</td></tr>
            <tr><th>Contacto</th><td>${c.contactName || 'N/A'}</td></tr>
            <tr><th>Teléfono</th><td>${c.phone || 'N/A'}</td></tr>
            <tr><th>Email</th><td>${c.email || 'N/A'}</td></tr>
          ` : `<tr><td colspan="2">Cliente no disponible</td></tr>`;
        } catch (err) {
          document.getElementById("sr-customer").innerHTML = `<tr><td colspan="2">Error cargando cliente</td></tr>`;
        }
      } else {
        document.getElementById("sr-customer").innerHTML = `<tr><td colspan="2">No hay cliente asociado</td></tr>`;
      }

      // Máquina
      if (r.machineId) {
        try {
          const m = await machineService.get(r.machineId);
          document.getElementById("sr-machine").innerHTML = m ? `
            <tr><th>Serial</th><td>${m.companySerial || "N/A"}</td></tr>
            <tr><th>Modelo</th><td>${m.model || "N/A"}</td></tr>
            <tr><th>Marca</th><td>${m.brand || "N/A"}</td></tr>
            <tr><th>Estado</th><td>${m.status || "N/A"}</td></tr>
          ` : `<tr><td colspan="2">Máquina no disponible</td></tr>`;
        } catch (err) {
          document.getElementById("sr-machine").innerHTML = `<tr><td colspan="2">Error cargando máquina</td></tr>`;
        }
      } else {
        document.getElementById("sr-machine").innerHTML = `<tr><td colspan="2">No hay máquina asociada</td></tr>`;
      }

      // Visitas técnicas
      await loadVisits(id);

      // Configurar botón de crear visita
      document.getElementById("btn-create-visit").onclick = () => {
        console.log("Crear visita para solicitud:", id);
        sessionStorage.setItem("selectedRequestId", id);
        appLoad("service_visits/new.html");
      };

    } catch (err) {
      console.error("Error cargando solicitud:", err);
      showAlert("Error cargando detalles de la solicitud: " + err.message, "danger");
    }
  })();

  async function loadVisits(requestId) {
  try {
    const visits = await serviceVisitService.byRequest(requestId);
    const tbody = document.querySelector("#sr-visits tbody");
     

    console.log("Visitas recibidas:", visits);

    if (visits && visits.length > 0) {
      // Obtener todos los nombres de técnicos en paralelo
      const technicianPromises = visits.map(v => 
        v.technicianId ? technicianService.get(v.technicianId) : null
      );
      const technicians = await Promise.all(technicianPromises);

      tbody.innerHTML = visits.map((v, i) => {
        const tech = technicians[i];
        const techName = tech ? tech.fullName || "Técnico desconocido" : "-";
        return `
          <tr>
            <td>${v.visitDatetime ? new Date(v.visitDatetime).toLocaleString() : "-"}</td>
            <td>${techName}</td>
            <td>${v.visitNotes || "-"}</td>
            <td>${v.solved ? "✅ Sí" : "❌ No"}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" 
                      onclick="editVisit(${v.id})">
                <i class="fas fa-edit"></i> Editar
              </button>
            </td>
          </tr>
        `;
      }).join("");
    } else {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No hay visitas registradas</td></tr>`;
    }
  } catch (err) {
    console.error("Error cargando visitas:", err);
    document.querySelector("#sr-visits tbody").innerHTML = 
      `<tr><td colspan="5" class="text-center text-warning">Error cargando visitas</td></tr>`;
  }
}
 function editVisit(visitId) {
  console.log("Editando visita ID:", visitId);
    sessionStorage.setItem("selectedVisitId", visitId);
    appLoad("service_visits/edit.html");
}
</script>

<style>
    /* Para la causa raíz en el detalle */
    .root-cause-display {
        font-weight: 500;
        color: #0d6efd;
    }
    
    .root-cause-category {
        font-size: 0.85em;
        color: #6c757d;
    }
    
    /* Para el formulario de edición */
    #current-root-cause .alert {
        background-color: #e7f3ff;
        border-color: #b6d4fe;
        color: #084298;
    }
</style>