<div class="card p-3">
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h4 id="sr-title">Solicitud de Servicio</h4>
            <p class="text-muted" id="sr-sub">Detalle de solicitud</p>
        </div>
        <div>
            <button class="btn btn-outline-secondary me-2" onclick="editRequest()">
                <i class="fas fa-edit me-1"></i> Editar
            </button>
            <button class="btn btn-outline-secondary" onclick="appLoad('service_requests/list.html')">
                <i class="fas fa-arrow-left me-1"></i> Volver
            </button>
        </div>
    </div>

    <!-- Información básica -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0">Información de la Solicitud</h6>
        </div>
        <div class="card-body">
            <table class="table table-sm">
                <tbody id="sr-info"></tbody>
            </table>
        </div>
    </div>

    <!-- Cliente asociado -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0">Cliente Asociado</h6>
        </div>
        <div class="card-body">
            <table class="table table-sm">
                <tbody id="sr-customer"></tbody>
            </table>
        </div>
    </div>

    <!-- Máquina asociada -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0">Máquina Asociada</h6>
        </div>
        <div class="card-body">
            <table class="table table-sm">
                <tbody id="sr-machine"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    (async function() {
        // Obtener ID desde sessionStorage
        const id = sessionStorage.getItem("selectedRequestId");
        
        if (!id) {
            showAlert("ID de solicitud no especificado", "danger");
            appLoad("service_requests/list.html");
            return;
        }

        try {
            const r = await serviceRequestService.get(id);
            if (!r) {
                showAlert("Solicitud no encontrada", "warning");
                appLoad("service_requests/list.html");
                return;
            }

            // Título
            document.getElementById("sr-title").innerText = "Solicitud #" + (r.requestNumber || r.id);

            // Info de la solicitud
            document.getElementById("sr-info").innerHTML = `
                <tr><th>ID</th><td>${r.id}</td></tr>
                <tr><th>Número</th><td>${r.requestNumber || "N/A"}</td></tr>
                <tr><th>Estado</th><td><span class="badge ${r.status === "ABIERTA" ? "bg-warning" : "bg-success"}">${r.status}</span></td></tr>
                <tr><th>Tipo</th><td>${r.serviceType || "N/A"}</td></tr>
                <tr><th>Canal</th><td>${r.reportedChannel || "N/A"}</td></tr>
                <tr><th>Reportada en</th><td>${r.reportedAt ? new Date(r.reportedAt).toLocaleString() : "N/A"}</td></tr>
                <tr><th>Causa Raíz</th><td>${r.rootCause || "N/A"}</td></tr>
                <tr><th>Descripción</th><td>${r.description || "N/A"}</td></tr>
                <tr><th>Resolución</th><td>${r.resolution || "-"}</td></tr>
                <tr><th>Repetida de</th><td>${r.repeatedOfRequestId || "No"}</td></tr>
            `;

            // Cliente asociado
            const c = r.customerId ? await customerService.get(r.customerId) : null;
            document.getElementById("sr-customer").innerHTML = c ? `
                <tr><th>ID</th><td>${c.id}</td></tr>
                <tr><th>NIT</th><td>${c.nit || ""}</td></tr>
                <tr><th>Nombre</th><td>${c.name || ""}</td></tr>
                <tr><th>Contacto</th><td>${c.contactName || ""}</td></tr>
                <tr><th>Teléfono</th><td>${c.phone || ""}</td></tr>
                <tr><th>Email</th><td>${c.email || ""}</td></tr>
                <tr><th>Dirección</th><td>${c.address || ""}</td></tr>
            ` : `<tr><td colspan="2" class="text-muted">Cliente no disponible</td></tr>`;

            // Máquina asociada
            const m = r.machineId ? await machineService.get(r.machineId) : null;
            document.getElementById("sr-machine").innerHTML = m ? `
                <tr><th>ID</th><td>${m.id}</td></tr>
                <tr><th>Serial</th><td>${m.companySerial || "N/A"}</td></tr>
                <tr><th>Número</th><td>${m.companyNumber || "N/A"}</td></tr>
                <tr><th>Modelo</th><td>${m.model || "N/A"}</td></tr>
                <tr><th>Marca</th><td>${m.brand || "N/A"}</td></tr>
                <tr><th>Estado</th><td>${m.status || "N/A"}</td></tr>
            ` : `<tr><td colspan="2" class="text-muted">Máquina no disponible</td></tr>`;

        } catch (err) {
            console.error("Error cargando solicitud:", err);
            showAlert("Error cargando solicitud: " + err.message, "danger");
        }
    })();

    function editRequest() {
        const id = sessionStorage.getItem("selectedRequestId");
        
        if (!id) {
            showAlert("ID de solicitud no especificado", "danger");
            return;
        }
        appLoad("service_requests/edit.html");
    }
</script>