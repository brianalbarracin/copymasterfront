===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\home.html =====
<div class="container">
  <div class="row g-3">
    <div class="col-md-8">
      <div class="card p-3">
        <h4>Resumen del d√≠a</h4>
        <div class="row">
          <div class="col-sm-4"><div class="p-3 bg-light rounded">M√°quinas: <strong id="home-machines-count">...</strong></div></div>
          <div class="col-sm-4"><div class="p-3 bg-light rounded">Solicitudes hoy: <strong id="home-requests-count">...</strong></div></div>
          <div class="col-sm-4"><div class="p-3 bg-light rounded">Visitas hoy: <strong id="home-visits-count">...</strong></div></div>
        </div>
        <hr>
        <h5 class="mt-3">√öltimas solicitudes</h5>
        <div id="home-latest-requests"></div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <h5>Accesos r√°pidos</h5>
        <ul class="list-unstyled">
          <li><a href="#" data-page="machines/list.html" class="link-success">Ver m√°quinas</a></li>
          <li><a href="#" data-page="machines/create.html" class="link-success">Crear m√°quina</a></li>
          <li><a href="#" data-page="machines/service_requests.html" class="link-success">Crear solicitud</a></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async ()=>{
  try{
    const machines = await machineService.list().then(r=>r.data || r);
    const reqs = await serviceRequestService.list().then(r=>r.data || r);
    document.getElementById("home-machines-count").innerText = (machines && machines.length) || 0;
    document.getElementById("home-requests-count").innerText = (reqs && reqs.length) || 0;
    document.getElementById("home-latest-requests").innerHTML = (reqs||[]).slice(0,5).map(r=>`<div class="small mb-2"><strong>${r.requestNumber||r.id}</strong> - ${r.rootCause||''} <span class="text-muted">(${new Date(r.reportedAt).toLocaleString()})</span></div>`).join('');
  }catch(e){ console.error(e); }
});
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\index.html =====
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CopyMaster ‚Äî Panel</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        .container {
            max-width: 1100px;
        }

        h1,
        h3,
        h4 {
            color: #0f9d58;
        }

        .card {
            border-radius: 10px;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.15rem;
        }

        .link-success {
            color: #0f9d58 !important;
        }

        .table-actions button {
            margin-right: 6px;
        }

        /* Nuevos estilos para mejoras */
        .stat-card {
            text-align: center;
            padding: 20px;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #0f9d58;
        }

        .stat-card .number {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .stat-card .label {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .technician-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #f1f1f1;
        }

        .performance-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .performance-fill {
            height: 100%;
            background-color: #0f9d58;
            border-radius: 5px;
        }

        .dashboard-section {
            margin-bottom: 30px;
        }

        .section-title {
            border-left: 4px solid #0f9d58;
            padding-left: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }
    </style>
    <script>
        const API_BASE = "https://copymasterback.onrender.com";
    </script>
    <script src="assets/js/app.js" defer></script>
</head>

<body class="d-flex flex-column min-vh-100">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <nav class="navbar navbar-expand-lg navbar-light container">
            <a class="navbar-brand text-success" href="#">
                <i class="fas fa-copy me-1"></i>CopyMaster
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navMenu">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="#" data-page="home.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-page="machines/list.html">M√°quinas</a></li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="customers/list.html">Clientes</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="#"
                            data-page="service_requests/list.html">Solicitudes</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-page="technicians/list.html">T√©cnicos</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="#" data-page="costs/analysis.html">Costos</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-page="reports/generate.html">Reportes</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button class="btn btn-link text-muted text-decoration-none dropdown-toggle" type="button"
                            id="userMenu" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> <span id="current-user"></span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" data-page="user/profile.html"><i
                                        class="fas fa-user me-2"></i>Mi perfil</a></li>
                            <li><a class="dropdown-item" href="#" data-page="user/sessions.html"><i
                                        class="fas fa-clock me-2"></i>Sesiones activas</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" id="logout"><i
                                        class="fas fa-sign-out-alt me-2"></i>Cerrar sesi√≥n</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main content area -->
    <main class="flex-fill container py-4" id="content-main">
        <!-- Cargado din√°micamente -->
    </main>

    <!-- Footer -->
    <footer class="bg-light text-muted py-3 mt-auto">
        <div class="container d-flex justify-content-between">
            <div>CopyMaster &copy; 2025</div>
            <div class="small">Contacto: soporte@copymaster.local</div>
        </div>
    </footer>

    <!-- Bootstrap JS bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script con todas las mejoras -->
    <script>
        // Servicios corregidos y mejorados


        const customerService = {
            list: () => fetch(API_BASE + "/customers")
                .then(r => r.json())
                .then(res => res.data || []),

            get: (id) => fetch(API_BASE + "/customers/" + id)
                .then(r => r.json())
                .then(res => res.data),

            create: (data) => fetch(API_BASE + "/customers", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => res.data),

            update: (id, data) => fetch(API_BASE + "/customers/" + id, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => res.data),

            delete: (id) => fetch(API_BASE + "/customers/" + id, {
                method: "DELETE"
            }).then(r => r.json()).then(res => res.data)
        };

        const locationService = {
            list: () => fetch(API_BASE + "/locations")
                .then(r => r.json())
                .then(res => res || [])
        };
        const technicianService = {
            list: () => fetch(API_BASE + "/technicians")
                .then(r => r.json()).then(res => res.data || []),

            get: (id) => fetch(API_BASE + "/technicians/" + id)
                .then(r => r.json()).then(res => res.data),

            create: (data) => fetch(API_BASE + "/technicians", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => res.data),

            update: (id, data) => fetch(API_BASE + "/technicians/" + id, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => res.data),

            performance: (id, startDate, endDate) => {
                const params = new URLSearchParams({
                    startDate: startDate.toISOString(),
                    endDate: endDate.toISOString()
                });
                return fetch(`${API_BASE}/technicians/${id}/performance?${params}`)
                    .then(r => r.json()).then(res => res.data);
            },

            comparison: (startDate, endDate) => {
                const params = new URLSearchParams({
                    startDate: startDate.toISOString(),
                    endDate: endDate.toISOString()
                });
                return fetch(`${API_BASE}/technicians/comparison?${params}`)
                    .then(r => r.json()).then(res => res.data);
            }
        };

        const machineService = {
            list: () => fetch(API_BASE + "/machines")
                .then(r => r.json()).then(res => res.data || []),

            get: (id) => fetch(API_BASE + "/machines/" + id)
                .then(r => r.json())
                .then(res => {
                    // Si la respuesta tiene propiedad 'data', usarla
                    if (res && res.data !== undefined) {
                        return res.data;
                    }
                    // Si no, asumir que la respuesta es directamente los datos
                    return res;
                }),

            create: (data) => fetch(API_BASE + "/machines", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(async r => {
                if (!r.ok) {
                    const text = await r.text();
                    throw new Error("Error en backend: " + text);
                }
                return r.json();
            }).then(res => res.data),
            update: (id, data) => fetch(API_BASE + "/machines/" + id, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => res.data),

            delete: (id) => fetch(API_BASE + "/machines/" + id, {
                method: "DELETE"
            }).then(r => r.json()).then(res => res.data),

            movements: (id) => fetch(API_BASE + "/machine-movements?machineId=" + id)
                .then(r => r.json()).then(res => res.data || []),

            meterReadings: (id) => fetch(API_BASE + "/meter-readings/machine/" + id)
                .then(r => r.json()).then(res => res.data || []),

            tonerReadings: (id) => fetch(API_BASE + "/reading-toner/machine/" + id)
                .then(r => {
                    console.log("Response status:", r.status);
                    console.log("Response headers:", r.headers);
                    return r.json();
                })
                .then(res => {
                    console.log("Response JSON:", res);
                    return res.data || [];
                })
                .catch(err => {
                    console.error("Error fetching toner readings:", err);
                    return [];
                }),

            search: (query) => fetch(API_BASE + "/machines/search?q=" + encodeURIComponent(query))
                .then(r => r.json()).then(res => res.data || [])
        };

        const serviceRequestService = {
            list: () => fetch(API_BASE + "/service-requests")
                .then(r => r.json()).then(res => res.data || []),

            get: (id) => fetch(API_BASE + "/service-requests/" + id)
                .then(r => r.json()).then(res => res.data),

            create: (data) => fetch(API_BASE + "/service-requests", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => res.data),

            update: (id, data) => fetch(API_BASE + "/service-requests/" + id, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => res.data),

            byCustomer: (customerId) => fetch(API_BASE + "/service-requests/customer/" + customerId)
                .then(r => r.json()).then(res => res.data || []),

            byMachine: (machineId) => fetch(API_BASE + "/service-requests/machine/" + machineId)
                .then(r => r.json()).then(res => res.data || [])
        };

        const rootCauseService = {
            // Obtener todas las causas agrupadas por categor√≠a
            getGrouped: () => fetch(API_BASE + "/root-causes/grouped")
                .then(r => r.json())
                .then(res => res.data || {}),

            // Obtener todas las causas
            getAll: () => fetch(API_BASE + "/root-causes")
                .then(r => r.json())
                .then(res => res.data || []),

            // Obtener por categor√≠a
            getByCategory: (category) => fetch(API_BASE + "/root-causes/by-category?category=" + encodeURIComponent(category))
                .then(r => r.json())
                .then(res => res.data || []),

            // Obtener todas las categor√≠as
            getCategories: () => fetch(API_BASE + "/root-causes/categories")
                .then(r => r.json())
                .then(res => res.data || []),

            // Obtener una causa por ID
            getById: (id) => fetch(API_BASE + "/root-causes/" + id)
                .then(r => r.json())
                .then(res => res.data)
        };


        const serviceVisitService = {
            list: () => fetch(API_BASE + "/visits/")
                .then(r => r.json()).then(res => res.data || []),

            get: (id) => fetch(API_BASE + "/visits/" + id)
                .then(r => r.json()).then(res => res.data),

            create: (data) => fetch(API_BASE + "/visits", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => res.data),

            update: (id, data) => fetch(API_BASE + "/visits/" + id, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => res.data),

            byRequest: (requestId) => fetch(API_BASE + "/visits/request/" + requestId)
                .then(r => r.json()).then(res => {
                    // Si tu backend devuelve array directamente
                    if (Array.isArray(res)) return res;
                    // Si devuelve ServerResponseDto con data
                    return res.data || [];
                }),

            byTechnician: (technicianId) => fetch(API_BASE + "/service-visits/technician/" + technicianId)
                .then(r => r.json()).then(res => res.data || [])
        };

        const costService = {
            analysis: (startDate, endDate) => {
                const params = new URLSearchParams({
                    startDate: startDate.toISOString(),
                    endDate: endDate.toISOString()
                });
                return fetch(`${API_BASE}/costs/analysis?${params}`)
                    .then(r => r.json()).then(res => res.data);
            },
            comparison: (months) => fetch(`${API_BASE}/costs/comparison?months=${months}`)
                .then(r => r.json()).then(res => res.data || [])
        };

        const reportService = {
            generate: (type, params) => fetch(`${API_BASE}/reports/generate`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ type, params })
            }).then(r => r.json()).then(res => res.data),

            list: () => fetch(API_BASE + "/reports")
                .then(r => r.json()).then(res => res.data || [])
        };

        const userService = {
            getProfile: () => fetch(API_BASE + "/user/profile")
                .then(r => r.json()).then(res => res.data),

            updateProfile: (data) => fetch(API_BASE + "/user/profile", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => res.data),

            getSessions: () => fetch(API_BASE + "/user/sessions")
                .then(r => r.json()).then(res => res.data || []),

            terminateSession: (sessionId) => fetch(API_BASE + `/user/sessions/${sessionId}`, {
                method: "DELETE"
            }).then(r => r.json()).then(res => res.data)
        };

        // Funciones de utilidad
        function showAlert(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `alert alert-${type} alert-dismissible fade show`;
            div.innerHTML = `
                ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById('content-main').prepend(div);
            setTimeout(() => {
                if (div.parentNode) {
                    div.remove();
                }
            }, 5000);
        }

        function formatDate(dt) {
            return dt ? new Date(dt).toLocaleString() : '';
        }

        function formatDateOnly(dt) {
            return dt ? new Date(dt).toLocaleDateString() : '';
        }

        // C√≥digo principal de la aplicaci√≥n
        document.addEventListener("DOMContentLoaded", () => {
            // Verificar autenticaci√≥n
            const user = localStorage.getItem("user");
            if (!user) {
                window.location = "login.html";
                return;
            }

            const userObj = JSON.parse(user);
            document.getElementById("current-user").innerText = userObj.username || userObj.fullName || "";

            // Configurar sistema de navegaci√≥n
            window.appLoad = async function (path) {
                try {
                    const res = await fetch(path);
                    if (!res.ok) throw new Error("No se pudo cargar " + path);

                    const html = await res.text();
                    document.getElementById("content-main").innerHTML = html;

                    // Ejecutar scripts incrustados
                    const tmp = document.createElement('div');
                    tmp.innerHTML = html;
                    tmp.querySelectorAll('script').forEach(s => {
                        const script = document.createElement('script');
                        if (s.src) {
                            script.src = s.src;
                        } else {
                            script.textContent = s.textContent;
                        }
                        document.body.appendChild(script);
                    });
                } catch (e) {
                    console.error(e);
                    document.getElementById("content-main").innerHTML = `
                        <div class="alert alert-danger">
                            <h5>Error al cargar la p√°gina</h5>
                            <p>${e.message}</p>
                            <a href="#" onclick="appLoad('home.html')" class="btn btn-sm btn-success">Volver al inicio</a>
                        </div>
                    `;
                }
            };

            // Configurar eventos de navegaci√≥n
            document.querySelectorAll('a[data-page]').forEach(a => {
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    appLoad(a.dataset.page);
                });
            });

            // Configurar logout
            document.getElementById("logout").addEventListener("click", () => {
                localStorage.removeItem("user");
                window.location = "login.html";
            });

            // Cargar p√°gina inicial
            appLoad('home.html');
        });
    </script>
</body>

</html>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\login.html =====
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CopyMaster ‚Äî Iniciar Sesi√≥n</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/index.css" rel="stylesheet">
    <script>const API_BASE = "https://copymasterback.onrender.com";</script>
    <script src="assets/js/login.js" defer></script>
  </head>
  <body class="bg-light">
    <div class="vh-100 d-flex align-items-center">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-sm-10 col-md-6 col-lg-5">
            <div class="card shadow-sm">
              <div class="card-body p-4">
                <h3 class="card-title mb-3 text-center text-success">CopyMaster</h3>
                <p class="text-muted text-center">Ingresa tus credenciales para acceder al panel</p>
                <form id="login-form" novalidate>
                  <div class="mb-3">
                    <label class="form-label">Usuario</label>
                    <input type="text" name="username" class="form-control" required>
                    <div class="invalid-feedback">Ingresa tu usuario</div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" name="password" class="form-control" required>
                    <div class="invalid-feedback">Ingresa tu contrase√±a</div>
                  </div>
                  <div id="login-error" class="text-danger mb-2" role="alert"></div>
                  <div class="d-grid">
                    <button class="btn btn-success" type="submit">Ingresar</button>
                  </div>
                </form>
              </div>
              <div class="card-footer text-center small text-muted">
                &copy; CopyMaster 2025 ‚Äî Soporte t√©cnico
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Bootstrap JS bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\assets\css\index.css =====
/* base styles */
body { font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
.container { max-width: 1100px; }
h1,h3,h4 { color: #0f9d58; }
.bg-orange {
        background-color: #ff8c00 !important;
        color: white !important;
    }

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\assets\css\professional.css =====
/* Professional tweaks */
.card { border-radius: 10px; }
.navbar-brand { font-weight:700; font-size:1.15rem; }
.link-success { color:#0f9d58 !important; }
.table-actions button { margin-right:6px; }
.bg-orange {
        background-color: #ff8c00 !important;
        color: white !important;
    }

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\assets\js\app.js =====
document.addEventListener("DOMContentLoaded", ()=>{
  // Ensure user logged in
  const user = localStorage.getItem("user");
  if(!user){ window.location = "login.html"; return; }
  const userObj = JSON.parse(user);
  document.getElementById("current-user").innerText = userObj.username || userObj.fullName || "";

  // helper to load snippet into content-main
  window.appLoad = async function(path){
    try{
      const res = await fetch(path);
      if(!res.ok) throw new Error("No se pudo cargar " + path);
      const html = await res.text();
      document.getElementById("content-main").innerHTML = html;
      // execute scripts inside snippet
      const tmp = document.createElement('div'); tmp.innerHTML = html;
      tmp.querySelectorAll('script').forEach(s=>{
        const script = document.createElement('script');
        if(s.src) script.src = s.src;
        else script.textContent = s.textContent;
        document.body.appendChild(script);
      });
    }catch(e){ console.error(e); document.getElementById("content-main").innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`; }
  }

  // wire menu links
  document.querySelectorAll('a[data-page]').forEach(a=> a.addEventListener('click', (e)=> { e.preventDefault(); appLoad(a.dataset.page); }));
  document.getElementById("logout").addEventListener("click", ()=>{ localStorage.removeItem("user"); window.location="login.html"; });

  // initial load
  appLoad('home.html');
});

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\assets\js\login.js =====
document.addEventListener("DOMContentLoaded", ()=>{
  const form = document.getElementById("login-form");
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const username = form.username.value.trim();
    const password = form.password.value;
    if(!username || !password){ document.getElementById("login-error").innerText = "Usuario y contrase√±a requeridos"; return; }
    try{
      const res = await fetch(API_BASE + "/auth/login", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ username, password }) });
      if(!res.ok) {
        const errTxt = await res.text().catch(()=>"Credenciales inv√°lidas");
        throw new Error(errTxt || "Credenciales inv√°lidas");
      }
      const data = await res.json();
      // store user info only (no JWT handling requested). Backend response may include user object
      localStorage.setItem("user", JSON.stringify(data));
      window.location = "index.html";
    }catch(err){
      document.getElementById("login-error").innerText = err.message || "Error en autenticar";
    }
  });
});

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\assets\js\machine-detail.js =====
// Variable global para almacenar datos de la m√°quina
window.machineData = null;

async function loadDetail(){
  console.log("üîç INICIANDO loadDetail()");
  const params = new URLSearchParams(location.search);
  const id = params.get("id");
  
  console.log("üìã ID obtenido de URL:", id);
  
  if(!id) {
    showAlert("ID de m√°quina no especificado", "danger");
    return;
  }
  
  // Guardar ID en variable global para reutilizar
  window.__MID = id;

  try {
    // Mostrar loading
    document.getElementById("m-title").innerText = "Cargando...";
    document.getElementById("m-sub").innerText = "Por favor espere";
    document.getElementById("btn-move").disabled = true;

    // Obtener datos de la m√°quina usando el servicio corregido
    console.log("üñ•Ô∏è Obteniendo m√°quina con ID:", id);
    window.machineData = await machineService.get(id);
    console.log("‚úÖ Datos de la m√°quina obtenidos:", window.machineData);

    if (!window.machineData) {
      throw new Error("No se encontraron datos de la m√°quina");
    }

    // Cargar ubicaciones si no est√°n en cache
    if (!window.locationsCache || window.locationsCache.length === 0) {
      try {
        console.log("üìç Cargando ubicaciones...");
        window.locationsCache = await locationService.list();
        console.log("‚úÖ Ubicaciones cargadas:", window.locationsCache);
      } catch (err) {
        console.warn("‚ö†Ô∏è Error cargando ubicaciones:", err);
        window.locationsCache = [];
      }
    }

    // Actualizar informaci√≥n principal
    document.getElementById("m-title").innerText = 
      window.machineData.companySerial || `M√°quina ${window.machineData.id}`;
    document.getElementById("m-sub").innerText = 
      `${window.machineData.brand || 'Sin marca'} ${window.machineData.model || 'Sin modelo'}`;

    // Informaci√≥n b√°sica
    document.getElementById("m-info").innerHTML = `
      <tr><th>ID</th><td>${window.machineData.id || 'N/A'}</td></tr>
      <tr><th>Serial</th><td>${window.machineData.companySerial || 'N/A'}</td></tr>
      <tr><th>N√∫mero</th><td>${window.machineData.companyNumber || 'N/A'}</td></tr>
      <tr><th>Modelo</th><td>${window.machineData.model || 'N/A'}</td></tr>
      <tr><th>Marca</th><td>${window.machineData.brand || 'N/A'}</td></tr>
      <tr><th>A√±o</th><td>${window.machineData.year || 'N/A'}</td></tr>
      <tr><th>Estado</th><td>${window.machineData.status || 'N/A'}</td></tr>
      <tr><th>Notas</th><td>${window.machineData.notes || 'Sin notas'}</td></tr>
    `;

    // Informaci√≥n de ubicaci√≥n
    let locationName = 'No asignada';
    if (window.locationsCache && window.locationsCache.length > 0) {
        const location = window.locationsCache.find(l => l.id === window.machineData.currentLocationId);
        locationName = location ? location.name : 'Ubicaci√≥n no encontrada';
    }
    
    document.getElementById("m-location").innerHTML = `
      <tr><th>Ubicaci√≥n Actual</th><td>${locationName}</td></tr>
      <tr><th>ID Ubicaci√≥n</th><td>${window.machineData.currentLocationId || 'N/A'}</td></tr>
      <tr><th>Cliente Actual</th><td>${window.machineData.currentCustomerId || 'N/A'}</td></tr>
    `;

    // Habilitar bot√≥n de movimiento
    document.getElementById("btn-move").disabled = false;

    // Cargar movimientos
    await loadMovements(id);
    
    // Cargar lecturas
    await loadMeterReadings(id);

    console.log("üéâ Carga completada exitosamente");

  } catch(err) {
    console.error("‚ùå Error cargando detalle:", err);
    showAlert("Error cargando detalles de la m√°quina: " + err.message, "danger");
    document.getElementById("m-title").innerText = "Error";
    document.getElementById("m-sub").innerText = "No se pudo cargar la informaci√≥n";
    document.getElementById("m-info").innerHTML = '<tr><td colspan="2" class="text-center text-danger">Error cargando informaci√≥n</td></tr>';
    document.getElementById("m-location").innerHTML = '<tr><td colspan="2" class="text-center text-danger">Error cargando ubicaci√≥n</td></tr>';
  }
}

async function loadMovements(machineId) {
  try {
    console.log("üîÑ Cargando movimientos para m√°quina:", machineId);
    const moves = await machineService.movements(machineId);
    console.log("üì¶ Movimientos obtenidos:", moves);
    
    const movesData = moves || [];
    
    const tbody = document.querySelector("#m-movements tbody");
    if (movesData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay movimientos registrados</td></tr>';
      return;
    }

    tbody.innerHTML = movesData.map(move => {
      const fromLoc = window.locationsCache.find(l => l.id === move.fromLocationId)?.name || 'Desconocida';
      const toLoc = window.locationsCache.find(l => l.id === move.toLocationId)?.name || 'Desconocida';
      const date = move.effectiveDate ? new Date(move.effectiveDate).toLocaleDateString() : 'N/A';
      
      return `
        <tr>
          <td>${date}</td>
          <td>${fromLoc}</td>
          <td>${toLoc}</td>
          <td>${move.movementType || 'N/A'}</td>
          <td>${move.reason || 'Sin raz√≥n especificada'}</td>
        </tr>
      `;
    }).join('');
  } catch (err) {
    console.error("‚ùå Error cargando movimientos:", err);
    document.querySelector("#m-movements tbody").innerHTML = 
      '<tr><td colspan="5" class="text-center text-warning">No se pudieron cargar los movimientos</td></tr>';
  }
}

async function loadMeterReadings(machineId) {
  try {
    console.log("üìä Cargando lecturas para m√°quina:", machineId);
    const meters = await machineService.meterReadings(machineId);
    console.log("üì¶ Lecturas obtenidas:", meters);
    
    const metersData = meters || [];
    
    const tbody = document.querySelector("#m-meter tbody");
    if (metersData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hay lecturas registradas</td></tr>';
      return;
    }

    tbody.innerHTML = metersData.map(meter => {
      const date = meter.readingDate ? new Date(meter.readingDate).toLocaleDateString() : 'N/A';
      
      return `
        <tr>
          <td>${date}</td>
          <td>${meter.reading || '0'}</td>
          <td>${meter.notes || 'Sin notas'}</td>
        </tr>
      `;
    }).join('');
  } catch (err) {
    console.error("‚ùå Error cargando lecturas:", err);
    document.querySelector("#m-meter tbody").innerHTML = 
      '<tr><td colspan="3" class="text-center text-warning">No se pudieron cargar las lecturas</td></tr>';
  }
}

function showMoveForm() {
  // Verificar que los datos de la m√°quina est√©n cargados
  if (!window.machineData || !window.machineData.currentLocationId) {
    showAlert("Primero debe cargarse la informaci√≥n de la m√°quina", "warning");
    return;
  }

  const select = document.getElementById("new-location");
  
  // Limpiar y llenar el select con ubicaciones
  select.innerHTML = '<option value="">Seleccione ubicaci√≥n destino</option>';
  
  if (window.locationsCache && window.locationsCache.length > 0) {
    window.locationsCache.forEach(loc => {
      if (loc.id !== window.machineData.currentLocationId) {
        const option = document.createElement("option");
        option.value = loc.id;
        option.textContent = `${loc.name}${loc.address ? ' - ' + loc.address : ''}`;
        select.appendChild(option);
      }
    });
  } else {
    showAlert("No hay ubicaciones disponibles", "warning");
  }
  
  document.getElementById("move-form").style.display = "block";
  document.getElementById("move-reason").value = "";
}

function hideMoveForm() {
  document.getElementById("move-form").style.display = "none";
}

async function saveMovement() {
  // Verificar que los datos est√©n cargados
  if (!window.machineData) {
    showAlert("Los datos de la m√°quina no est√°n cargados", "danger");
    return;
  }

  const toId = parseInt(document.getElementById("new-location").value);
  const reason = document.getElementById("move-reason").value.trim();
  
  if (!toId) {
    showAlert("Seleccione una ubicaci√≥n destino v√°lida", "warning");
    return;
  }
  
  if (!reason) {
    showAlert("Ingrese la raz√≥n del movimiento", "warning");
    return;
  }

  try {
    // Crear movimiento
    await fetch(API_BASE + "/machine-movements", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        machineId: window.__MID,
        fromLocationId: window.machineData.currentLocationId,
        toLocationId: toId,
        movementType: "REUBICACION",
        reason: reason,
        effectiveDate: new Date().toISOString()
      })
    });

    // Actualizar ubicaci√≥n actual de la m√°quina
    const updateData = {
      ...window.machineData,
      currentLocationId: toId
    };
    
    await machineService.update(window.__MID, updateData);

    showAlert("Movimiento registrado correctamente", "success");
    hideMoveForm();
    
    // Recargar datos
    await loadDetail();
    
  } catch(err) {
    console.error("‚ùå Error guardando movimiento:", err);
    showAlert("Error al guardar el movimiento: " + err.message, "danger");
  }
}

// Cargar detalles cuando el documento est√© listo
document.addEventListener("DOMContentLoaded", loadDetail);


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\assets\js\serviceVisitService.js =====
const serviceVisitService = {
  list: ()=> fetch(API_BASE + "/service-visits").then(r=>r.json()),
  create: (data)=> fetch(API_BASE + "/service-visits", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(data)}).then(r=>r.json())
};

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\assets\js\utils.js =====
function showAlert(msg, type='info'){ const div = document.createElement('div'); div.className = 'alert alert-'+type; div.innerText = msg; document.getElementById('content-main').prepend(div); setTimeout(()=>div.remove(),4000); }
function formatDate(dt){ return dt ? new Date(dt).toLocaleString() : ''; }

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\costs\analysis.html =====
<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">An√°lisis de Costos</h4>
        <div>
            <button class="btn btn-outline-secondary btn-sm" id="btn-refresh-costs">Actualizar</button>
            <button class="btn btn-success btn-sm" onclick="generateCostReport()">Generar Reporte</button>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <label class="form-label">Fecha inicio</label>
            <input type="date" class="form-control" id="cost-start-date">
        </div>
        <div class="col-md-3">
            <label class="form-label">Fecha fin</label>
            <input type="date" class="form-control" id="cost-end-date">
        </div>
        <div class="col-md-3">
            <label class="form-label">Tipo de an√°lisis</label>
            <select class="form-select" id="cost-analysis-type">
                <option value="monthly">Mensual</option>
                <option value="quarterly">Trimestral</option>
                <option value="yearly">Anual</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-success w-100" id="btn-analyze-costs">Analizar</button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Resumen de Costos</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="stat-card">
                                <i class="fas fa-tools"></i>
                                <div class="number" id="total-cost">$0</div>
                                <div class="label">Costo Total</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card">
                                <i class="fas fa-chart-line"></i>
                                <div class="number" id="avg-cost">$0</div>
                                <div class="label">Costo Promedio/Mes</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Distribuci√≥n de Costos</div>
                <div class="card-body">
                    <canvas id="costDistributionChart" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <h5>Evoluci√≥n de Costos</h5>
        <canvas id="costTrendChart" height="100"></canvas>
    </div>

    <div class="mt-4">
        <h5>Detalle de Costos</h5>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Fecha</th>
                        <th>Concepto</th>
                        <th>Tipo</th>
                        <th>Costo</th>
                        <th>T√©cnico</th>
                    </tr>
                </thead>
                <tbody id="costs-detail-tbody">
                    <tr>
                        <td colspan="5" class="text-center">Cargando detalle de costos...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    async function loadCostAnalysis() {
        try {
            // Obtener par√°metros de filtro
            const startDate = document.getElementById('cost-start-date').value;
            const endDate = document.getElementById('cost-end-date').value;
            const analysisType = document.getElementById('cost-analysis-type').value;
            
            // Cargar datos de costos
            const costData = await costService.analysis(new Date(startDate), new Date(endDate));
            
            // Actualizar UI con los datos
            updateCostUI(costData);
            
        } catch (error) {
            console.error('Error loading cost analysis:', error);
            showAlert('Error cargando an√°lisis de costos', 'danger');
        }
    }
    
    function updateCostUI(data) {
        // Actualizar resumen
        document.getElementById('total-cost').textContent = `$${data.totalCost?.toLocaleString() || '0'}`;
        document.getElementById('avg-cost').textContent = `$${data.avgMonthlyCost?.toLocaleString() || '0'}`;
        
        // Actualizar tabla de detalle
        const tbody = document.getElementById('costs-detail-tbody');
        tbody.innerHTML = '';
        
        if (data.details && data.details.length > 0) {
            data.details.forEach(cost => {
                tbody.innerHTML += `
                    <tr>
                        <td>${formatDateOnly(cost.date)}</td>
                        <td>${cost.concept}</td>
                        <td>${cost.type}</td>
                        <td>$${cost.amount?.toLocaleString()}</td>
                        <td>${cost.technician || 'N/A'}</td>
                    </tr>
                `;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay datos de costos</td></tr>';
        }
        
        // Crear gr√°ficos
        createCostCharts(data);
    }
    
    function createCostCharts(data) {
        // Gr√°fico de distribuci√≥n
        const distCtx = document.getElementById('costDistributionChart').getContext('2d');
        if (window.costDistributionChart) {
            window.costDistributionChart.destroy();
        }
        
        window.costDistributionChart = new Chart(distCtx, {
            type: 'doughnut',
            data: {
                labels: data.distribution?.map(d => d.category) || [],
                datasets: [{
                    data: data.distribution?.map(d => d.amount) || [],
                    backgroundColor: ['#0f9d58', '#36a2eb', '#ff6384', '#ffcd56', '#4bc0c0']
                }]
            }
        });
        
        // Gr√°fico de tendencia
        const trendCtx = document.getElementById('costTrendChart').getContext('2d');
        if (window.costTrendChart) {
            window.costTrendChart.destroy();
        }
        
        window.costTrendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: data.trend?.map(t => t.period) || [],
                datasets: [{
                    label: 'Costos',
                    data: data.trend?.map(t => t.amount) || [],
                    borderColor: '#0f9d58',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    async function generateCostReport() {
        try {
            const startDate = document.getElementById('cost-start-date').value;
            const endDate = document.getElementById('cost-end-date').value;
            
            const report = await reportService.generate('cost', {
                startDate: new Date(startDate),
                endDate: new Date(endDate)
            });
            
            if (report.url) {
                window.open(report.url, '_blank');
                showAlert('Reporte generado correctamente', 'success');
            } else {
                showAlert('Error generando el reporte', 'danger');
            }
        } catch (error) {
            console.error('Error generating report:', error);
            showAlert('Error generando el reporte', 'danger');
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Establecer fechas por defecto (√∫ltimos 6 meses)
        const endDate = new Date();
        const startDate = new Date();
        startDate.setMonth(startDate.getMonth() - 6);
        
        document.getElementById('cost-start-date').value = startDate.toISOString().split('T')[0];
        document.getElementById('cost-end-date').value = endDate.toISOString().split('T')[0];
        
        // Cargar datos iniciales
        loadCostAnalysis();
        
        // Configurar eventos
        document.getElementById('btn-analyze-costs').addEventListener('click', loadCostAnalysis);
        document.getElementById('btn-refresh-costs').addEventListener('click', loadCostAnalysis);
    });
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\customers\create.html =====
<div class="card p-3">
  <h4>Nuevo Cliente</h4>
  <form id="form-create-customer" class="row g-3">
    <div class="col-md-6"><label class="form-label">NIT</label>
      <input class="form-control" name="nit">
    </div>
    <div class="col-md-6"><label class="form-label">Nombre *</label>
      <input class="form-control" name="name" required>
    </div>
    <div class="col-md-6"><label class="form-label">Contacto</label>
      <input class="form-control" name="contactName">
    </div>
    <div class="col-md-6"><label class="form-label">Tel√©fono</label>
      <input class="form-control" name="phone">
    </div>
    <div class="col-md-6"><label class="form-label">Email</label>
      <input type="email" class="form-control" name="email">
    </div>
    <div class="col-md-12"><label class="form-label">Direcci√≥n</label>
      <input class="form-control" name="address">
    </div>
    <div class="col-12">
      <button class="btn btn-success" type="submit">Crear</button>
      <button type="button" class="btn btn-outline-secondary" onclick="appLoad('customers/list.html')">Cancelar</button>
    </div>
  </form>
</div>

<script>
document.getElementById("form-create-customer").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));
  try {
    await customerService.create(data);
    showAlert("Cliente creado correctamente","success");
    appLoad("customers/list.html");
  } catch(err) {
    showAlert("Error creando cliente: " + err.message,"danger");
  }
});
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\customers\detail.html =====
<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 id="c-name">Cliente</h4>
    <div>
      <button class="btn btn-outline-secondary me-2" onclick="appLoad('customers/edit.html?id='+__CID)">
        <i class="fas fa-edit me-1"></i> Editar
      </button>
      <button class="btn btn-outline-secondary" onclick="appLoad('customers/list.html')">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </button>
    </div>
  </div>

  <!-- Informaci√≥n b√°sica del cliente -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Informaci√≥n del Cliente</h6>
    </div>
    <div class="card-body">
      <table class="table table-sm">
        <tbody id="c-info"></tbody>
      </table>
    </div>
  </div>

  <!-- M√°quinas del cliente -->
  <div class="card mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h6 class="mb-0">M√°quinas Asociadas</h6>
      <span class="badge bg-primary" id="machine-count">0 m√°quinas</span>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead>
            <tr>
              <th>Serial</th>
              <th>Modelo/Marca</th>
              <th>Estado</th>
              <th>Ubicaci√≥n</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="customer-machines">
            <tr>
              <td colspan="5" class="text-center text-muted">Cargando m√°quinas...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Solicitudes del cliente -->
  <div class="card">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h6 class="mb-0">Solicitudes de Servicio</h6>
      <span class="badge bg-primary" id="request-count">0 solicitudes</span>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead>
            <tr>
              <th>N√∫mero</th>
              <th>M√°quina</th>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="customer-requests">
            <tr>
              <td colspan="6" class="text-center text-muted">Cargando solicitudes...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // Variable global para almacenar datos del cliente
  window.customerData = null;

  async function loadCustomerDetail() {
    let id = sessionStorage.getItem('selectedCustomerId');

    if (!id) {
      showAlert("ID de cliente no especificado", "danger");
      appLoad('customers/list.html');
      return;
    }

    window.__CID = id; // guardar id para reusar
    try {
      // Cargar informaci√≥n del cliente
      const c = await customerService.get(id);
      if (!c) {
        showAlert("Cliente no encontrado", "warning");
        appLoad('customers/list.html');
        return;
      }

      window.customerData = c;

      document.getElementById("c-name").innerText = c.name || ("Cliente " + c.id);
      document.getElementById("c-info").innerHTML = `
      <tr><th>ID</th><td>${c.id}</td></tr>
      <tr><th>NIT</th><td>${c.nit || ""}</td></tr>
      <tr><th>Nombre</th><td>${c.name || ""}</td></tr>
      <tr><th>Contacto</th><td>${c.contactName || ""}</td></tr>
      <tr><th>Tel√©fono</th><td>${c.phone || ""}</td></tr>
      <tr><th>Email</th><td>${c.email || ""}</td></tr>
      <tr><th>Direcci√≥n</th><td>${c.address || ""}</td></tr>
    `;

      // Cargar m√°quinas del cliente
      await loadCustomerMachines(id);

      // Cargar solicitudes del cliente
      await loadCustomerRequests(id);

    } catch (err) {
      console.error("Error cargando cliente:", err);
      showAlert("Error cargando cliente: " + err.message, "danger");
    }
  }

  async function loadCustomerMachines(customerId) {
    try {
      // Obtener todas las m√°quinas y filtrar por cliente
      const allMachines = await machineService.list();
      const customerMachines = allMachines.filter(m => m.currentCustomerId == customerId);

      document.getElementById("machine-count").innerText = `${customerMachines.length} m√°quinas`;

      const tbody = document.getElementById("customer-machines");

      if (customerMachines.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay m√°quinas asociadas</td></tr>';
        return;
      }

      // Cargar ubicaciones si no est√°n en cache
      if (!window.locationsCache || window.locationsCache.length === 0) {
        window.locationsCache = await locationService.list();
      }

      tbody.innerHTML = customerMachines.map(machine => {
        const location = window.locationsCache.find(l => l.id === machine.currentLocationId);
        return `
        <tr>
          <td>${machine.companySerial || 'N/A'}</td>
          <td>${machine.model || 'N/A'} / ${machine.brand || 'N/A'}</td>
          <td><span class="badge bg-secondary">${machine.status || 'N/A'}</span></td>
          <td>${location ? location.name : 'Ubicaci√≥n no disponible'}</td>
          <td>
            <button class="btn btn-sm btn-primary me-1" onclick="loadMachineDetail(${machine.id})">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-success" 
  onclick="createServiceRequestForMachine(
    ${machine.id}, 
    ${customerId}, 
    '${machine.companySerial || ''}', 
    '${machine.companyNumber || ''}', 
    '${window.customerData?.name || ''}', 
    '${window.customerData?.nit || ''}'
  )">
  <i class="fas fa-tools"></i>
</button>
          </td>
        </tr>
      `;
      }).join('');
    } catch (err) {
      console.error("Error cargando m√°quinas del cliente:", err);
      document.getElementById("customer-machines").innerHTML =
        '<tr><td colspan="5" class="text-center text-danger">Error cargando m√°quinas</td></tr>';
    }
  }

  async function loadCustomerRequests(customerId) {
    try {
      // Obtener solicitudes del cliente
      const requests = await serviceRequestService.list();
      const customerRequests = requests.filter(r => r.customerId == customerId);

      document.getElementById("request-count").innerText = `${customerRequests.length} solicitudes`;

      const tbody = document.getElementById("customer-requests");

      if (customerRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay solicitudes registradas</td></tr>';
        return;
      }

      tbody.innerHTML = customerRequests.map(request => {
        const date = request.reportedAt ? new Date(request.reportedAt).toLocaleDateString() : 'N/A';
        return `
        <tr>
          <td>${request.requestNumber || request.id}</td>
          <td>${request.companySerial || 'N/A'}</td>
          <td>${date}</td>
          <td>${request.serviceType || 'N/A'}</td>
          <td><span class="badge ${request.status === 'CERRADA' ? 'bg-success' : 'bg-warning'}">${request.status || 'N/A'}</span></td>
          <td>
            <button class="btn btn-sm btn-info" onclick="appLoad('service_requests/detail.html?id=${request.id}')">
              <i class="fas fa-info-circle"></i>
            </button>
          </td>
        </tr>
      `;
      }).join('');
    } catch (err) {
      console.error("Error cargando solicitudes del cliente:", err);
      document.getElementById("customer-requests").innerHTML =
        '<tr><td colspan="6" class="text-center text-danger">Error cargando solicitudes</td></tr>';
    }
  }

  // Funci√≥n para crear solicitud para una m√°quina espec√≠fica
  function createServiceRequestForMachine(machineId, customerId, machineSerial, machineNumber, customerName, customerNit) {
    sessionStorage.setItem('selectedMachineId', machineId);
    sessionStorage.setItem('selectedCustomerId', customerId);
    sessionStorage.setItem('selectedMachineSerial', machineSerial);
    sessionStorage.setItem('selectedMachineNumber', machineNumber);
    sessionStorage.setItem('selectedCustomerName', customerName);
    sessionStorage.setItem('selectedCustomerNit', customerNit);
    appLoad('service_requests/new.html');
  }

  // Funci√≥n para cargar detalle de m√°quina (reutilizada)
  function loadMachineDetail(id) {
    sessionStorage.setItem('selectedMachineId', id);
    appLoad('machines/detail.html');
  }

  loadCustomerDetail();
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\customers\edit.html =====
<div class="card p-3">
  <h4>Editar Cliente</h4>
  <form id="form-edit-customer" class="row g-3"></form>
</div>

<script>
async function loadCustomerEdit(){
  const params = new URLSearchParams(location.search);
  const id = params.get("id");
  if(!id) return;

  try {
    const c = await customerService.get(id);
    const form = document.getElementById("form-edit-customer");
    form.innerHTML = `
      <div class="col-md-6"><label class="form-label">NIT</label>
        <input class="form-control" name="nit" value="${c.nit||""}">
      </div>
      <div class="col-md-6"><label class="form-label">Nombre *</label>
        <input class="form-control" name="name" value="${c.name||""}" required>
      </div>
      <div class="col-md-6"><label class="form-label">Contacto</label>
        <input class="form-control" name="contactName" value="${c.contactName||""}">
      </div>
      <div class="col-md-6"><label class="form-label">Tel√©fono</label>
        <input class="form-control" name="phone" value="${c.phone||""}">
      </div>
      <div class="col-md-6"><label class="form-label">Email</label>
        <input type="email" class="form-control" name="email" value="${c.email||""}">
      </div>
      <div class="col-md-12"><label class="form-label">Direcci√≥n</label>
        <input class="form-control" name="address" value="${c.address||""}">
      </div>
      <div class="col-12">
        <button class="btn btn-success" type="submit">Guardar</button>
        <button type="button" class="btn btn-outline-secondary" onclick="appLoad('customers/list.html')">Cancelar</button>
      </div>
    `;

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form));
      try {
        await customerService.update(id, data);
        showAlert("Cliente actualizado","success");
        appLoad("customers/list.html");
      } catch(err){
        showAlert("Error actualizando: " + err.message,"danger");
      }
    });

  } catch(err){
    showAlert("Error cargando cliente: " + err.message,"danger");
  }
}
document.addEventListener("DOMContentLoaded", loadCustomerEdit);
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\customers\list.html =====
<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Clientes</h4>
    <button class="btn btn-success btn-sm" onclick="appLoad('customers/create.html')">
      <i class="fas fa-plus me-1"></i> Nuevo Cliente
    </button>
  </div>

  <div class="table-responsive">
    <table class="table table-hover">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>NIT</th>
          <th>Nombre</th>
          <th>Contacto</th>
          <th>Tel√©fono</th>
          <th>Email</th>
          <th>Direcci√≥n</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="customers-tbody">
        <tr><td colspan="8" class="text-center">Cargando...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
    async function loadCustomers(){
        try {
            const customers = await customerService.list();
            const tbody = document.getElementById("customers-tbody");
            tbody.innerHTML = "";

            if(customers.length === 0){
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">No hay clientes</td></tr>`;
                return;
            }

            customers.forEach(c => {
                tbody.innerHTML += `
                    <tr>
                        <td>${c.id}</td>
                        <td>${c.nit || ""}</td>
                        <td>${c.name || ""}</td>
                        <td>${c.contactName || ""}</td>
                        <td>${c.phone || ""}</td>
                        <td>${c.email || ""}</td>
                        <td>${c.address || ""}</td>
                        <td class="table-actions text-end">
                            <button class="btn btn-sm btn-info" onclick="loadCustomerDetail(${c.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="appLoad('customers/edit.html?id=${c.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${c.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        } catch (err) {
            console.error("Error loading customers:", err);
            showAlert("Error cargando clientes: " + err.message, "danger");
        }
    }

    async function deleteCustomer(id){
        if(!confirm("¬øSeguro que quieres eliminar este cliente?")) return;
        try {
            await customerService.delete(id);
            showAlert("Cliente eliminado","success");
            loadCustomers();
        } catch(err){
            showAlert("Error eliminando: " + err.message,"danger");
        }
    }

    function loadCustomerDetail(id) {
        sessionStorage.setItem('selectedCustomerId', id);
        appLoad('customers/detail.html');
    }


    // Autoejecutar inmediatamente cuando el snippet se inyecta
    (async function(){
        await loadCustomers();
    })();
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\machines\create_request.html =====
<div class="card p-3">
  <h4>Crear Solicitud</h4>
  <form id="form-create-request" class="row g-3">
    <div class="col-md-6"><label class="form-label">Machine ID *</label><input class="form-control" name="machineId" required></div>
    <div class="col-md-6"><label class="form-label">Cliente (customerId)</label><input class="form-control" name="customerId"></div>
    <div class="col-md-6"><label class="form-label">Canal</label>
      <select name="reportedChannel" class="form-select">
        <option value="telefono">Tel√©fono</option><option value="whatsapp">WhatsApp</option><option value="email">Email</option><option value="portal">Portal</option>
      </select>
    </div>
    <div class="col-md-6"><label class="form-label">Tipo de servicio</label>
      <select name="serviceType" class="form-select">
        <option value="correctivo">Correctivo</option><option value="preventivo">Preventivo</option><option value="diagnostico">Diagn√≥stico</option><option value="toner">Toner</option><option value="toma_contador">Toma contador</option><option value="otro">Otro</option>
      </select>
    </div>
    <div class="col-12"><label class="form-label">Root cause</label><input class="form-control" name="rootCause"></div>
    <div class="col-12"><label class="form-label">Descripci√≥n</label><textarea class="form-control" name="description" rows="4"></textarea></div>
    <div class="col-12"><button class="btn btn-success" type="submit">Crear</button></div>
  </form>
</div>
<script>
document.getElementById("form-create-request").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));
  try{ await serviceRequestService.create(data); alert("Solicitud creada"); appLoad('machines/service_requests.html'); }
  catch(err){ alert("Error: "+err.message); }
});
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\machines\detail.html =====
<div class="card p-3">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h4 id="m-title">M√°quina</h4>
      <p class="text-muted" id="m-sub">Detalle de m√°quina</p>
    </div>
    <div>
      <button class="btn btn-outline-secondary me-2" onclick="appLoad('machines/edit.html?id='+window.__MID)">
        <i class="fas fa-edit me-1"></i> Editar
      </button>
      <button class="btn btn-success" onclick="goToRequests()">
        <i class="fas fa-tools me-1"></i> Ver solicitudes
      </button>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Informaci√≥n de la M√°quina</h6>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tbody id="m-info">
              <tr>
                <td colspan="2" class="text-center text-muted">Cargando informaci√≥n...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Estado y Ubicaci√≥n</h6>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tbody id="m-location">
              <tr>
                <td colspan="2" class="text-center text-muted">Cargando ubicaci√≥n...</td>
              </tr>
            </tbody>
          </table>
          <button class="btn btn-sm btn-primary mt-2" onclick="showMoveForm()" id="btn-move">
            <i class="fas fa-exchange-alt me-1"></i> Agregar movimiento
          </button>
          <div id="move-form" class="mt-3 p-3 border rounded" style="display:none;">
            <h6 class="mb-2">Nuevo Movimiento</h6>
            <select id="new-location" class="form-select mb-2">
              <option value="">Seleccione ubicaci√≥n destino</option>
            </select>
            <input type="text" id="move-reason" class="form-control mb-2" placeholder="Raz√≥n del movimiento">
            <div class="d-flex gap-2">
              <button class="btn btn-success btn-sm" onclick="saveMovement()">
                <i class="fas fa-save me-1"></i> Guardar
              </button>
              <button class="btn btn-outline-secondary btn-sm" onclick="hideMoveForm()">
                <i class="fas fa-times me-1"></i> Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Historial de Movimientos</h6>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm" id="m-movements">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>De</th>
                  <th>A</th>
                  <th>Tipo</th>
                  <th>Raz√≥n</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="5" class="text-center text-muted">Cargando movimientos...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Historial de Lecturas</h6>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm" id="m-meter">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Lectura B/N</th>
                  <th>Lectura Color</th>
                  <th>Lectura Scanner</th>
                  <th>Notas</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="3" class="text-center text-muted">Cargando lecturas...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-12 mt-3">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Historial de Niveles de Toner</h6>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm" id="m-toner">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>K (Negro)</th>
                  <th>C (Cian)</th>
                  <th>M (Magenta)</th>
                  <th>Y (Amarillo)</th>
                  <th>Notas</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="6" class="text-center text-muted">Cargando lecturas de toner...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>


  </div>
</div>

<script>
  (async function () {
    console.log("üîç Iniciando carga de detalle de m√°quina");
    window.machineData = null;

    async function loadDetail() {
      const params = new URLSearchParams(location.search);
      let id = params.get("id") || sessionStorage.getItem('selectedMachineId');

      if (!window.customersCache || window.customersCache.length === 0) {
        try {
          console.log("üì• Cargando customers desde backend...");
          window.customersCache = await customerService.list();
          console.log("üì• customers cargados:", window.customersCache.length);
        } catch (err) {
          console.warn("‚ö†Ô∏è No se pudieron cargar customers:", err);
          window.customersCache = [];
        }
      }



      if (!id) {
        showAlert("ID de m√°quina no especificado", "danger");
        return;
      }
      window.__MID = id;

      try {
        document.getElementById("m-title").innerText = "Cargando...";
        document.getElementById("m-sub").innerText = "Por favor espere";
        document.getElementById("btn-move").disabled = true;

        window.machineData = await machineService.get(id);

        // Cargar ubicaciones si no est√°n en cache
        if (!window.locationsCache || window.locationsCache.length === 0) {
          window.locationsCache = await locationService.list();
        }
        // Cargar clientes si no est√°n en cache
        if (!window.customersCache || window.customersCache.length === 0) {
          window.customersCache = await customerService.list();
        }

        // Info b√°sica
        document.getElementById("m-title").innerText =
          window.machineData.companySerial || `M√°quina ${window.machineData.id}`;
        document.getElementById("m-sub").innerText =
          `${window.machineData.brand || 'Sin marca'} ${window.machineData.model || 'Sin modelo'}`;

        document.getElementById("m-info").innerHTML = `
                <tr><th>ID</th><td>${window.machineData.id || 'N/A'}</td></tr>
                <tr><th>Serial</th><td>${window.machineData.companySerial || 'N/A'}</td></tr>
                <tr><th>N√∫mero</th><td>${window.machineData.companyNumber || 'N/A'}</td></tr>
                <tr><th>Modelo</th><td>${window.machineData.model || 'N/A'}</td></tr>
                <tr><th>Marca</th><td>${window.machineData.brand || 'N/A'}</td></tr>
                <tr><th>A√±o</th><td>${window.machineData.year || 'N/A'}</td></tr>
                <tr><th>Estado</th><td>${window.machineData.status || 'N/A'}</td></tr>
                <tr><th>Notas</th><td>${window.machineData.notes || 'Sin notas'}</td></tr>
            `;

        // Ubicaci√≥n + Cliente
        let locationName = "No asignada";
        const location = window.locationsCache.find(l => l.id === window.machineData.currentLocationId);
        if (location) locationName = location.name;

        let customerName = "Cliente no asignado";
        if (window.machineData.currentCustomerId) {
          const customer = window.customersCache.find(c => c.id === window.machineData.currentCustomerId);
          customerName = customer ? customer.name : `ID ${window.machineData.currentCustomerId}`;
        }

        document.getElementById("m-location").innerHTML = `
                <tr><th>Ubicaci√≥n Actual</th><td>${locationName}</td></tr>
                <tr><th>ID Ubicaci√≥n</th><td>${window.machineData.currentLocationId || 'N/A'}</td></tr>
                <tr><th>Cliente Actual</th><td>${customerName}</td></tr>
            `;

        document.getElementById("btn-move").disabled = false;
        await loadMovements(id);
        await loadMeterReadings(id);

      } catch (err) {
        console.error("‚ùå Error cargando detalle:", err);
        showAlert("Error cargando detalles de la m√°quina: " + err.message, "danger");
      }

      await loadTonerReadings(id);
    }

    async function loadMovements(machineId) {
      const moves = await machineService.movements(machineId);
      const tbody = document.querySelector("#m-movements tbody");
      if (!moves || moves.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay movimientos registrados</td></tr>';
        return;
      }
      tbody.innerHTML = moves.map(move => {
        const fromLoc = window.locationsCache.find(l => l.id === move.fromLocationId)?.name || 'Desconocida';
        const toLoc = window.locationsCache.find(l => l.id === move.toLocationId)?.name || 'Desconocida';
        const date = move.effectiveDate ? new Date(move.effectiveDate).toLocaleDateString() : 'N/A';
        return `
                <tr>
                    <td>${date}</td>
                    <td>${fromLoc}</td>
                    <td>${toLoc}</td>
                    <td>${move.movementType || 'N/A'}</td>
                    <td>${move.reason || 'Sin raz√≥n especificada'}</td>
                </tr>
            `;
      }).join('');
    }

    async function loadMeterReadings(machineId) {
      const meters = await machineService.meterReadings(machineId);
      const tbody = document.querySelector("#m-meter tbody");
      if (!meters || meters.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hay lecturas registradas</td></tr>';
        return;
      }
      tbody.innerHTML = meters.map(meter => {
        const date = meter.readingDate ? new Date(meter.readingDate).toLocaleDateString() : 'N/A';
        return `
                <tr>
                    <td>${date}</td>
                    <td>${meter.reading ?? '0'}</td>
                    <td>${meter.colorReading ?? '0'}</td>
                    <td>${meter.scannerReading ?? '0'}</td>
                    <td>${meter.notes || 'Sin notas'}</td>
                </tr>
            `;
      }).join('');
    }

    async function loadTonerReadings(machineId) {
      try {
        const tonerReadings = await machineService.tonerReadings(machineId);
        const tbody = document.querySelector("#m-toner tbody");
        if (!tonerReadings || tonerReadings.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay lecturas de toner registradas</td></tr>';
          return;
        }
        tbody.innerHTML = tonerReadings.map(toner => {
          const date = toner.readingDate ? new Date(toner.readingDate).toLocaleDateString() : 'N/A';
          return `
                <tr>
                    <td>${date}</td>
                    <td>
                        ${toner.levelK !== null ? toner.levelK + '%' : 'N/A'}
                        ${toner.levelK !== null ?
              `<div class="progress mt-1" style="height: 5px;">
                                <div class="progress-bar bg-dark" style="width: ${toner.levelK}%"></div>
                            </div>` : ''}
                    </td>
                    <td>
                        ${toner.levelC !== null ? toner.levelC + '%' : 'N/A'}
                        ${toner.levelC !== null ?
              `<div class="progress mt-1" style="height: 5px;">
                                <div class="progress-bar bg-info" style="width: ${toner.levelC}%"></div>
                            </div>` : ''}
                    </td>
                    <td>
                        ${toner.levelM !== null ? toner.levelM + '%' : 'N/A'}
                        ${toner.levelM !== null ?
              `<div class="progress mt-1" style="height: 5px;">
                                <div class="progress-bar bg-danger" style="width: ${toner.levelM}%"></div>
                            </div>` : ''}
                    </td>
                    <td>
                        ${toner.levelY !== null ? toner.levelY + '%' : 'N/A'}
                        ${toner.levelY !== null ?
              `<div class="progress mt-1" style="height: 5px;">
                                <div class="progress-bar bg-warning" style="width: ${toner.levelY}%"></div>
                            </div>` : ''}
                    </td>
                    <td>${toner.notes || 'Sin notas'}</td>
                </tr>
            `;
        }).join('');
      } catch (err) {
        console.error("Error cargando lecturas de toner:", err);
        document.querySelector("#m-toner tbody").innerHTML =
          '<tr><td colspan="6" class="text-center text-danger">Error cargando lecturas de toner</td></tr>';
      }
    }






    await loadDetail();

    window.loadDetail = loadDetail;
  })();

  function showMoveForm() {
    const form = document.getElementById("move-form");
    form.style.display = "block";
    const select = document.getElementById("new-location");
    select.innerHTML = '<option value="">Seleccione ubicaci√≥n destino</option>';
    (window.locationsCache || []).forEach(l => {
      if (l.id !== window.machineData.currentLocationId) {
        select.innerHTML += `<option value="${l.id}">${l.name}</option>`;
      }
    });
  }

  function hideMoveForm() {
    document.getElementById("move-form").style.display = "none";
  }

  async function saveMovement() {
    const toLocationId = parseInt(document.getElementById("new-location").value);
    const reason = document.getElementById("move-reason").value;

    if (!toLocationId) {
      alert("Debe seleccionar una ubicaci√≥n destino");
      return;
    }

    // Buscar el cliente asociado al nuevo location
    let newCustomerId = null;

    // Buscar en los customers si alguno tiene esta location
    if (window.customersCache && window.customersCache.length > 0) {
      const customerWithLocation = window.customersCache.find(c =>
        c.location && parseInt(c.location.id) === toLocationId
      );

      if (customerWithLocation) {
        newCustomerId = customerWithLocation.id;
        console.log("‚úÖ Cliente encontrado para location:", customerWithLocation.name);
      } else {
        console.log("‚ÑπÔ∏è No hay cliente asociado a esta ubicaci√≥n (puede ser bodega)");
      }
    }

    console.log("üìå Movimiento hacia locationId:", toLocationId, "-> customerId:", newCustomerId);

    try {
      // 1) Guardar movimiento en historial
      const mvResp = await fetch(`${API_BASE}/machine-movements`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          machineId: parseInt(window.__MID),
          fromLocationId: window.machineData.currentLocationId,
          toLocationId: toLocationId,
          movementType: "TRASLADO",
          reason: reason
        })
      });

      if (!mvResp.ok) {
        const txt = await mvResp.text().catch(() => mvResp.statusText);
        throw new Error("Error guardando movimiento: " + mvResp.status + " " + txt);
      }
      await mvResp.json();

      // 2) Actualizar la m√°quina con la nueva ubicaci√≥n Y el cliente (si existe)
      const updatePayload = {
        id: window.machineData.id,
        companySerial: window.machineData.companySerial,
        companyNumber: window.machineData.companyNumber,
        model: window.machineData.model,
        brand: window.machineData.brand,
        year: window.machineData.year,
        status: window.machineData.status,
        notes: window.machineData.notes,
        initialReading: window.machineData.initialReading,
        readingNotes: window.machineData.readingNotes,

        // üëá forzamos que se manden los correctos
        currentLocationId: toLocationId,
        currentCustomerId: newCustomerId !== undefined ? newCustomerId : null
      };

      console.log("üì§ Payload final al update:", JSON.stringify(updatePayload, null, 2));
      console.log("üì§ PUT /machines payload:", updatePayload);

      const upd = await machineService.update(window.__MID, updatePayload);

      // 3) Refrescar la vista
      showAlert("Movimiento registrado correctamente", "success");
      hideMoveForm();
      await loadDetail();

    } catch (err) {
      console.error("‚ùå Error guardando movimiento:", err);
      alert("Error guardando movimiento: " + (err.message || err));
    }
  }

  function goToRequests() {
    if (!window.machineData) {
      showAlert("No se carg√≥ la informaci√≥n de la m√°quina", "danger");
      return;
    }

    // Guardar datos en sessionStorage
    sessionStorage.setItem("selectedMachineId", window.machineData.id);
    sessionStorage.setItem("selectedMachineSerial", window.machineData.companySerial || "");
    sessionStorage.setItem("selectedMachineNumber", window.machineData.companyNumber || "");
    sessionStorage.setItem("selectedCustomerId", window.machineData.currentCustomerId || "");

    // Busca el nombre del cliente en cache si existe
    const customer = (window.customersCache || []).find(c => c.id === window.machineData.currentCustomerId);
    if (customer) {
      sessionStorage.setItem("selectedCustomerName", customer.name);
      sessionStorage.setItem("selectedCustomerNit", customer.nit || "");
    }

    // Ir a la p√°gina de solicitudes de la m√°quina
    appLoad('machines/service_requests.html');
  }


</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\machines\edit.html =====
<div class="card p-3">
  <h4>Editar M√°quina</h4>
  <form id="form-edit-machine" class="row g-3">
    <input type="hidden" name="id" id="m-id">
    <div class="col-md-6">
      <label class="form-label">Serial (companySerial) *</label>
      <input class="form-control" name="companySerial" id="m-companySerial" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">N√∫mero (companyNumber)</label>
      <input class="form-control" name="companyNumber" id="m-companyNumber">
    </div>
    <div class="col-md-4">
      <label class="form-label">Modelo *</label>
      <input class="form-control" name="model" id="m-model" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Marca</label>
      <input class="form-control" name="brand" id="m-brand">
    </div>
    <div class="col-md-2">
      <label class="form-label">A√±o</label>
      <input type="number" class="form-control" name="year" id="m-year">
    </div>
    <div class="col-12">
      <label class="form-label">Notas</label>
      <textarea class="form-control" name="notes" id="m-notes" rows="3"></textarea>
    </div>
    <div class="col-12">
      <button class="btn btn-primary" type="submit">Guardar cambios</button>
      <button class="btn btn-outline-secondary" type="button" onclick="appLoad('machines/detail.html?id='+document.getElementById('m-id').value)">Cancelar</button>
    </div>
  </form>
</div>


<script>
async function loadEdit(){
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  if(!id) return;
  const m = await machineService.get(id).then(r=>r.data||r);
  document.getElementById('m-id').value = m.id;
  document.getElementById('m-companySerial').value = m.companySerial||'';
  document.getElementById('m-companyNumber').value = m.companyNumber||'';
  document.getElementById('m-model').value = m.model||'';
  document.getElementById('m-brand').value = m.brand||'';
  document.getElementById('m-year').value = m.year||'';
  document.getElementById('m-notes').value = m.notes||'';
}
document.addEventListener("DOMContentLoaded", loadEdit);
document.getElementById("form-edit-machine").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));
  try{
    await machineService.update(data.id, data);
    alert("Guardado");
    appLoad('machines/detail.html?id='+data.id);
  }catch(err){ alert("Error: "+err.message); }
});
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\machines\list.html =====
<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Listado de M√°quinas</h4>
        <button class="btn btn-success btn-sm" onclick="appLoad('machines/new.html')">
            <i class="fas fa-plus me-1"></i> Nueva M√°quina
        </button>
    </div>

    <div class="mb-3">
        <input type="text" id="machine-search" class="form-control" placeholder="Buscar m√°quina...">
    </div>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Serial</th>
                    <th>N√∫mero</th>
                    <th>Modelo / Marca</th>
                    <th>Cliente</th>
                    <th>Ubicaci√≥n</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="machines-tbody">
                <tr>
                    <td colspan="6" class="text-center">Cargando m√°quinas...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    if (typeof locationsCache === 'undefined') {
    locationsCache = [];
}
function loadMachineDetail(id) {
    // Guardar el ID en sessionStorage o variable global
    sessionStorage.setItem('selectedMachineId', id);
    appLoad('machines/detail.html');
}

    async function loadLocations() {
        try {
            locationsCache = await locationService.list();
        } catch (err) {
            console.error("Error cargando locations:", err);
            showAlert("No se pudieron cargar las ubicaciones", "danger");
            locationsCache = [];
        }
    }

    async function loadMachines(query = "") {
        try {
            const machines = query 
                ? await machineService.search(query) 
                : await machineService.list();

            const tbody = document.getElementById("machines-tbody");
            tbody.innerHTML = "";

            if (machines && machines.length > 0) {
                machines.forEach(m => {
                    const loc = locationsCache.find(l => l.id === m.currentLocationId);
                    tbody.innerHTML += `
                        <tr>
                            <td>${m.companySerial || 'N/A'}</td>
                            <td>${m.companyNumber || ''}</td>
                            <td>
                                ${m.model || 'N/A'}<br>
                                <small>${m.brand || ''}</small>
                            </td>
                            <td>${m.customerName || 'N/A'}</td>
                            <td>${loc ? loc.name : ''}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="loadMachineDetail(${m.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="appLoad('machines/edit.html?id=${m.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteMachine(${m.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center">No se encontraron m√°quinas</td></tr>`;
            }
        } catch (error) {
            console.error("Error loading machines:", error);
            showAlert("Error cargando m√°quinas", "danger");
        }
    }

    async function deleteMachine(id) {
        if (!confirm("¬øSeguro que deseas eliminar esta m√°quina?")) return;
        try {
            await machineService.delete(id);
            showAlert("M√°quina eliminada", "success");
            loadMachines();
        } catch (error) {
            console.error("Error deleting machine:", error);
            showAlert("Error eliminando m√°quina", "danger");
        }
    }

    // üöÄ Cargar locations primero y luego machines
    (async () => {
        await loadLocations();
        await loadMachines();
    })();

    document.getElementById("machine-search").addEventListener("input", (e) => {
        loadMachines(e.target.value);
    });



</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\machines\new.html =====
<div class="card p-3">
  <h4>Crear M√°quina</h4>
  <form id="form-create-machine" class="row g-3 needs-validation" novalidate>
    <div class="col-md-6">
      <label class="form-label">Serial (companySerial) *</label>
      <input class="form-control" name="companySerial" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">N√∫mero (companyNumber)</label>
      <input class="form-control" name="companyNumber">
    </div>

    <div class="col-md-4">
      <label class="form-label">Modelo *</label>
      <input class="form-control" name="model" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Marca</label>
      <input class="form-control" name="brand">
    </div>
    <div class="col-md-2">
      <label class="form-label">A√±o</label>
      <input type="number" class="form-control" name="year">
    </div>

    <div class="col-12">
      <label class="form-label">Notas de la m√°quina</label>
      <textarea class="form-control" name="notes" rows="2"></textarea>
    </div>

    <!-- üîπ Campos para la lectura inicial -->
    <div class="col-md-4">
      <label class="form-label">Lectura inicial (B/N) *</label>
      <input type="number" class="form-control" name="initialReading" required value="0">
    </div>

    <div class="col-md-4">
      <label class="form-label">Lectura inicial color</label>
      <input type="number" class="form-control" name="initialColorReading" value="0">
    </div>

    <div class="col-md-4">
      <label class="form-label">Lectura inicial scanner</label>
      <input type="number" class="form-control" name="initialScannerReading" value="0">
    </div>

    <div class="col-md-12">
      <label class="form-label">Notas de lectura</label>
      <input class="form-control" name="readingNotes" placeholder="Ej: Lectura inicial al instalar">
    </div>

    <!-- üîπ Selector de estado -->
    <div class="col-md-6">
      <label class="form-label">Estado</label>
      <select class="form-select" name="status" required>
        <option value="BODEGA" selected>Bodega</option>
        <option value="INSTALADA">Instalada</option>
        <option value="MANTENIMIENTO">Mantenimiento</option>
        <option value="RETIRADA">Retirada</option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Ubicaci√≥n actual</label>
      <select class="form-select" name="currentLocationId" id="machine-location" required>
        <option value="">Seleccione una ubicaci√≥n</option>
      </select>
    </div>

    <div class="col-12">
      <button class="btn btn-success" type="submit">Crear</button>
      <button class="btn btn-outline-secondary" type="button" onclick="appLoad('machines/list.html')">Cancelar</button>
    </div>
  </form>
</div>

<script>
  (async () => {
    try {
      // üîπ Cargar ubicaciones
      const locations = await locationService.list();
      window.locationsCache = locations; // cache opcional
      const select = document.getElementById("machine-location");
      select.innerHTML = '<option value="">Seleccione una ubicaci√≥n</option>';

      locations.forEach(loc => {
        const opt = document.createElement("option");
        opt.value = loc.id;
        opt.textContent = loc.name + (loc.address ? " - " + loc.address : "");
        select.appendChild(opt);
      });

      // üîπ Cargar clientes y cachearlos
      window.customersCache = await customerService.list();

    } catch (err) {
      console.error("Error cargando datos", err);
      showAlert("No se pudieron cargar ubicaciones/clientes", "danger");
    }
  })();

  document.getElementById("form-create-machine").addEventListener("submit", async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    data.year = data.year ? parseInt(data.year) : null;
    data.currentLocationId = data.currentLocationId ? parseInt(data.currentLocationId) : null;

    // üîπ Buscar el cliente seg√∫n la ubicaci√≥n elegida
    let selectedCustomerId = null;
    if (window.customersCache && data.currentLocationId) {
      const customer = window.customersCache.find(c => c.location && c.location.id === data.currentLocationId);
      if (customer) {
        selectedCustomerId = customer.id;
      }
    }

    // üîπ Asignar el cliente al payload
    data.currentCustomerId = selectedCustomerId;

    try {
      await machineService.create(data);
      showAlert("M√°quina creada correctamente", "success");
      appLoad("machines/list.html");
    } catch (err) {
      showAlert("Error creando m√°quina: " + err.message, "danger");
    }
  });

</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\machines\new_machine_request.html =====
<div class="card p-3">
  <h4>Nueva Solicitud</h4>
  
  <!-- Informaci√≥n precargada (solo lectura) -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Informaci√≥n Precargada</h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <strong>Cliente:</strong> 
          <span id="preloaded-customer-name"></span> 
          <small id="preloaded-customer-nit" class="text-muted"></small>
        </div>
        <div class="col-md-6">
          <strong>M√°quina:</strong> 
          <span id="preloaded-machine-serial"></span> 
          <small id="preloaded-machine-number" class="text-muted"></small>
        </div>
      </div>
    </div>
  </div>

  <!-- Historial de solicitudes para esta m√°quina -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Solicitudes Anteriores de esta M√°quina</h6>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Seleccionar</th>
              <th>N√∫mero</th>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Causa Ra√≠z</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="previous-requests">
            <tr>
              <td colspan="6" class="text-center">Cargando solicitudes anteriores...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Formulario para completar -->
  <form id="form-new-request" class="row g-3">
    <input type="hidden" name="machineId" id="machine-id">
    <input type="hidden" name="customerId" id="customer-id">
    
    <div class="col-md-6">
      <label class="form-label">Canal *</label>
      <select name="reportedChannel" class="form-select" required>
        <option value="">Seleccione un canal</option>
        <option value="telefono">Tel√©fono</option>
        <option value="whatsapp">WhatsApp</option>
        <option value="email">Email</option>
        <option value="portal">Portal</option>
      </select>
    </div>
    
    <div class="col-md-6">
      <label class="form-label">Tipo de Servicio *</label>
      <select name="serviceType" class="form-select" required>
        <option value="">Seleccione un tipo</option>
        <option value="correctivo">Correctivo</option>
        <option value="preventivo">Preventivo</option>
        <option value="diagnostico">Diagn√≥stico</option>
        <option value="toma_contador">Toma de contador</option>
        <option value="toner">Toner</option>
        <option value="otro">Otro</option>
      </select>
    </div>
    
    <div class="col-12">
      <label class="form-label">Causa Ra√≠z *</label>
      <input class="form-control" name="rootCause" required>
    </div>
    
    <div class="col-12">
      <label class="form-label">Descripci√≥n *</label>
      <textarea class="form-control" name="description" rows="3" required></textarea>
    </div>
    
    <div class="col-12">
      <label class="form-label">Solicitud repetida de (opcional)</label>
      <select name="repeatedOfRequestId" class="form-select" id="repeated-request">
        <option value="">No es una solicitud repetida</option>
        <!-- Las opciones se llenar√°n con JavaScript -->
      </select>
    </div>
    
    <div class="col-12">
      <button class="btn btn-success" type="submit">Crear Solicitud</button>
      <button class="btn btn-outline-secondary" type="button" onclick="appLoad('service_requests/list.html')">Cancelar</button>
    </div>
  </form>
</div>

<script>
(async function() {
  // Cargar datos precargados desde sessionStorage
  const machineId = sessionStorage.getItem('selectedMachineId');
  const customerId = sessionStorage.getItem('selectedCustomerId');
  const machineSerial = sessionStorage.getItem('selectedMachineSerial');
  const machineNumber = sessionStorage.getItem('selectedMachineNumber');
  const customerName = sessionStorage.getItem('selectedCustomerName');
  const customerNit = sessionStorage.getItem('selectedCustomerNit');
  
  // Mostrar informaci√≥n precargada
  document.getElementById('preloaded-customer-name').textContent = customerName || 'N/A';
  document.getElementById('preloaded-customer-nit').textContent = customerNit ? `(NIT: ${customerNit})` : '';
  document.getElementById('preloaded-machine-serial').textContent = machineSerial || 'N/A';
  document.getElementById('preloaded-machine-number').textContent = machineNumber ? `(N√∫mero: ${machineNumber})` : '';
  
  // Establecer valores en campos ocultos
  if (machineId) document.getElementById('machine-id').value = machineId;
  if (customerId) document.getElementById('customer-id').value = customerId;
  
  // Cargar solicitudes anteriores para esta m√°quina
  if (machineId) {
    await loadPreviousRequests(machineId);
  }
  
  // Limpiar el sessionStorage despu√©s de usar los valores
  sessionStorage.removeItem('selectedMachineId');
  sessionStorage.removeItem('selectedCustomerId');
  sessionStorage.removeItem('selectedMachineSerial');
  sessionStorage.removeItem('selectedMachineNumber');
  sessionStorage.removeItem('selectedCustomerName');
  sessionStorage.removeItem('selectedCustomerNit');
})();

async function loadPreviousRequests(machineId) {
  try {
    const requests = await serviceRequestService.list();
    const machineRequests = requests.filter(r => r.machineId == machineId);
    
    const tbody = document.getElementById('previous-requests');
    const select = document.getElementById('repeated-request');
    
    if (machineRequests.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay solicitudes anteriores para esta m√°quina</td></tr>';
      return;
    }
    
    // Limpiar y llenar la tabla y el select
    tbody.innerHTML = '';
    select.innerHTML = '<option value="">No es una solicitud repetida</option>';
    
    machineRequests.forEach(request => {
      const date = request.reportedAt ? new Date(request.reportedAt).toLocaleDateString() : 'N/A';
      
      // Agregar a la tabla
      tbody.innerHTML += `
        <tr>
          <td>
            <input type="radio" name="selectedPreviousRequest" value="${request.id}" 
                   onchange="document.getElementById('repeated-request').value = this.value">
          </td>
          <td>${request.requestNumber || request.id}</td>
          <td>${date}</td>
          <td>${request.serviceType || 'N/A'}</td>
          <td>${request.rootCause || 'N/A'}</td>
          <td><span class="badge ${request.status === 'CERRADA' ? 'bg-success' : 'bg-warning'}">${request.status || 'N/A'}</span></td>
        </tr>
      `;
      
      // Agregar al select
      const option = document.createElement('option');
      option.value = request.id;
      option.textContent = `${request.requestNumber || request.id} - ${request.rootCause || 'Sin causa'} (${date})`;
      select.appendChild(option);
    });
    
  } catch (err) {
    console.error("Error cargando solicitudes anteriores:", err);
    document.getElementById('previous-requests').innerHTML = 
      '<tr><td colspan="6" class="text-center text-danger">Error cargando solicitudes anteriores</td></tr>';
  }
}

document.getElementById("form-new-request").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);
  
  // Agregar la fecha de asignaci√≥n autom√°ticamente
  //data.assignedAt = new Date().toISOString();
  
  try {
    await serviceRequestService.create(data);
    showAlert("Solicitud creada correctamente", "success");
    appLoad('service_requests/list.html');
  } catch(err) {
    showAlert("Error al crear: " + err.message, "danger");
  }
});
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\machines\service_requests.html =====
<div class="card p-3">
  <div class="d-flex justify-content-between mb-3 align-items-center">
    <h4 class="mb-0">Solicitudes de Servicio</h4>
    <div>
      <button class="btn btn-success btn-sm" id="btn-new-request">Crear Solicitud</button>
      <button class="btn btn-outline-secondary btn-sm" id="btn-refresh-req">Actualizar</button>
    </div>
  </div>
  <div class="table-responsive">
    <table class="table table-hover">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>N√∫mero</th>
          <th>M√°quina</th>
          <th>Cliente</th>
          <th>Tipo</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="requests-tbody">
        <tr><td colspan="7" class="text-center">Cargando...</td></tr>
      </tbody>
    </table>
  </div>
</div>
<script>
(async function renderRequests(){
  try {
    const machineId = sessionStorage.getItem("selectedMachineId");
    if(!machineId){
      showAlert("No se encontr√≥ m√°quina seleccionada", "danger");
      return;
    }

    const list = await serviceRequestService.byMachine(machineId).catch(()=>[]);
    const tbody = document.getElementById("requests-tbody");
    tbody.innerHTML='';

    if(!list || list.length===0){
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay solicitudes</td></tr>';
    } else {
      list.forEach(r=>{
        tbody.insertAdjacentHTML('beforeend', `<tr>
          <td>${r.id}</td>
          <td>${r.requestNumber||''}</td>
          <td>${r.companySerial||''}</td>
          <td>${r.customer?.name || r.customerId || ''}</td>
          <td>${r.serviceType||''}</td>
          <td><span class="badge ${r.status==='CERRADA'?'bg-success':'bg-warning'}">${r.status||''}</span></td>
          <td><button class="btn btn-sm btn-primary" onclick="appLoad('machines/detail.html?id='+r.machineId)">Ver</button></td>
        </tr>`);
      });
    }
  } catch(err){
    console.error(err);
    showAlert("Error cargando solicitudes", "danger");
  }
})();

document.getElementById('btn-new-request').addEventListener('click', () => {
  const machineId = sessionStorage.getItem("selectedMachineId");

  if (!machineId) {
    showAlert("No se encontr√≥ m√°quina seleccionada", "danger");
    return;
  }

  // Guardar datos en sessionStorage para precargar en new_machine_request.html
  sessionStorage.setItem("selectedMachineId", machineId);
  sessionStorage.setItem("selectedCustomerId", window.__CUSTOMER_ID || "");
  sessionStorage.setItem("selectedMachineSerial", window.__MACHINE_SERIAL || "");
  sessionStorage.setItem("selectedMachineNumber", window.__MACHINE_NUMBER || "");
  sessionStorage.setItem("selectedCustomerName", window.__CUSTOMER_NAME || "");
  sessionStorage.setItem("selectedCustomerNit", window.__CUSTOMER_NIT || "");

  // Navegar a la nueva p√°gina
  appLoad("service_requests/new_machine_request.html");
});
</script>


===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\machines\visit_form.html =====
<div class="card p-3">
  <h4>Registrar Visita</h4>
  <form id="form-visit" class="row g-3">
    <div class="col-md-6"><label class="form-label">Service Request ID *</label><input class="form-control" name="serviceRequestId" required></div>
    <div class="col-md-6"><label class="form-label">T√©cnico</label><input class="form-control" name="technicianId"></div>
    <div class="col-md-6"><label class="form-label">Inicio</label><input class="form-control" type="datetime-local" name="startTime"></div>
    <div class="col-md-6"><label class="form-label">Fin</label><input class="form-control" type="datetime-local" name="endTime"></div>
    <div class="col-12"><label class="form-label">Notas de visita</label><textarea class="form-control" name="visitNotes"></textarea></div>
    <div class="col-12"><button class="btn btn-success" type="submit">Registrar Visita</button></div>
  </form>
</div>

<script>
document.getElementById("form-visit").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));
  // adapt fields if backend expects other names
  try{ await serviceVisitService.create({ serviceRequestId: data.serviceRequestId, technicianId: data.technicianId, visitDatetime: data.startTime, startTime: data.startTime, endTime: data.endTime, visitNotes: data.visitNotes }); alert("Visita registrada"); appLoad('machines/service_requests.html'); }
  catch(err){ alert("Error: "+err.message); }
});
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\reports\generate.html =====
<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Generar Reporte</h4>
        <button class="btn btn-outline-secondary btn-sm" id="btn-refresh-reports">Actualizar</button>
    </div>

    <form id="report-form" class="row g-3 mb-4">
        <div class="col-md-4">
            <label class="form-label">Tipo de Reporte</label>
            <select class="form-select" id="report-type" required>
                <option value="cost">Costos</option>
                <option value="technician">T√©cnicos</option>
                <option value="machine">M√°quinas</option>
                <option value="service">Solicitudes</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Fecha Inicio</label>
            <input type="date" class="form-control" id="report-start-date" required>
        </div>
        <div class="col-md-3">
            <label class="form-label">Fecha Fin</label>
            <input type="date" class="form-control" id="report-end-date" required>
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-success w-100">
                <i class="fas fa-file-alt me-1"></i> Generar
            </button>
        </div>
    </form>

    <div>
        <h5>Historial de Reportes</h5>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th>Par√°metros</th>
                        <th>Archivo</th>
                    </tr>
                </thead>
                <tbody id="reports-tbody">
                    <tr>
                        <td colspan="4" class="text-center">Cargando reportes...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    async function loadReports() {
        try {
            const reports = await reportService.list();
            const tbody = document.getElementById("reports-tbody");
            tbody.innerHTML = "";

            if (reports && reports.length > 0) {
                reports.forEach(r => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${formatDate(r.generatedAt)}</td>
                            <td>${r.type}</td>
                            <td>${JSON.stringify(r.params)}</td>
                            <td><a href="${r.url}" target="_blank" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-download"></i> Descargar
                            </a></td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center">No hay reportes generados</td></tr>`;
            }
        } catch (error) {
            console.error("Error loading reports:", error);
            showAlert("Error cargando reportes", "danger");
        }
    }

    document.getElementById("report-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
            const type = document.getElementById("report-type").value;
            const startDate = document.getElementById("report-start-date").value;
            const endDate = document.getElementById("report-end-date").value;

            const report = await reportService.generate(type, {
                startDate: new Date(startDate),
                endDate: new Date(endDate)
            });

            if (report.url) {
                window.open(report.url, "_blank");
                showAlert("Reporte generado correctamente", "success");
                loadReports();
            } else {
                showAlert("Error generando reporte", "danger");
            }
        } catch (error) {
            console.error("Error generating report:", error);
            showAlert("Error generando reporte", "danger");
        }
    });

    document.getElementById("btn-refresh-reports").addEventListener("click", loadReports);

    document.addEventListener("DOMContentLoaded", () => {
        const end = new Date();
        const start = new Date();
        start.setMonth(start.getMonth() - 1);
        document.getElementById("report-start-date").value = start.toISOString().split("T")[0];
        document.getElementById("report-end-date").value = end.toISOString().split("T")[0];
        loadReports();
    });
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\service_requests\detail.html =====
<div class="card p-3">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h4 id="sr-title">Solicitud de Servicio</h4>
      <p class="text-muted" id="sr-sub">Detalle de solicitud</p>
    </div>
    <div>
      <button class="btn btn-success me-2" id="btn-create-visit">
        <i class="fas fa-plus me-1"></i> Crear Visita T√©cnica
      </button>
      <button class="btn btn-outline-secondary" onclick="appLoad('service_requests/list.html')">
        <i class="fas fa-arrow-left me-1"></i> Volver
      </button>
    </div>
  </div>

  <!-- Informaci√≥n b√°sica -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Informaci√≥n de la Solicitud</h6>
    </div>
    <div class="card-body">
      <table class="table table-sm">
        <tbody id="sr-info"></tbody>
      </table>
    </div>
  </div>

  <!-- Cliente -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Cliente Asociado</h6>
    </div>
    <div class="card-body">
      <table class="table table-sm">
        <tbody id="sr-customer"></tbody>
      </table>
    </div>
  </div>

  <!-- M√°quina -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">M√°quina Asociada</h6>
    </div>
    <div class="card-body">
      <table class="table table-sm">
        <tbody id="sr-machine"></tbody>
      </table>
    </div>
  </div>

  <!-- Visitas t√©cnicas -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Visitas T√©cnicas</h6>
    </div>
    <div class="card-body">
      <table class="table table-sm" id="sr-visits">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>T√©cnico</th>
            <th>Notas</th>
            <th>Resuelto</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
 (async function () {
    // Obtener el ID de la solicitud de la URL o sessionStorage
    const params = new URLSearchParams(location.search);
    const id = params.get("id") || sessionStorage.getItem("selectedRequestId");
    
    if (!id) {
      showAlert("ID de solicitud no especificado", "danger");
      return appLoad("service_requests/list.html");
    }

    // Guardar el ID para uso posterior
    sessionStorage.setItem("selectedRequestId", id);
    window.__SRID = id;

    try {
      const r = await serviceRequestService.get(id);
      if (!r) {
        showAlert("Solicitud no encontrada", "warning");
        return appLoad("service_requests/list.html");
      }

      document.getElementById("sr-title").innerText = "Solicitud #" + (r.requestNumber || r.id);
      document.getElementById("sr-sub").innerText = r.serviceType || "Solicitud de servicio";

      // Informaci√≥n b√°sica
      document.getElementById("sr-info").innerHTML = `
         <tr><th>ID</th><td>${r.id}</td></tr>
    <tr><th>N√∫mero</th><td>${r.requestNumber || "N/A"}</td></tr>
    <tr><th>Estado</th><td><span class="badge ${r.status === 'CERRADA' ? 'bg-success' : 'bg-warning'}">${r.status || 'N/A'}</span></td></tr>
    <tr><th>Tipo</th><td>${r.serviceType || "N/A"}</td></tr>
    <tr><th>Descripci√≥n</th><td>${r.description || "N/A"}</td></tr>
    <tr><th>Causa ra√≠z</th><td>
        ${r.rootCauseName ? 
            `<strong>${r.rootCauseName}</strong>` : 
            (r.rootCause || "N/A")
        }
        ${r.rootCauseCategory ? `<br><small class="text-muted">${r.rootCauseCategory}</small>` : ''}
    </td></tr>
`;

      // Cliente
      if (r.customerId) {
        try {
          const c = await customerService.get(r.customerId);
          document.getElementById("sr-customer").innerHTML = c ? `
            <tr><th>Nombre</th><td>${c.name || 'N/A'}</td></tr>
            <tr><th>Contacto</th><td>${c.contactName || 'N/A'}</td></tr>
            <tr><th>Tel√©fono</th><td>${c.phone || 'N/A'}</td></tr>
            <tr><th>Email</th><td>${c.email || 'N/A'}</td></tr>
          ` : `<tr><td colspan="2">Cliente no disponible</td></tr>`;
        } catch (err) {
          document.getElementById("sr-customer").innerHTML = `<tr><td colspan="2">Error cargando cliente</td></tr>`;
        }
      } else {
        document.getElementById("sr-customer").innerHTML = `<tr><td colspan="2">No hay cliente asociado</td></tr>`;
      }

      // M√°quina
      if (r.machineId) {
        try {
          const m = await machineService.get(r.machineId);
          document.getElementById("sr-machine").innerHTML = m ? `
            <tr><th>Serial</th><td>${m.companySerial || "N/A"}</td></tr>
            <tr><th>Modelo</th><td>${m.model || "N/A"}</td></tr>
            <tr><th>Marca</th><td>${m.brand || "N/A"}</td></tr>
            <tr><th>Estado</th><td>${m.status || "N/A"}</td></tr>
          ` : `<tr><td colspan="2">M√°quina no disponible</td></tr>`;
        } catch (err) {
          document.getElementById("sr-machine").innerHTML = `<tr><td colspan="2">Error cargando m√°quina</td></tr>`;
        }
      } else {
        document.getElementById("sr-machine").innerHTML = `<tr><td colspan="2">No hay m√°quina asociada</td></tr>`;
      }

      // Visitas t√©cnicas
      await loadVisits(id);

      // Configurar bot√≥n de crear visita
      document.getElementById("btn-create-visit").onclick = () => {
        console.log("Crear visita para solicitud:", id);
        sessionStorage.setItem("selectedRequestId", id);
        appLoad("service_visits/new.html");
      };

    } catch (err) {
      console.error("Error cargando solicitud:", err);
      showAlert("Error cargando detalles de la solicitud: " + err.message, "danger");
    }
  })();

  async function loadVisits(requestId) {
  try {
    const visits = await serviceVisitService.byRequest(requestId);
    const tbody = document.querySelector("#sr-visits tbody");
     

    console.log("Visitas recibidas:", visits);

    if (visits && visits.length > 0) {
      // Obtener todos los nombres de t√©cnicos en paralelo
      const technicianPromises = visits.map(v => 
        v.technicianId ? technicianService.get(v.technicianId) : null
      );
      const technicians = await Promise.all(technicianPromises);

      tbody.innerHTML = visits.map((v, i) => {
        const tech = technicians[i];
        const techName = tech ? tech.fullName || "T√©cnico desconocido" : "-";
        return `
          <tr>
            <td>${v.visitDatetime ? new Date(v.visitDatetime).toLocaleString() : "-"}</td>
            <td>${techName}</td>
            <td>${v.visitNotes || "-"}</td>
            <td>${v.solved ? "‚úÖ S√≠" : "‚ùå No"}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" 
                      onclick="editVisit(${v.id})">
                <i class="fas fa-edit"></i> Editar
              </button>
            </td>
          </tr>
        `;
      }).join("");
    } else {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No hay visitas registradas</td></tr>`;
    }
  } catch (err) {
    console.error("Error cargando visitas:", err);
    document.querySelector("#sr-visits tbody").innerHTML = 
      `<tr><td colspan="5" class="text-center text-warning">Error cargando visitas</td></tr>`;
  }
}
 function editVisit(visitId) {
  console.log("Editando visita ID:", visitId);
    sessionStorage.setItem("selectedVisitId", visitId);
    appLoad("service_visits/edit.html");
}
</script>

<style>
    /* Para la causa ra√≠z en el detalle */
    .root-cause-display {
        font-weight: 500;
        color: #0d6efd;
    }
    
    .root-cause-category {
        font-size: 0.85em;
        color: #6c757d;
    }
    
    /* Para el formulario de edici√≥n */
    #current-root-cause .alert {
        background-color: #e7f3ff;
        border-color: #b6d4fe;
        color: #084298;
    }
</style>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\service_requests\list.html =====
<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Solicitudes de Servicio</h4>
        <button class="btn btn-success btn-sm" onclick="appLoad('service_requests/new.html')">
            <i class="fas fa-plus me-1"></i> Nueva Solicitud
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Cliente</th>
                    <th>M√°quina</th>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody id="requests-table">
                <tr>
                    <td colspan="7" class="text-center text-muted">Cargando solicitudes...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    (async function () {
        const tbody = document.getElementById("requests-table");

        try {
            // üëâ Definir caches globales para no re-declarar
            if (!window.customersCache || window.customersCache.length === 0) {
                window.customersCache = await customerService.list();
            }

            if (!window.machinesCache || window.machinesCache.length === 0) {
                window.machinesCache = await machineService.list();
            }

            const requests = await serviceRequestService.list();

            if (!requests || requests.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No hay solicitudes registradas</td></tr>`;
                return;
            }

            tbody.innerHTML = "";
            for (const r of requests) {
                const date = r.reportedAt ? new Date(r.reportedAt).toLocaleDateString() : "N/A";

                // Buscar cliente y m√°quina en caches
                const customer = window.customersCache.find(c => c.id === r.customerId);
                const machine = window.machinesCache.find(m => m.id === r.machineId);

                tbody.innerHTML += `
                    <tr>
                        <td>${r.requestNumber || r.id}</td>
                        <td>${customer ? customer.name : "Cliente N/A"}</td>
                        <td>${machine ? machine.companySerial : "M√°quina N/A"}</td>
                        <td>${date}</td>
                        <td>${r.serviceType || "N/A"}</td>
                        <td>
                          <span class="badge ${getStatusBadgeClass(r.status)}">
                          ${r.status}
                        </span>
                        </td>
                        <td class="text-end">
                            <button class="btn btn-outline-primary btn-sm me-1" onclick="viewRequest(${r.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm me-1" onclick="editRequest(${r.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteRequest(${r.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }
        } catch (err) {
            console.error("Error cargando solicitudes:", err);
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error cargando solicitudes</td></tr>`;
        }
    })();

    function viewRequest(id) {
        sessionStorage.setItem("selectedRequestId", id);
        appLoad("service_requests/detail.html");
    }

    function editRequest(id) {
        sessionStorage.setItem("selectedRequestId", id);
        appLoad("service_requests/edit.html");
    }

    async function deleteRequest(id) {
        if (!confirm("¬øSeguro que deseas eliminar esta solicitud?")) return;
        try {
            await serviceRequestService.remove(id);
            showAlert("Solicitud eliminada correctamente", "success");
            appLoad("service_requests/list.html");
        } catch (err) {
            showAlert("Error al eliminar: " + err.message, "danger");
        }
    }
    function getStatusBadgeClass(status) {
        switch (status) {
            case "EN_PROCESO":
                return "bg-warning text-dark"; // amarillo

            case "abierto":
                return "bg-orange text-white"; // naranja

            case "resuelto":
                return "bg-success"; // verde

            default:
                return "bg-secondary";
        }
    }

</script>

<style>
    .bg-orange {
        background-color: #ff8c00 !important;
        color: white !important;
    }
</style>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\service_requests\new.html =====
<div class="card p-3">
  <h4>Nueva Solicitud</h4>

  <!-- Informaci√≥n precargada (solo lectura) -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Informaci√≥n Precargada</h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <strong>Cliente:</strong>
          <span id="preloaded-customer-name"></span>
          <small id="preloaded-customer-nit" class="text-muted"></small>
        </div>
        <div class="col-md-6">
          <strong>M√°quina:</strong>
          <span id="preloaded-machine-serial"></span>
          <small id="preloaded-machine-number" class="text-muted"></small>
        </div>
      </div>
    </div>
  </div>

  <!-- Historial de solicitudes para esta m√°quina -->
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h6 class="mb-0">Solicitudes Anteriores de esta M√°quina</h6>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Seleccionar</th>
              <th>N√∫mero</th>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Causa Ra√≠z</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="previous-requests">
            <tr>
              <td colspan="6" class="text-center">Cargando solicitudes anteriores...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Formulario para completar -->
  <form id="form-new-request" class="row g-3">
    <input type="hidden" name="machineId" id="machine-id">
    <input type="hidden" name="customerId" id="customer-id">

    <div class="col-md-6">
      <label class="form-label">Canal *</label>
      <select name="reportedChannel" class="form-select" required>
        <option value="">Seleccione un canal</option>
        <option value="telefono">Tel√©fono</option>
        <option value="whatsapp">WhatsApp</option>
        <option value="email">Email</option>
        <option value="portal">Portal</option>
      </select>
    </div>

    <div class="col-md-6">
      <label class="form-label">Tipo de Servicio *</label>
      <select name="serviceType" class="form-select" required>
        <option value="">Seleccione un tipo</option>
        <option value="servicio_tecnico">Servicio T√©cnico</option>
        <option value="lectura_contador">Lectura de contador</option>
        <option value="remoto">Remoto</option>
        <option value="otro">otro</option>
      </select>
    </div>

    <div class="col-12">
      <label class="form-label">Causa Ra√≠z *</label>
      <select class="form-select" name="rootCauseId" id="root-cause-select" required>
        <option value="">Seleccione una causa ra√≠z</option>
        <!-- Las opciones se cargar√°n con JavaScript -->
      </select>
      <div id="root-cause-categories" class="mt-2"></div>
    </div>

    <div class="col-12">
      <label class="form-label">Descripci√≥n *</label>
      <textarea class="form-control" name="description" rows="3" required></textarea>
    </div>

    <div class="col-12">
      <label class="form-label">Solicitud repetida de (opcional)</label>
      <select name="repeatedOfRequestId" class="form-select" id="repeated-request">
        <option value="">No es una solicitud repetida</option>
        <!-- Las opciones se llenar√°n con JavaScript -->
      </select>
    </div>

    <div class="col-12">
      <button class="btn btn-success" type="submit">Crear Solicitud</button>
      <button class="btn btn-outline-secondary" type="button"
        onclick="appLoad('service_requests/list.html')">Cancelar</button>
    </div>
  </form>
</div>

<script>
  (async function () {
    // Cargar datos precargados desde sessionStorage
    const machineId = sessionStorage.getItem('selectedMachineId');
    const customerId = sessionStorage.getItem('selectedCustomerId');
    const machineSerial = sessionStorage.getItem('selectedMachineSerial');
    const machineNumber = sessionStorage.getItem('selectedMachineNumber');
    const customerName = sessionStorage.getItem('selectedCustomerName');
    const customerNit = sessionStorage.getItem('selectedCustomerNit');

    // Mostrar informaci√≥n precargada
    document.getElementById('preloaded-customer-name').textContent = customerName || 'N/A';
    document.getElementById('preloaded-customer-nit').textContent = customerNit ? `(NIT: ${customerNit})` : '';
    document.getElementById('preloaded-machine-serial').textContent = machineSerial || 'N/A';
    document.getElementById('preloaded-machine-number').textContent = machineNumber ? `(N√∫mero: ${machineNumber})` : '';

    // Establecer valores en campos ocultos
    if (machineId) document.getElementById('machine-id').value = machineId;
    if (customerId) document.getElementById('customer-id').value = customerId;

    // Cargar solicitudes anteriores para esta m√°quina
    if (machineId) {
      await loadPreviousRequests(machineId);
    }

    await loadRootCauses();

    // Limpiar el sessionStorage despu√©s de usar los valores
    sessionStorage.removeItem('selectedMachineId');
    sessionStorage.removeItem('selectedCustomerId');
    sessionStorage.removeItem('selectedMachineSerial');
    sessionStorage.removeItem('selectedMachineNumber');
    sessionStorage.removeItem('selectedCustomerName');
    sessionStorage.removeItem('selectedCustomerNit');
  })();

  async function loadPreviousRequests(machineId) {
    try {
      const requests = await serviceRequestService.list();
      const machineRequests = requests.filter(r => r.machineId == machineId);

      const tbody = document.getElementById('previous-requests');
      const select = document.getElementById('repeated-request');

      if (machineRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay solicitudes anteriores para esta m√°quina</td></tr>';
        return;
      }

      // Limpiar y llenar la tabla y el select
      tbody.innerHTML = '';
      select.innerHTML = '<option value="">No es una solicitud repetida</option>';

      machineRequests.forEach(request => {
        const date = request.reportedAt ? new Date(request.reportedAt).toLocaleDateString() : 'N/A';

        // Agregar a la tabla
        tbody.innerHTML += `
        <tr>
          <td>
            <input type="radio" name="selectedPreviousRequest" value="${request.id}" 
                   onchange="document.getElementById('repeated-request').value = this.value">
          </td>
          <td>${request.requestNumber || request.id}</td>
          <td>${date}</td>
          <td>${request.serviceType || 'N/A'}</td>
          <td>${request.rootCause || 'N/A'}</td>
          <td><span class="badge ${request.status === 'CERRADA' ? 'bg-success' : 'bg-warning'}">${request.status || 'N/A'}</span></td>
        </tr>
      `;

        // Agregar al select
        const option = document.createElement('option');
        option.value = request.id;
        option.textContent = `${request.requestNumber || request.id} - ${request.rootCause || 'Sin causa'} (${date})`;
        select.appendChild(option);
      });

    } catch (err) {
      console.error("Error cargando solicitudes anteriores:", err);
      document.getElementById('previous-requests').innerHTML =
        '<tr><td colspan="6" class="text-center text-danger">Error cargando solicitudes anteriores</td></tr>';
    }
  }


  async function loadRootCauses() {
    console.log("üîç Intentando cargar causas ra√≠z...");

    try {
      // Usa el servicio que definimos
      const groupedCauses = await rootCauseService.getGrouped();
      console.log("‚úÖ Causas ra√≠z recibidas:", groupedCauses);

      const select = document.getElementById('root-cause-select');
      const categoriesDiv = document.getElementById('root-cause-categories');

      // Limpiar select
      select.innerHTML = '<option value="">Seleccione una causa ra√≠z</option>';

      // Si no hay datos, mostrar mensaje
      if (!groupedCauses || Object.keys(groupedCauses).length === 0) {
        categoriesDiv.innerHTML = '<div class="alert alert-warning">No hay causas ra√≠z configuradas</div>';
        return;
      }

      // Crear botones de categor√≠as
      let categoriesHtml = '<div class="btn-group flex-wrap" role="group">';
      for (const [category, causes] of Object.entries(groupedCauses)) {
        categoriesHtml += `
        <button type="button" class="btn btn-outline-secondary btn-sm m-1" 
                onclick="filterRootCauses('${category}')">
          ${category}
        </button>
      `;
      }
      categoriesHtml += '</div>';
      categoriesDiv.innerHTML = categoriesHtml;

      // Almacenar todas las causas para filtrado
      window.allRootCauses = [];
      for (const [category, causes] of Object.entries(groupedCauses)) {
        causes.forEach(cause => {
          window.allRootCauses.push({
            id: cause.id,
            name: cause.name,
            category: category
          });

          // Agregar al select
          const option = document.createElement('option');
          option.value = cause.id;
          option.textContent = `${category} - ${cause.name}`;
          option.setAttribute('data-category', category);
          select.appendChild(option);
        });
      }

    } catch (err) {
      console.error("‚ùå Error cargando causas ra√≠z:", err);

      // Mostrar mensaje de error en la interfaz
      const categoriesDiv = document.getElementById('root-cause-categories');
      if (categoriesDiv) {
        categoriesDiv.innerHTML = `
        <div class="alert alert-danger">
          <strong>Error cargando causas ra√≠z:</strong><br>
          ${err.message}<br>
          <small>Verificando endpoints...</small>
        </div>
      `;
      }

      // Intentar cargar datos hardcodeados como respaldo
      loadHardcodedRootCauses();
    }
  }

  // Funci√≥n de respaldo con datos hardcodeados
  function loadHardcodedRootCauses() {
    console.log("‚ö†Ô∏è Cargando causas ra√≠z hardcodeadas...");

    const groupedCauses = {
      "CONTADORES / LECTURAS": [
        { id: 1, name: "CONTADOR", category: "CONTADORES / LECTURAS" },
        { id: 2, name: "TOMA DE CONTADORES", category: "CONTADORES / LECTURAS" },
        { id: 3, name: "LECTURA DE CONTADOR", category: "CONTADORES / LECTURAS" },
        { id: 4, name: "CONTADORES", category: "CONTADORES / LECTURAS" },
        { id: 5, name: "CONTADOR INICIAL", category: "CONTADORES / LECTURAS" }
      ],
      "TONER / TINTA": [
        { id: 6, name: "RECARGA TONER / DE TONER", category: "TONER / TINTA" },
        { id: 7, name: "REVISI√ìN / REVISION / REVICION DE TONER", category: "TONER / TINTA" },
        { id: 8, name: "TONER", category: "TONER / TINTA" },
        { id: 9, name: "CARGA DE TONER", category: "TONER / TINTA" },
        { id: 10, name: "CAMBIO DE TONER", category: "TONER / TINTA" }
      ]
    };

    const select = document.getElementById('root-cause-select');
    const categoriesDiv = document.getElementById('root-cause-categories');

    // Limpiar select
    select.innerHTML = '<option value="">Seleccione una causa ra√≠z</option>';

    // Crear botones de categor√≠as
    let categoriesHtml = '<div class="btn-group flex-wrap" role="group">';
    for (const [category, causes] of Object.entries(groupedCauses)) {
      categoriesHtml += `
      <button type="button" class="btn btn-outline-secondary btn-sm m-1" 
              onclick="filterRootCauses('${category}')">
        ${category}
      </button>
    `;

      causes.forEach(cause => {
        // Almacenar para filtrado
        if (!window.allRootCauses) window.allRootCauses = [];
        window.allRootCauses.push(cause);

        // Agregar al select
        const option = document.createElement('option');
        option.value = cause.id;
        option.textContent = `${category} - ${cause.name}`;
        option.setAttribute('data-category', category);
        select.appendChild(option);
      });
    }
    categoriesHtml += '</div>';

    if (categoriesDiv) {
      categoriesDiv.innerHTML = `
      ${categoriesHtml}
      <div class="alert alert-info mt-2">
        <small>‚ö†Ô∏è Usando datos de prueba. Verifica que el endpoint /root-causes/grouped est√© disponible.</small>
      </div>
    `;
    }

    console.log("‚úÖ Causas ra√≠z hardcodeadas cargadas");
  }









  document.getElementById("form-new-request").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);


    // Convertir rootCauseId a n√∫mero si existe
    if (data.rootCauseId) {
      data.rootCauseId = parseInt(data.rootCauseId);
    }


    // Agregar la fecha de asignaci√≥n autom√°ticamente
    //data.assignedAt = new Date().toISOString();

    console.log("üì§ Enviando datos:", data);

    try {
      const result = await serviceRequestService.create(data);
      console.log("‚úÖ Solicitud creada:", result);
      showAlert("Solicitud creada correctamente", "success");
      setTimeout(() => {
        appLoad('service_requests/list.html');
      }, 1500);
    } catch (err) {
      console.error("‚ùå Error al crear:", err);
      showAlert("Error al crear: " + err.message, "danger");
    }
  });







</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\service_visits\edit.html =====
<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Editar Visita T√©cnica</h4>
    <button class="btn btn-outline-secondary btn-sm" onclick="appLoad('service_requests/detail.html')">
      <i class="fas fa-arrow-left me-1"></i> Volver a Solicitud
    </button>
  </div>

  <!-- Informaci√≥n de la Solicitud Asociada -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Solicitud de Servicio Asociada</h6>
    </div>
    <div class="card-body">
      <div class="row" id="request-info">
        <div class="col-md-6">
          <strong>T√©cnico:</strong> <span id="request-technician">Cargando...</span><br>
          <strong>Solicitud #:</strong> <span id="request-number">Cargando...</span><br>
          <strong>Cliente:</strong> <span id="request-customer">Cargando...</span><br>
          <strong>M√°quina:</strong> <span id="request-machine">Cargando...</span>
        </div>
        <div class="col-md-6">
          <strong>Tipo de Servicio:</strong> <span id="request-type">Cargando...</span><br>
          <strong>Causa Ra√≠z:</strong> <span id="request-rootcause">Cargando...</span><br>
          <strong>Estado Actual:</strong> <span id="request-status">Cargando...</span>
        </div>
      </div>
    </div>
  </div>
  <input type="hidden" id="machine-id" name="machineId">
  <!-- Formulario de edici√≥n -->
  <form id="visit-form" class="row g-3" novalidate>
    <input type="hidden" name="serviceRequestId" id="service-request-id">

    <div class="col-md-6">
      <label class="form-label">T√©cnico asignado</label>
      <input type="text" class="form-control" id="technician-input" readonly>
      <input type="hidden" name="technicianId" id="technician-id">
    </div>

    <div class="col-md-6">
      <label class="form-label">Fecha y Hora de la Visita</label>
      <input type="datetime-local" class="form-control" name="visitDatetime" id="visit-datetime" required>
    </div>

    <div class="col-md-6">
      <label class="form-label">Hora de Inicio</label>
      <input type="datetime-local" class="form-control" name="startTime" id="start-time">
      <div class="form-text">Cuando el t√©cnico comenz√≥ la intervenci√≥n</div>
    </div>

    <div class="col-md-6">
      <label class="form-label">Hora de Finalizaci√≥n</label>
      <input type="datetime-local" class="form-control" name="endTime" id="end-time">
      <div class="form-text">Cuando el t√©cnico termin√≥ la intervenci√≥n</div>
    </div>

    <!-- Secci√≥n para mostrar tiempos ya registrados (si existen) -->
    <div id="existing-times-section" style="display:none" class="col-12 mb-3">
      <div class="card bg-light">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-lock me-2"></i>Tiempos ya registrados</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <strong>Inicio:</strong> <span id="existing-start-time"></span>
            </div>
            <div class="col-md-6">
              <strong>Fin:</strong> <span id="existing-end-time"></span>
            </div>
            <div class="col-12 mt-2">
              <strong>Duraci√≥n:</strong> <span id="existing-duration"></span>
            </div>
          </div>
        </div>
      </div>
    </div>



    <div class="col-12">
      <label class="form-label">Notas de la Visita</label>
      <textarea class="form-control" name="visitNotes" id="visit-notes" rows="4"></textarea>
    </div>


    <!-- Causa Ra√≠z -->
    <div class="col-12">
      <label class="form-label">Causa Ra√≠z (Diagn√≥stico)</label>
      <select class="form-select" name="rootCauseId" id="root-cause-select">
        <option value="">Seleccione una causa ra√≠z (opcional)</option>
        <!-- Las opciones se cargar√°n con JavaScript -->
      </select>
      <div id="root-cause-categories" class="mt-2"></div>

      <!-- Mostrar causa ra√≠z actual si existe -->
      <div id="current-root-cause" class="mt-2" style="display: none;">
        <div class="alert alert-info p-2">
          <small>
            <strong>Causa ra√≠z actual:</strong>
            <span id="current-root-cause-text"></span>
          </small>
        </div>
      </div>
    </div>
    <!-- Lectura existente (solo si hay meterReading) -->
    <div id="existing-meter-section" style="display:none" class="mb-3">
      <div class="card bg-light">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-lock me-2"></i>Lectura del Contador Existente</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <strong>Lectura:</strong> <span id="existing-reading-value"></span>
            </div>
            <div class="col-md-6">
              <strong>Notas:</strong> <span id="existing-reading-notes"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lectura del contador -->
    <div class="col-12">
      <div class="card" id="meter-reading-card">
        <div class="card-header">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chk-meter" name="takeMeterReading">
            <label class="form-check-label" for="chk-meter">
              <strong>¬øSe tom√≥ lectura del contador?</strong>
            </label>
          </div>
        </div>
        <div class="card-body" id="meter-fields" style="display:none">
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">Lectura Blanco/Negro</label>
              <input type="number" class="form-control" name="reading" id="meter-reading" min="0">
            </div>

            <div class="col-md-6">
              <label class="form-label">Lectura Color</label>
              <input type="number" class="form-control" name="colorReading" id="color-reading" min="0">
            </div>
            <div class="col-md-6 mt-3">
              <label class="form-label">Lectura Scanner</label>
              <input type="number" class="form-control" name="scannerReading" id="scanner-reading" min="0">
            </div>

            <div class="col-md-6 mt-3">
              <label class="form-label">Notas de la lectura</label>
              <input type="text" class="form-control" name="readingNotes" id="reading-notes"
                placeholder="Observaciones sobre la lectura">
            </div>


          </div>
        </div>
      </div>
    </div>

    <!-- Lectura de niveles de toner -->
    <div class="col-12">
      <div class="card" id="toner-reading-card">
        <div class="card-header">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chk-toner" name="takeTonerReading">
            <label class="form-check-label" for="chk-toner">
              <strong>¬øSe tom√≥ lectura de niveles de toner?</strong>
            </label>
          </div>
        </div>
        <div class="card-body" id="toner-fields" style="display:none">
          <div class="row">
            <div class="col-md-3">
              <label class="form-label">Nivel K (Negro)</label>
              <input type="number" class="form-control" name="tonerLevelK" id="toner-level-k" min="0" max="100"
                placeholder="0-100%">
              <div class="form-text">0% = vac√≠o, 100% = lleno</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Nivel C (Cian)</label>
              <input type="number" class="form-control" name="tonerLevelC" id="toner-level-c" min="0" max="100"
                placeholder="0-100%">
            </div>
            <div class="col-md-3">
              <label class="form-label">Nivel M (Magenta)</label>
              <input type="number" class="form-control" name="tonerLevelM" id="toner-level-m" min="0" max="100"
                placeholder="0-100%">
            </div>
            <div class="col-md-3">
              <label class="form-label">Nivel Y (Amarillo)</label>
              <input type="number" class="form-control" name="tonerLevelY" id="toner-level-y" min="0" max="100"
                placeholder="0-100%">
            </div>
            <div class="col-12 mt-3">
              <label class="form-label">Notas sobre niveles de toner</label>
              <input type="text" class="form-control" name="tonerNotes" id="toner-notes"
                placeholder="Observaciones sobre los niveles de toner">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lectura existente de toner (solo si hay tonerReading) -->
    <div id="existing-toner-section" style="display:none" class="mb-3">
      <div class="card bg-light">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-lock me-2"></i>Lectura de Toner Existente</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <strong>K (Negro):</strong> <span id="existing-toner-k"></span>%
            </div>
            <div class="col-md-3">
              <strong>C (Cian):</strong> <span id="existing-toner-c"></span>%
            </div>
            <div class="col-md-3">
              <strong>M (Magenta):</strong> <span id="existing-toner-m"></span>%
            </div>
            <div class="col-md-3">
              <strong>Y (Amarillo):</strong> <span id="existing-toner-y"></span>%
            </div>
            <div class="col-12 mt-2">
              <strong>Notas:</strong> <span id="existing-toner-notes"></span>
            </div>
          </div>
        </div>
      </div>
    </div>



    <!-- Estado de resoluci√≥n -->
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="solved" id="solved">
            <label class="form-check-label" for="solved">
              <strong>¬øSolicitud resuelta?</strong>
            </label>
          </div>
        </div>
        <div class="card-body" id="resolution-fields" style="display:none">
          <div class="mb-2">
            <label class="form-label">Descripci√≥n de la soluci√≥n</label>
            <textarea class="form-control" name="resolution" rows="3"
              placeholder="Describa c√≥mo se resolvi√≥ el problema"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Repuestos utilizados -->
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chk-parts">
            <label class="form-check-label" for="chk-parts">
              <strong>¬øSe utilizaron repuestos?</strong>
            </label>
          </div>
        </div>
        <div class="card-body" id="parts-container" style="display:none">
          <div id="parts-list">
            <!-- Los repuestos se a√±adir√°n aqu√≠ din√°micamente -->
          </div>
          <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btn-add-part">
            <i class="fas fa-plus me-1"></i> A√±adir otro repuesto
          </button>
        </div>
      </div>
    </div>

    <!-- Repuestos ya existentes -->
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Repuestos ya registrados en esta visita</h6>
        </div>
        <div class="card-body">
          <div id="existing-parts-list">
            <p class="text-muted">Cargando repuestos existentes...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <button class="btn btn-success" type="submit" id="btn-save">
        <i class="fas fa-save me-1"></i> Actualizar Visita
      </button>
      <button class="btn btn-outline-secondary" type="button" onclick="appLoad('service_requests/detail.html')">
        <i class="fas fa-times me-1"></i> Cancelar
      </button>
    </div>
  </form>
</div>

<script>
  (async function initEditVisit() {


    const API = API_BASE.replace(/\/$/, '');
    const visitId = sessionStorage.getItem("selectedVisitId");
    const requestId = sessionStorage.getItem("selectedRequestId");

    const chkMeter = document.getElementById("chk-meter");
    const meterFields = document.getElementById("meter-fields");
    const chkParts = document.getElementById("chk-parts");
    const partsContainer = document.getElementById("parts-container");
    const partsList = document.getElementById("parts-list");
    const btnAddPart = document.getElementById("btn-add-part");
    const existingPartsList = document.getElementById("existing-parts-list");
    const chkSolved = document.getElementById("solved");
    const resolutionFields = document.getElementById("resolution-fields");

    if (!visitId || !requestId) {
      showAlert("No se encontr√≥ la visita seleccionada.", "danger");
      return appLoad("service_requests/list.html");
    }

    // Toggle lectura
    chkMeter.addEventListener("change", e => {
      meterFields.style.display = e.target.checked ? "block" : "none";
    });

    // Toggle resoluci√≥n
    chkSolved.addEventListener("change", e => {
      resolutionFields.style.display = e.target.checked ? "block" : "none";
    });

    // Toggle lectura de toner
    const chkToner = document.getElementById("chk-toner");
    const tonerFields = document.getElementById("toner-fields");
    const existingTonerSection = document.getElementById("existing-toner-section");

    chkToner.addEventListener("change", e => {
      tonerFields.style.display = e.target.checked ? "block" : "none";
    });

    // Toggle repuestos
    chkParts.addEventListener("change", e => {
      partsContainer.style.display = e.target.checked ? "block" : "none";
      if (e.target.checked && partsList.children.length === 0) {
        addPartSelector();
      }
    });

    // A√±adir selector de repuestos
    btnAddPart.addEventListener("click", addPartSelector);

    // Funci√≥n para a√±adir un selector de repuestos
    async function addPartSelector() {
      try {
        const res = await fetch(`${API}/parts`);
        const parts = (await res.json()).data || [];

        const partItem = document.createElement("div");
        partItem.classList.add("part-item", "mb-2", "p-2", "border", "rounded");

        partItem.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <select class="form-select part-select" name="partId" required>
            <option value="">-- Seleccione repuesto --</option>
            ${parts.map(p => `<option value="${p.id}">${p.name} (${p.sku || 'N/A'}) - Stock: ${p.stock || 0}</option>`).join('')}
          </select>
          <input type="number" class="form-control" name="quantity" placeholder="Cantidad" min="1" value="1" style="width: 100px;">
          <button type="button" class="btn btn-sm btn-outline-danger remove-part">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;

        partsList.appendChild(partItem);

        // A√±adir evento para eliminar repuesto
        partItem.querySelector('.remove-part').addEventListener('click', function () {
          partItem.remove();
        });
      } catch (error) {
        console.error("Error cargando repuestos:", error);
        showAlert("Error al cargar la lista de repuestos", "danger");
      }
    }

    // Cargar lista de t√©cnicos

    // Cargar informaci√≥n del service-request
    async function loadRequestInfo() {
      try {
        const req = await serviceRequestService.get(requestId);
        document.getElementById("service-request-id").value = req.id;
        document.getElementById("request-number").textContent = req.requestNumber || req.id;
        document.getElementById("request-type").textContent = req.serviceType || "N/A";
        document.getElementById("request-rootcause").textContent = req.rootCause || "N/A";
        document.getElementById("request-status").textContent = req.status || "N/A";

        if (req.customerId) {
          const cust = await customerService.get(req.customerId);
          document.getElementById("request-customer").textContent = cust?.name || "N/A";
        }

        if (req.machineId) {
          const mach = await machineService.get(req.machineId);
          document.getElementById("request-machine").textContent =
            mach ? `${mach.brand || ''} ${mach.model || ''} (${mach.companySerial || 'N/A'})` : "N/A";
        }
      } catch (err) {
        console.error("Error cargando request:", err);
        showAlert("Error al cargar informaci√≥n de la solicitud", "danger");
      }
    }

    // Cargar datos de la visita
    async function loadVisitData() {
      try {
        const res = await fetch(`${API}/visits/request/${requestId}`)
        if (res.ok) {

          const json = await res.json();
          const visits = json.data || json;
          const visit = visits.find(v => v.id === parseInt(visitId));

          if (!visit) {
            console.warn("‚ö†Ô∏è No se encontr√≥ la visita con ID", visitId);
            return;
          }



          console.log("üëâ Visita cargada:", visit); // üëà ver todo el objeto
          console.log("üëâ TechnicianId recibido:", visit.technicianId);
          // Llenar formulario con datos existentes
          document.getElementById("visit-notes").value = visit.visitNotes || "";
          document.getElementById("visit-datetime").value = visit.visitDatetime ?
            new Date(visit.visitDatetime).toISOString().slice(0, 16) :
            new Date().toISOString().slice(0, 16);

          console.log("üëâ meterReading object:", visit.meterReading);
          console.log("üëâ Todas las propiedades de visit:", Object.keys(visit));

          if (visit.reading || visit.colorReading || visit.scannerReading) {
            // Mostrar el bloque de la card
            meterFields.style.display = "block";

            // Rellenar los valores
            // ---- LECTURA B/N ----
            if (visit.reading) {
              document.getElementById("meter-reading").value = visit.reading;
            }
            document.getElementById("meter-reading").readOnly = true;

            // ---- LECTURA COLOR ----
            if (visit.colorReading) {
              document.getElementById("color-reading").value = visit.colorReading;
            }
            document.getElementById("color-reading").readOnly = true;

            // ---- LECTURA SCANNER ----
            if (visit.scannerReading) {
              document.getElementById("scanner-reading").value = visit.scannerReading;
            }
            document.getElementById("scanner-reading").readOnly = true;

            // ---- NOTAS ----
            if (visit.readingNotes) {
              document.getElementById("reading-notes").value = visit.readingNotes;
            }
            document.getElementById("reading-notes").readOnly = true;

            // El checkbox se deshabilita (queda apagado y sin posibilidad de marcar)
            chkMeter.checked = false;
            chkMeter.disabled = true;

            // (Opcional) agregar un aviso visual
            /* const badge = document.createElement("span");
             badge.className = "badge bg-info ms-2";
             badge.textContent = "Lectura registrada (bloqueada)";
             chkMeter.closest(".card-header").appendChild(badge);*/

          }

          // En la funci√≥n loadVisitData(), despu√©s de cargar otros datos:
          if (visit.startTime || visit.endTime) {
            // Mostrar secci√≥n de tiempos existentes
            const existingTimesSection = document.getElementById("existing-times-section");
            existingTimesSection.style.display = "block";

            // Formatear y mostrar tiempos existentes
            if (visit.startTime) {
              const startTime = new Date(visit.startTime);
              document.getElementById("existing-start-time").textContent =
                startTime.toLocaleString('es-CO', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                });

              // Bloquear campo de entrada
              document.getElementById("start-time").value = startTime.toISOString().slice(0, 16);
              document.getElementById("start-time").readOnly = true;
            }

            if (visit.endTime) {
              const endTime = new Date(visit.endTime);
              document.getElementById("existing-end-time").textContent =
                endTime.toLocaleString('es-CO', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                });

              // Bloquear campo de entrada
              document.getElementById("end-time").value = endTime.toISOString().slice(0, 16);
              document.getElementById("end-time").readOnly = true;
            }

            // Calcular y mostrar duraci√≥n si ambos tiempos existen
            if (visit.startTime && visit.endTime) {
              const start = new Date(visit.startTime);
              const end = new Date(visit.endTime);
              const durationMs = end - start;
              const durationHours = Math.floor(durationMs / (1000 * 60 * 60));
              const durationMinutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));

              document.getElementById("existing-duration").textContent =
                `${durationHours} horas ${durationMinutes} minutos`;
            }
          } else {
            // Si no hay tiempos registrados, permitir edici√≥n
            // Opcional: Establecer valores por defecto
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById("start-time").value = now.toISOString().slice(0, 16);

            // Establecer end_time como 1 hora despu√©s por defecto
            const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
            document.getElementById("end-time").value = oneHourLater.toISOString().slice(0, 16);
          }



          if (visit.colorReading) {
            const colorInput = document.getElementById("color-reading");
            colorInput.value = visit.colorReading;
            colorInput.readOnly = true;
          }

          if (visit.scannerReading) {
            const scannerInput = document.getElementById("scanner-reading");
            scannerInput.value = visit.scannerReading;
            scannerInput.readOnly = true;
          }


          if (visit.takeTonerReading || visit.tonerLevelK != null || visit.tonerLevelC != null ||
            visit.tonerLevelM != null || visit.tonerLevelY != null) {

            // Mostrar secci√≥n de lectura existente
            existingTonerSection.style.display = "block";
            document.getElementById("existing-toner-k").textContent = visit.tonerLevelK || "0";
            document.getElementById("existing-toner-c").textContent = visit.tonerLevelC || "0";
            document.getElementById("existing-toner-m").textContent = visit.tonerLevelM || "0";
            document.getElementById("existing-toner-y").textContent = visit.tonerLevelY || "0";
            document.getElementById("existing-toner-notes").textContent = visit.tonerNotes || "Sin notas";

            // Bloquear campos de entrada
            document.getElementById("toner-level-k").value = visit.tonerLevelK || "";
            document.getElementById("toner-level-k").readOnly = true;
            document.getElementById("toner-level-c").value = visit.tonerLevelC || "";
            document.getElementById("toner-level-c").readOnly = true;
            document.getElementById("toner-level-m").value = visit.tonerLevelM || "";
            document.getElementById("toner-level-m").readOnly = true;
            document.getElementById("toner-level-y").value = visit.tonerLevelY || "";
            document.getElementById("toner-level-y").readOnly = true;
            document.getElementById("toner-notes").value = visit.tonerNotes || "";
            document.getElementById("toner-notes").readOnly = true;

            // Deshabilitar checkbox
            chkToner.checked = false;
            chkToner.disabled = true;
            tonerFields.style.display = "block";
          }



          // Seleccionar t√©cnico
          if (visit.technicianId) {
            document.getElementById("technician-id").value = visit.technicianId;

            try {
              const tech = await technicianService.get(visit.technicianId);
              document.getElementById("request-technician").textContent =
                tech ? tech.fullName : "Sin asignar";
              document.getElementById("technician-input").value =
                tech ? tech.fullName : "";
            } catch (err) {
              console.error("Error cargando t√©cnico:", err);
              document.getElementById("request-technician").textContent =
                "Error cargando t√©cnico";
            }
          }

          await loadRootCausesForEdit(visit);

          // Configurar estado de resoluci√≥n
          if (visit.solved) {
            chkSolved.checked = true;
            resolutionFields.style.display = "block";
          }

          // Configurar lectura del contador
          /*if (visit.takeMeterReading || visit.reading) {
            chkMeter.checked = true;
            meterFields.style.display = "block";
            document.getElementById("meter-reading").value = visit.reading || "";
            document.getElementById("reading-notes").value = visit.readingNotes || "";
          }*/

          // Configurar repuestos si existen
          if (visit.partsUsed && Object.keys(visit.partsUsed).length > 0) {
            chkParts.checked = true;
            partsContainer.style.display = "block";
            // Aqu√≠ podr√≠as cargar los repuestos existentes si tu backend los devuelve
          }
        }
      } catch (err) {
        console.error("Error cargando visita:", err);
        showAlert("Error al cargar datos de la visita", "danger");
      }
    }

    // Cargar repuestos ya existentes
    // Cargar repuestos ya existentes
    async function loadExistingParts() {
      try {
        const res = await fetch(`${API}/visit-parts/visit/${visitId}`);
        if (res.ok) {
          const parts = await res.json();
          existingPartsList.innerHTML = "";

          if (parts.length > 0) {
            parts.forEach(p => {
              const partDiv = document.createElement("div");
              partDiv.className = "d-flex justify-content-between align-items-center p-2 border-bottom";
              partDiv.innerHTML = `
            <div>
              <strong>${p.name || "Repuesto ID: " + p.partId}</strong>
              <br><small class="text-muted">Cantidad: ${p.qty}</small>
            </div>
            <small class="text-muted">Serial: ${p.serialNumber || "N/A"} | Costo: ${p.cost || "N/A"}</small>
          `;
              existingPartsList.appendChild(partDiv);
            });
          } else {
            existingPartsList.innerHTML = '<p class="text-muted">No hay repuestos registrados para esta visita</p>';
          }
        }
      } catch (err) {
        console.error("Error cargando repuestos existentes:", err);
        existingPartsList.innerHTML = '<p class="text-muted">Error al cargar repuestos existentes</p>';
      }
    }


    async function loadRootCausesForEdit(visit) {
      console.log("üîç Cargando causas ra√≠z para edici√≥n...");

      try {
        const groupedCauses = await rootCauseService.getGrouped();
        const select = document.getElementById('root-cause-select');
        const categoriesDiv = document.getElementById('root-cause-categories');
        const currentRootCauseDiv = document.getElementById('current-root-cause');
        const currentRootCauseText = document.getElementById('current-root-cause-text');

        // Limpiar select
        select.innerHTML = '<option value="">Seleccione una causa ra√≠z (opcional)</option>';

        if (!groupedCauses || Object.keys(groupedCauses).length === 0) {
          categoriesDiv.innerHTML = '<div class="alert alert-warning">No hay causas ra√≠z configuradas</div>';
          return;
        }

        // Crear botones de categor√≠as
        let categoriesHtml = '<div class="btn-group flex-wrap" role="group">';
        for (const [category, causes] of Object.entries(groupedCauses)) {
          categoriesHtml += `
            <button type="button" class="btn btn-outline-secondary btn-sm m-1" 
                    onclick="filterRootCausesForEdit('${category}')">
                ${category}
            </button>
            `;
        }
        categoriesHtml += '</div>';
        categoriesDiv.innerHTML = categoriesHtml;

        // Almacenar todas las causas para filtrado
        window.allRootCausesEdit = [];
        for (const [category, causes] of Object.entries(groupedCauses)) {
          causes.forEach(cause => {
            window.allRootCausesEdit.push({
              id: cause.id,
              name: cause.name,
              category: category
            });

            // Agregar al select
            const option = document.createElement('option');
            option.value = cause.id;
            option.textContent = `${category} - ${cause.name}`;
            option.setAttribute('data-category', category);
            select.appendChild(option);
          });
        }

        // Si la visita ya tiene una causa ra√≠z, seleccionarla
        if (visit.rootCauseId) {
          console.log("üëâ Visit tiene rootCauseId:", visit.rootCauseId);
          select.value = visit.rootCauseId;

          // Mostrar informaci√≥n de la causa ra√≠z actual
          if (visit.rootCauseName) {
            currentRootCauseDiv.style.display = 'block';
            currentRootCauseText.textContent =
              `${visit.rootCauseCategory || ''} - ${visit.rootCauseName}`;
          }
        }

      } catch (err) {
        console.error("‚ùå Error cargando causas ra√≠z para edici√≥n:", err);
        loadHardcodedRootCausesForEdit(visit);
      }
    }


    // Funci√≥n para filtrar causas por categor√≠a
    function filterRootCausesForEdit(category) {
      const select = document.getElementById('root-cause-select');
      select.innerHTML = '<option value="">Seleccione una causa ra√≠z (opcional)</option>';

      if (!window.allRootCausesEdit) return;

      // Filtrar por categor√≠a y agregar al select
      const filteredCauses = window.allRootCausesEdit.filter(cause => cause.category === category);
      filteredCauses.forEach(cause => {
        const option = document.createElement('option');
        option.value = cause.id;
        option.textContent = `${cause.category} - ${cause.name}`;
        select.appendChild(option);
      });
    }

    // Funci√≥n de respaldo con datos hardcodeados
    function loadHardcodedRootCausesForEdit(visit) {
      console.log("‚ö†Ô∏è Cargando causas ra√≠z hardcodeadas para edici√≥n...");

      const groupedCauses = {
        "CONTADORES / LECTURAS": [
          { id: 1, name: "CONTADOR", category: "CONTADORES / LECTURAS" },
          { id: 2, name: "TOMA DE CONTADORES", category: "CONTADORES / LECTURAS" },
          { id: 3, name: "LECTURA DE CONTADOR", category: "CONTADORES / LECTURAS" }
        ],
        "TONER / TINTA": [
          { id: 6, name: "RECARGA TONER", category: "TONER / TINTA" },
          { id: 8, name: "TONER", category: "TONER / TINTA" }
        ]
      };

      const select = document.getElementById('root-cause-select');
      const categoriesDiv = document.getElementById('root-cause-categories');
      const currentRootCauseDiv = document.getElementById('current-root-cause');
      const currentRootCauseText = document.getElementById('current-root-cause-text');

      select.innerHTML = '<option value="">Seleccione una causa ra√≠z (opcional)</option>';

      let categoriesHtml = '<div class="btn-group flex-wrap" role="group">';
      for (const [category, causes] of Object.entries(groupedCauses)) {
        categoriesHtml += `
        <button type="button" class="btn btn-outline-secondary btn-sm m-1" 
                onclick="filterRootCausesForEdit('${category}')">
            ${category}
        </button>
        `;

        causes.forEach(cause => {
          if (!window.allRootCausesEdit) window.allRootCausesEdit = [];
          window.allRootCausesEdit.push(cause);

          const option = document.createElement('option');
          option.value = cause.id;
          option.textContent = `${category} - ${cause.name}`;
          select.appendChild(option);
        });
      }
      categoriesHtml += '</div>';

      categoriesDiv.innerHTML = categoriesHtml +
        '<div class="alert alert-info mt-2"><small>‚ö†Ô∏è Usando datos de prueba</small></div>';

      // Si la visita ya tiene una causa ra√≠z, seleccionarla
      if (visit && visit.rootCauseId) {
        select.value = visit.rootCauseId;
        if (visit.rootCauseName) {
          currentRootCauseDiv.style.display = 'block';
          currentRootCauseText.textContent =
            `${visit.rootCauseCategory || ''} - ${visit.rootCauseName}`;
        }
      }
    }






    // Inicializar la p√°gina
    await Promise.all([
      loadRequestInfo(),
      loadVisitData(),
      loadExistingParts()
    ]);

    // Manejar env√≠o del formulario
    document.getElementById("visit-form").addEventListener("submit", async e => {
      e.preventDefault();
      const btn = document.getElementById("btn-save");
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Guardando...';

      try {
        const formData = new FormData(document.getElementById("visit-form"));
        const rawDate = formData.get("visitDatetime");
        const dto = {
          serviceRequestId: parseInt(requestId),
          technicianId: parseInt(document.getElementById("technician-id").value),
          visitDatetime: rawDate ? new Date(rawDate).toISOString() : null,
          visitNotes: formData.get("visitNotes") || null,
          solved: chkSolved.checked,

          // Nuevos campos de tiempo
          startTime: document.getElementById("start-time").value ?
            new Date(document.getElementById("start-time").value).toISOString() : null,
          endTime: document.getElementById("end-time").value ?
            new Date(document.getElementById("end-time").value).toISOString() : null,

          rootCauseId: document.getElementById("root-cause-select").value ?
            parseInt(document.getElementById("root-cause-select").value) : null,
          takeMeterReading: chkMeter.checked,
          reading: chkMeter.checked ?
            (formData.get("reading") ? parseInt(formData.get("reading")) : null) : null,
          readingNotes: chkMeter.checked ? formData.get("readingNotes") || null : null,
          colorReading: chkMeter.checked ?
            (formData.get("colorReading") ? parseInt(formData.get("colorReading")) : null) : null,

          scannerReading: chkMeter.checked ?
            (formData.get("scannerReading") ? parseInt(formData.get("scannerReading")) : null) : null,

          takeTonerReading: chkToner.checked,
          tonerLevelK: chkToner.checked ?
            (formData.get("tonerLevelK") ? parseInt(formData.get("tonerLevelK")) : null) : null,
          tonerLevelC: chkToner.checked ?
            (formData.get("tonerLevelC") ? parseInt(formData.get("tonerLevelC")) : null) : null,
          tonerLevelM: chkToner.checked ?
            (formData.get("tonerLevelM") ? parseInt(formData.get("tonerLevelM")) : null) : null,
          tonerLevelY: chkToner.checked ?
            (formData.get("tonerLevelY") ? parseInt(formData.get("tonerLevelY")) : null) : null,
          tonerNotes: chkToner.checked ? formData.get("tonerNotes") || null : null
        };

        // Recopilar informaci√≥n de repuestos
        if (chkParts.checked) {
          const partSelects = partsList.querySelectorAll(".part-select");
          for (const select of partSelects) {
            if (select.value) {
              const quantityInput = select.closest('.d-flex').querySelector('input[name="quantity"]');
              const quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;

              const dtoPart = {
                serviceVisitId: parseInt(visitId),
                partId: parseInt(select.value),
                qty: quantity
              };

              await fetch(`${API}/visit-parts`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dtoPart)
              });
            }
          }
        }

        // 1) Actualizar visita
        const updateRes = await fetch(`${API}/visits/${visitId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dto)
        });

        if (!updateRes.ok) {
          const errorText = await updateRes.text();
          throw new Error(`Error actualizando visita: ${errorText}`);
        }

        // 2) Actualizar estado del service request si est√° resuelto
        if (chkSolved.checked) {
          await fetch(`${API}/service-requests/${requestId}/status?status=resuelto`, {
            method: "PUT"
          });
        }

        showAlert("Visita actualizada correctamente", "success");
        setTimeout(() => {
          appLoad("service_requests/detail.html");
        }, 1500);

      } catch (err) {
        console.error(err);
        showAlert(err.message || "Error al actualizar la visita", "danger");
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Actualizar Visita';
      }
    });

  })();
</script>
<style>
  .disabled-card {
    opacity: 0.6;
    pointer-events: none;
  }
</style>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\service_visits\new.html =====
<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Nueva Visita T√©cnica</h4>
    <button class="btn btn-outline-secondary btn-sm" onclick="appLoad('service_requests/detail.html')">
      <i class="fas fa-arrow-left me-1"></i> Volver a Solicitud
    </button>
  </div>

  <!-- Informaci√≥n de la Solicitud Asociada -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Solicitud de Servicio Asociada</h6>
    </div>
    <div class="card-body">
      <div class="row" id="request-info">
        <div class="col-md-6">
          <strong>Solicitud #:</strong> <span id="request-number">Cargando...</span><br>
          <strong>Cliente:</strong> <span id="request-customer">Cargando...</span><br>
          <strong>M√°quina:</strong> <span id="request-machine">Cargando...</span>
        </div>
        <div class="col-md-6">
          <strong>Tipo de Servicio:</strong> <span id="request-type">Cargando...</span><br>
          <strong>Causa Ra√≠z:</strong> <span id="request-rootcause">Cargando...</span><br>
          <strong>Estado Actual:</strong> <span id="request-status">Cargando...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario nueva visita -->
  <form id="visit-form" class="row g-3" novalidate>
    <input type="hidden" name="serviceRequestId" id="service-request-id">

    <div class="col-md-6">
      <label class="form-label">T√©cnico *</label>
      <select class="form-select" id="technicians" name="technicianId" required>
        <option value="">Seleccione un t√©cnico</option>
      </select>
      <div class="invalid-feedback">Por favor seleccione un t√©cnico</div>
    </div>

    <div class="col-md-6">
      <label class="form-label">Fecha y Hora de la Visita *</label>
      <input type="datetime-local" class="form-control" name="visitDatetime" id="visit-datetime" required>
      <div class="invalid-feedback">Por favor ingrese la fecha y hora de la visita</div>
    </div>


    <div class="col-12">
      <label class="form-label">Causa Ra√≠z (Diagn√≥stico) *</label>
      <select class="form-select" name="rootCauseId" id="root-cause-select" required>
        <option value="">Seleccione una causa ra√≠z</option>
        <!-- Las opciones se cargar√°n con JavaScript -->
      </select>
      <div id="root-cause-categories" class="mt-2"></div>
    </div>

    <div class="col-12">
      <label class="form-label">Notas de la Visita *</label>
      <textarea class="form-control" name="visitNotes" id="visit-notes" rows="4"
        placeholder="Describa los trabajos realizados, observaciones, repuestos utilizados, etc." required></textarea>
      <div class="invalid-feedback">Por favor ingrese las notas de la visita</div>
    </div>

    <div class="col-12">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="solved" id="solved">
        <label class="form-check-label" for="solved">
          <strong>¬øSolicitud resuelta?</strong> (Marcar si el problema fue solucionado completamente)
        </label>
      </div>
    </div>

    <div class="col-12">
      <button class="btn btn-success" type="submit" id="btn-submit">
        <i class="fas fa-save me-1"></i> Registrar Visita
      </button>
      <button class="btn btn-outline-secondary" type="button" onclick="appLoad('service_requests/detail.html')">
        <i class="fas fa-times me-1"></i> Cancelar
      </button>
    </div>
  </form>
</div>

<script>


  (async function initNewVisit() {
    const requestId = sessionStorage.getItem("selectedRequestId");
    if (!requestId) {
      showAlert("No se encontr√≥ la solicitud seleccionada.", "danger");
      appLoad("service_requests/list.html");
      return;
    }

    // set id en hidden
    document.getElementById('service-request-id').value = requestId;

    // set datetime default
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('visit-datetime').value = now.toISOString().slice(0, 16);

    try {
      await loadRequestInfo(requestId);
      await loadTechnicians();
      await loadRootCausesForVisit();
    } catch (err) {
      console.error("Error inicializando:", err);
      showAlert("Error al cargar datos iniciales", "danger");
    }

    document.getElementById("visit-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;

      if (!form.checkValidity()) {
        e.stopPropagation();
        form.classList.add("was-validated");
        return;
      }

      const btn = document.getElementById("btn-submit");
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Guardando...';

      try {
        const visitData = {
          serviceRequestId: parseInt(requestId),
          technicianId: parseInt(document.getElementById("technicians").value),
          visitDatetime: document.getElementById("visit-datetime").value + "-05:00",
          visitNotes: document.getElementById("visit-notes").value,
          solved: document.getElementById("solved").checked,

          rootCauseId: document.getElementById("root-cause-select").value ?
            parseInt(document.getElementById("root-cause-select").value) : null
        };

        console.log("Enviando visita:", visitData);

        const visitResult = await serviceVisitService.create(visitData);

        if (visitResult?.id) {
          try {
            await fetch(`${API_BASE}/service-requests/${requestId}/status?status=EN_PROCESO`, {
              method: "PUT"
            });
          } catch (err2) {
            console.warn("No se pudo actualizar solicitud:", err2);
          }

          showAlert("Visita registrada correctamente", "success");
          setTimeout(() => appLoad("service_requests/detail.html"), 1500);
        } else {
          throw new Error("Respuesta inv√°lida del servidor");
        }
      } catch (err) {
        console.error("Error registrando visita:", err);
        showAlert("Error registrando visita: " + (err.message || "Error desconocido"), "danger");
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Registrar Visita';
      }
    });
  })();

  async function loadRequestInfo(requestId) {
    const req = await serviceRequestService.get(requestId);
    if (!req) throw new Error("Solicitud no encontrada");

    document.getElementById("request-number").textContent = req.requestNumber || req.id;
    document.getElementById("request-type").textContent = req.serviceType || "N/A";
    document.getElementById("request-rootcause").textContent = req.rootCause || "N/A";
    document.getElementById("request-status").textContent = req.status || "N/A";

    if (req.customerId) {
      try {
        const cust = await customerService.get(req.customerId);
        document.getElementById("request-customer").textContent = cust?.name || "Cliente no disponible";
      } catch {
        document.getElementById("request-customer").textContent = "Error cargando cliente";
      }
    } else {
      document.getElementById("request-customer").textContent = "No asignado";
    }

    if (req.machineId) {
      try {
        const mach = await machineService.get(req.machineId);
        document.getElementById("request-machine").textContent =
          `${mach?.companySerial || "N/A"} - ${mach?.model || ""}`;
      } catch {
        document.getElementById("request-machine").textContent = "Error cargando m√°quina";
      }
    } else {
      document.getElementById("request-machine").textContent = "No asignada";
    }
  }

  async function loadTechnicians() {
    const list = await technicianService.list();
    const sel = document.getElementById("technicians");
    sel.innerHTML = '<option value="">Seleccione un t√©cnico</option>';
    if (list?.length) {
      list.forEach(t => {
        if (t.active !== false) {
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = `${t.fullName}${t.specialty ? " - " + t.specialty : ""}`;
          sel.appendChild(opt);
        }
      });
    }
  }

  async function loadRootCausesForVisit() {
    console.log("üîç Cargando causas ra√≠z para visita...");

    try {
      const groupedCauses = await rootCauseService.getGrouped();
      const select = document.getElementById('root-cause-select');
      const categoriesDiv = document.getElementById('root-cause-categories');

      // Limpiar select
      select.innerHTML = '<option value="">Seleccione una causa ra√≠z</option>';

      if (!groupedCauses || Object.keys(groupedCauses).length === 0) {
        categoriesDiv.innerHTML = '<div class="alert alert-warning">No hay causas ra√≠z configuradas</div>';
        return;
      }

      // Crear botones de categor√≠as
      let categoriesHtml = '<div class="btn-group flex-wrap" role="group">';
      for (const [category, causes] of Object.entries(groupedCauses)) {
        categoriesHtml += `
            <button type="button" class="btn btn-outline-secondary btn-sm m-1" 
                    onclick="filterRootCausesForVisit('${category}')">
                ${category}
            </button>
            `;
      }
      categoriesHtml += '</div>';
      categoriesDiv.innerHTML = categoriesHtml;

      // Almacenar todas las causas para filtrado
      window.allRootCausesVisit = [];
      for (const [category, causes] of Object.entries(groupedCauses)) {
        causes.forEach(cause => {
          window.allRootCausesVisit.push({
            id: cause.id,
            name: cause.name,
            category: category
          });

          // Agregar al select
          const option = document.createElement('option');
          option.value = cause.id;
          option.textContent = `${category} - ${cause.name}`;
          option.setAttribute('data-category', category);
          select.appendChild(option);
        });
      }

    } catch (err) {
      console.error("‚ùå Error cargando causas ra√≠z para visita:", err);
      loadHardcodedRootCausesForVisit();
    }
  }


  // Funci√≥n para filtrar causas por categor√≠a
  function filterRootCausesForVisit(category) {
    const select = document.getElementById('root-cause-select');
    select.innerHTML = '<option value="">Seleccione una causa ra√≠z</option>';

    if (!window.allRootCausesVisit) return;

    // Filtrar por categor√≠a y agregar al select
    const filteredCauses = window.allRootCausesVisit.filter(cause => cause.category === category);
    filteredCauses.forEach(cause => {
      const option = document.createElement('option');
      option.value = cause.id;
      option.textContent = `${cause.category} - ${cause.name}`;
      select.appendChild(option);
    });
  }

  // Funci√≥n de respaldo con datos hardcodeados
  function loadHardcodedRootCausesForVisit() {
    console.log("‚ö†Ô∏è Cargando causas ra√≠z hardcodeadas para visita...");

    const groupedCauses = {
      "CONTADORES / LECTURAS": [
        { id: 1, name: "CONTADOR", category: "CONTADORES / LECTURAS" },
        { id: 2, name: "TOMA DE CONTADORES", category: "CONTADORES / LECTURAS" }
      ],
      "TONER / TINTA": [
        { id: 6, name: "RECARGA TONER", category: "TONER / TINTA" },
        { id: 8, name: "TONER", category: "TONER / TINTA" }
      ]
    };

    const select = document.getElementById('root-cause-select');
    const categoriesDiv = document.getElementById('root-cause-categories');

    select.innerHTML = '<option value="">Seleccione una causa ra√≠z</option>';

    let categoriesHtml = '<div class="btn-group flex-wrap" role="group">';
    for (const [category, causes] of Object.entries(groupedCauses)) {
      categoriesHtml += `
        <button type="button" class="btn btn-outline-secondary btn-sm m-1" 
                onclick="filterRootCausesForVisit('${category}')">
            ${category}
        </button>
        `;

      causes.forEach(cause => {
        if (!window.allRootCausesVisit) window.allRootCausesVisit = [];
        window.allRootCausesVisit.push(cause);

        const option = document.createElement('option');
        option.value = cause.id;
        option.textContent = `${category} - ${cause.name}`;
        select.appendChild(option);
      });
    }
    categoriesHtml += '</div>';

    categoriesDiv.innerHTML = categoriesHtml +
      '<div class="alert alert-info mt-2"><small>‚ö†Ô∏è Usando datos de prueba</small></div>';
  }





</script>

<style>
  .form-control:invalid,
  .form-select:invalid {
    border-color: #dc3545;
  }

  .form-control:valid,
  .form-select:valid {
    border-color: #198754;
  }

  #request-info strong {
    color: #0f9d58;
    min-width: 120px;
    display: inline-block;
  }
</style>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\technicians\comparison.html =====
<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Comparaci√≥n de T√©cnicos</h4>
        <div>
            <button class="btn btn-outline-secondary btn-sm" id="btn-refresh-comparison">Actualizar</button>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label">Fecha inicio</label>
            <input type="date" class="form-control" id="start-date">
        </div>
        <div class="col-md-4">
            <label class="form-label">Fecha fin</label>
            <input type="date" class="form-control" id="end-date">
        </div>
        <div class="col-md-4">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-success w-100" id="btn-filter-comparison">Aplicar Filtros</button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>T√©cnico</th>
                    <th>Visitas</th>
                    <th>Servicios Repetidos</th>
                    <th>Efectividad</th>
                    <th>Detalle</th>
                </tr>
            </thead>
            <tbody id="comparison-tbody">
                <tr>
                    <td colspan="5" class="text-center">Cargando datos de t√©cnicos...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="mt-4">
        <h5>Gr√°fico de Comparaci√≥n</h5>
        <canvas id="techComparisonChart" height="100"></canvas>
    </div>
</div>

<script>
    async function loadTechnicianComparison() {
        try {
            // Obtener fechas de filtro
            const startDate = document.getElementById('start-date').value || new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
            const endDate = document.getElementById('end-date').value || new Date().toISOString().split('T')[0];
            
            // Cargar datos de comparaci√≥n
            const comparisonData = await technicianService.comparison(new Date(startDate), new Date(endDate));
            
            // Actualizar tabla
            const tbody = document.getElementById('comparison-tbody');
            tbody.innerHTML = '';
            
            if (comparisonData && comparisonData.length > 0) {
                comparisonData.forEach(tech => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${tech.fullName}</td>
                            <td>${tech.totalVisits || 0}</td>
                            <td>${tech.repeatedServices || 0}</td>
                            <td>
                                <div class="performance-bar">
                                    <div class="performance-fill" style="width: ${tech.effectiveness || 0}%"></div>
                                </div>
                                ${tech.effectiveness || 0}%
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="appLoad('technicians/performance.html?id=${tech.id}')">
                                    Ver Detalle
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                // Crear gr√°fico
                createComparisonChart(comparisonData);
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay datos para mostrar</td></tr>';
            }
        } catch (error) {
            console.error('Error loading technician comparison:', error);
            document.getElementById('comparison-tbody').innerHTML = 
                '<tr><td colspan="5" class="text-center text-danger">Error cargando datos</td></tr>';
        }
    }
    
    function createComparisonChart(data) {
        const ctx = document.getElementById('techComparisonChart').getContext('2d');
        
        // Destruir gr√°fico existente si hay uno
        if (window.techComparisonChartInstance) {
            window.techComparisonChartInstance.destroy();
        }
        
        window.techComparisonChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(tech => tech.fullName),
                datasets: [{
                    label: 'Efectividad (%)',
                    data: data.map(tech => tech.effectiveness || 0),
                    backgroundColor: '#0f9d58',
                    borderColor: '#0d8a4d',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Efectividad (%)'
                        }
                    }
                }
            }
        });
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Establecer fechas por defecto (√∫ltimos 30 d√≠as)
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);
        
        document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
        document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
        
        // Cargar datos iniciales
        loadTechnicianComparison();
        
        // Configurar eventos
        document.getElementById('btn-filter-comparison').addEventListener('click', loadTechnicianComparison);
        document.getElementById('btn-refresh-comparison').addEventListener('click', loadTechnicianComparison);
    });
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\technicians\detail.html =====
<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 id="t-name">T√©cnico</h4>
    <button class="btn btn-outline-secondary" onclick="appLoad('technicians/edit.html?id='+__TID)">Editar</button>
  </div>

  <table class="table">
    <tbody id="t-info"></tbody>
  </table>
</div>

<script>
async function loadTechnicianDetail(){
  const params = new URLSearchParams(location.search);
  const id = params.get("id");
  if(!id) return;
  window.__TID = id;
  const t = await technicianService.get(id);
  document.getElementById("t-name").innerText = t.fullName || ("T√©cnico " + t.id);
  document.getElementById("t-info").innerHTML = `
    <tr><th>ID</th><td>${t.id}</td></tr>
    <tr><th>Identificaci√≥n</th><td>${t.identification||""}</td></tr>
    <tr><th>Tel√©fono</th><td>${t.phone||""}</td></tr>
    <tr><th>Email</th><td>${t.email||""}</td></tr>
    <tr><th>Activo</th><td>${t.active ? "S√≠" : "No"}</td></tr>
  `;
}
document.addEventListener("DOMContentLoaded", loadTechnicianDetail);
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\technicians\edit.html =====
<div class="card p-3">
  <h4>Editar T√©cnico</h4>
  <form id="form-edit-technician" class="row g-3"></form>
</div>

<script>
async function loadTechnicianEdit(){
  const params = new URLSearchParams(location.search);
  const id = params.get("id");
  if(!id) return;
  const t = await technicianService.get(id);

  const form = document.getElementById("form-edit-technician");
  form.innerHTML = `
    <div class="col-md-6"><label class="form-label">Nombre</label>
      <input class="form-control" name="fullName" value="${t.fullName||""}" required></div>
    <div class="col-md-6"><label class="form-label">Identificaci√≥n</label>
      <input class="form-control" name="identification" value="${t.identification||""}"></div>
    <div class="col-md-6"><label class="form-label">Tel√©fono</label>
      <input class="form-control" name="phone" value="${t.phone||""}"></div>
    <div class="col-md-6"><label class="form-label">Email</label>
      <input class="form-control" name="email" value="${t.email||""}"></div>
    <div class="col-md-6"><label class="form-label">Activo</label>
      <select name="active" class="form-select">
        <option value="true" ${t.active?"selected":""}>S√≠</option>
        <option value="false" ${!t.active?"selected":""}>No</option>
      </select></div>
    <div class="col-12">
      <button class="btn btn-success" type="submit">Guardar</button>
      <button type="button" class="btn btn-outline-secondary" onclick="appLoad('technicians/list.html')">Cancelar</button>
    </div>
  `;

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form));
    data.active = data.active === "true";
    await technicianService.update(id, data);
    alert("T√©cnico actualizado");
    appLoad('technicians/detail.html?id='+id);
  });
}
document.addEventListener("DOMContentLoaded", loadTechnicianEdit);
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\technicians\list.html =====
<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">T√©cnicos</h4>
        <button class="btn btn-success btn-sm" onclick="appLoad('technicians/new.html')">
            <i class="fas fa-plus me-1"></i> Nuevo T√©cnico
        </button>
    </div>

    <div class="mb-3">
        <input type="text" id="technician-search" class="form-control" placeholder="Buscar t√©cnico...">
    </div>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Tel√©fono</th>
                    <th>Especialidad</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="technicians-tbody">
                <tr>
                    <td colspan="5" class="text-center">Cargando t√©cnicos...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    async function loadTechnicians(query="") {
        try {
            const technicians = await technicianService.list();
            const tbody = document.getElementById("technicians-tbody");
            tbody.innerHTML = "";

            const filtered = query
                ? technicians.filter(t => (t.fullName || "").toLowerCase().includes(query.toLowerCase()))
                : technicians;

            if (filtered.length > 0) {
                filtered.forEach(t => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${t.fullName}</td>
                            <td>${t.email || "N/A"}</td>
                            <td>${t.phone || ""}</td>
                            <td>${t.specialty || ""}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="appLoad('technicians/detail.html?id=${t.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="appLoad('technicians/edit.html?id=${t.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-info" onclick="appLoad('technicians/performance.html?id=${t.id}')">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center">No se encontraron t√©cnicos</td></tr>`;
            }
        } catch (error) {
            console.error("Error loading technicians:", error);
            showAlert("Error cargando t√©cnicos", "danger");
        }
    }

    // Autoejecutar inmediatamente cuando el snippet se inyecta
    (async function() {
        await loadTechnicians();
        document.getElementById("technician-search").addEventListener("input", (e) => {
            loadTechnicians(e.target.value);
        });
    })();
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\technicians\new.html =====
<div class="card p-3">
  <h4>Agregar T√©cnico</h4>
  <form id="form-tech" class="row g-3">
    <div class="col-md-6"><label class="form-label">Nombre completo</label><input class="form-control" name="fullName" required></div>
    <div class="col-md-6"><label class="form-label">Identificaci√≥n</label><input class="form-control" name="identification"></div>
    <div class="col-md-6"><label class="form-label">Tel√©fono</label><input class="form-control" name="phone"></div>
    <div class="col-md-6"><label class="form-label">Email</label><input class="form-control" name="email" type="email"></div>
    <div class="col-12"><button class="btn btn-success" type="submit">Guardar</button></div>
  </form>
</div>

<script>
document.getElementById("form-tech").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));
  await technicianService.create(data);
  alert("T√©cnico creado"); appLoad('technicians/list.html');
});
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\technicians\performance.html =====
<div class="card p-3">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h4 id="tech-name">Desempe√±o del T√©cnico</h4>
      <p class="text-muted">An√°lisis de rendimiento</p>
    </div>
    <div>
      <button class="btn btn-outline-secondary" onclick="appLoad('technicians/list.html')">Volver</button>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Filtros</div>
        <div class="card-body">
          <form id="performance-filter">
            <div class="mb-2">
              <label class="form-label">Fecha inicio</label>
              <input type="date" class="form-control" id="start-date">
            </div>
            <div class="mb-2">
              <label class="form-label">Fecha fin</label>
              <input type="date" class="form-control" id="end-date">
            </div>
            <button type="submit" class="btn btn-success">Aplicar filtros</button>
          </form>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Rendimiento</div>
        <div class="card-body">
          <div class="progress mb-2" style="height: 30px;">
            <div class="progress-bar bg-success" id="performance-bar" style="width: 0%">0%</div>
          </div>
          <div id="performance-stats">
            <div>Visitas realizadas: <span id="total-visits">0</span></div>
            <div>Servicios repetidos: <span id="repeated-services">0</span></div>
            <div>Efectividad: <span id="effectiveness">0%</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <h5>Desglose de servicios</h5>
  <div class="table-responsive">
    <table class="table table-hover">
      <thead class="table-light">
        <tr>
          <th>Tipo</th>
          <th>Cantidad</th>
          <th>Porcentaje</th>
        </tr>
      </thead>
      <tbody id="service-breakdown"></tbody>
    </table>
  </div>

  <h5 class="mt-4">Visitas realizadas</h5>
  <div class="table-responsive">
    <table class="table table-hover">
      <thead class="table-light">
        <tr>
          <th>Solicitud</th>
          <th>Fecha</th>
          <th>Cliente</th>
          <th>Tipo</th>
          <th>Resuelto</th>
        </tr>
      </thead>
      <tbody id="visits-list"></tbody>
    </table>
  </div>
</div>

<script>
let currentTechnicianId = null;

async function loadPerformance() {
  const params = new URLSearchParams(location.search);
  currentTechnicianId = params.get('id');
  
  if (!currentTechnicianId) {
    alert("ID de t√©cnico no especificado");
    appLoad('technicians/list.html');
    return;
  }
  
  // Cargar informaci√≥n b√°sica del t√©cnico
  try {
    const tech = await technicianService.get(currentTechnicianId).then(r => r.data || r);
    document.getElementById("tech-name").innerText = `Desempe√±o de ${tech.fullName || 'T√©cnico'}`;
  } catch (err) {
    console.error("Error cargando t√©cnico:", err);
  }
  
  // Cargar datos de rendimiento con filtros por defecto (√∫ltimo mes)
  const endDate = new Date();
  const startDate = new Date();
  startDate.setMonth(startDate.getMonth() - 1);
  
  document.getElementById("start-date").value = startDate.toISOString().split('T')[0];
  document.getElementById("end-date").value = endDate.toISOString().split('T')[0];
  
  await loadPerformanceData(startDate, endDate);
}

async function loadPerformanceData(startDate, endDate) {
  try {
    // En una implementaci√≥n real, esto llamar√≠a a endpoints espec√≠ficos del backend
    // Por ahora simulamos datos de ejemplo
    const performanceData = {
      totalVisits: 24,
      repeatedServices: 3,
      effectiveness: 87.5,
      serviceBreakdown: [
        { type: 'correctivo', count: 10 },
        { type: 'preventivo', count: 8 },
        { type: 'diagnostico', count: 4 },
        { type: 'toner', count: 2 }
      ],
      visits: [
        { request: 'SR-001', date: '2025-09-10', customer: 'Cliente A', type: 'correctivo', solved: true },
        { request: 'SR-002', date: '2025-09-12', customer: 'Cliente B', type: 'preventivo', solved: true },
        // ... m√°s visitas
      ]
    };
    
    // Actualizar UI
    document.getElementById("performance-bar").style.width = `${performanceData.effectiveness}%`;
    document.getElementById("performance-bar").innerText = `${performanceData.effectiveness}%`;
    document.getElementById("total-visits").innerText = performanceData.totalVisits;
    document.getElementById("repeated-services").innerText = performanceData.repeatedServices;
    document.getElementById("effectiveness").innerText = `${performanceData.effectiveness}%`;
    
    // Desglose de servicios
    const breakdownBody = document.getElementById("service-breakdown");
    breakdownBody.innerHTML = '';
    performanceData.serviceBreakdown.forEach(item => {
      const percentage = (item.count / performanceData.totalVisits * 100).toFixed(1);
      breakdownBody.innerHTML += `
        <tr>
          <td>${item.type}</td>
          <td>${item.count}</td>
          <td>${percentage}%</td>
        </tr>
      `;
    });
    
    // Lista de visitas
    const visitsBody = document.getElementById("visits-list");
    visitsBody.innerHTML = '';
    performanceData.visits.forEach(visit => {
      visitsBody.innerHTML += `
        <tr>
          <td>${visit.request}</td>
          <td>${visit.date}</td>
          <td>${visit.customer}</td>
          <td>${visit.type}</td>
          <td>${visit.solved ? 'S√≠' : 'No'}</td>
        </tr>
      `;
    });
    
  } catch (err) {
    console.error("Error cargando datos de rendimiento:", err);
    alert("Error cargando datos de rendimiento");
  }
}

document.addEventListener("DOMContentLoaded", loadPerformance);

document.getElementById("performance-filter").addEventListener("submit", async (e) => {
  e.preventDefault();
  const startDate = new Date(document.getElementById("start-date").value);
  const endDate = new Date(document.getElementById("end-date").value);
  await loadPerformanceData(startDate, endDate);
});
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\user\profile.html =====
<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Mi Perfil</h4>
    </div>

    <div class="row">
        <!-- Avatar + info b√°sica -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <img src="https://ui-avatars.com/api/?name=Usuario&background=0f9d58&color=fff&size=100" 
                         class="technician-img mb-3" alt="Avatar" id="user-avatar">
                    <h5 id="profile-name">Usuario</h5>
                    <p class="text-muted" id="profile-role">Rol</p>
                    <button class="btn btn-outline-secondary btn-sm mt-2" onclick="document.getElementById('avatar-input').click()">
                        <i class="fas fa-camera me-1"></i> Cambiar imagen
                    </button>
                    <input type="file" id="avatar-input" accept="image/*" style="display: none;" onchange="uploadAvatar(this.files[0])">
                </div>
            </div>
        </div>
        
        <!-- Datos editables -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">Informaci√≥n Personal</div>
                <div class="card-body">
                    <form id="profile-form">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre completo</label>
                                <input type="text" class="form-control" name="fullName" id="profile-fullName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Correo electr√≥nico</label>
                                <input type="email" class="form-control" name="email" id="profile-email" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Tel√©fono</label>
                                <input type="tel" class="form-control" name="phone" id="profile-phone">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Rol</label>
                                <input type="text" class="form-control" id="profile-role-input" disabled>
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i> Guardar cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">Seguridad</div>
                <div class="card-body">
                    <form id="password-form">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Nueva contrase√±a</label>
                                <input type="password" class="form-control" id="new-password" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Confirmar contrase√±a</label>
                                <input type="password" class="form-control" id="confirm-password" required>
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-outline-success">
                                <i class="fas fa-lock me-1"></i> Cambiar contrase√±a
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function loadUserProfile() {
        try {
            const profile = await userService.getProfile();

            // Llenar datos en UI
            document.getElementById("profile-name").textContent = profile.fullName || "Usuario";
            document.getElementById("profile-role").textContent = profile.role || "Rol";
            document.getElementById("profile-fullName").value = profile.fullName || "";
            document.getElementById("profile-email").value = profile.email || "";
            document.getElementById("profile-phone").value = profile.phone || "";
            document.getElementById("profile-role-input").value = profile.role || "";
            
            if (profile.avatarUrl) {
                document.getElementById("user-avatar").src = profile.avatarUrl;
            }
        } catch (error) {
            console.error("Error loading profile:", error);
            showAlert("Error cargando perfil de usuario", "danger");
        }
    }

    document.getElementById("profile-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
            const data = {
                fullName: document.getElementById("profile-fullName").value,
                email: document.getElementById("profile-email").value,
                phone: document.getElementById("profile-phone").value
            };
            await userService.updateProfile(data);
            showAlert("Perfil actualizado correctamente", "success");
            loadUserProfile();
        } catch (error) {
            console.error("Error updating profile:", error);
            showAlert("Error actualizando perfil", "danger");
        }
    });

    document.getElementById("password-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const newPass = document.getElementById("new-password").value;
        const confirmPass = document.getElementById("confirm-password").value;

        if (newPass !== confirmPass) {
            showAlert("Las contrase√±as no coinciden", "warning");
            return;
        }

        try {
            const res = await fetch(API_BASE + "/user/change-password", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ password: newPass })
            });
            if (!res.ok) throw new Error("Error cambiando contrase√±a");
            showAlert("Contrase√±a cambiada correctamente", "success");
            document.getElementById("password-form").reset();
        } catch (error) {
            console.error("Error changing password:", error);
            showAlert("Error cambiando contrase√±a", "danger");
        }
    });

    async function uploadAvatar(file) {
        if (!file) return;

        const formData = new FormData();
        formData.append("avatar", file);

        try {
            const res = await fetch(API_BASE + "/user/avatar", {
                method: "POST",
                body: formData
            });
            const result = await res.json();
            if (result.url) {
                document.getElementById("user-avatar").src = result.url;
                showAlert("Imagen de perfil actualizada", "success");
            } else {
                showAlert("Error al subir la imagen", "danger");
            }
        } catch (error) {
            console.error("Error uploading avatar:", error);
            showAlert("Error al subir la imagen", "danger");
        }
    }

    document.addEventListener("DOMContentLoaded", loadUserProfile);
</script>

===== C:\Users\LENOVO\Desktop\Webpage\irrigex\front2\user\sessions.html =====
<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Sesiones de Usuario</h4>
        <div>
            <button class="btn btn-outline-secondary btn-sm" id="btn-refresh-sessions">Actualizar</button>
        </div>
    </div>

    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Aqu√≠ puedes ver y gestionar tus sesiones activas en el sistema.
    </div>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Dispositivo</th>
                    <th>Ubicaci√≥n</th>
                    <th>Inicio de Sesi√≥n</th>
                    <th>√öltima Actividad</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="sessions-tbody">
                <tr>
                    <td colspan="6" class="text-center">Cargando sesiones...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    async function loadUserSessions() {
        try {
            const sessions = await userService.getSessions();
            updateSessionsTable(sessions);
        } catch (error) {
            console.error('Error loading user sessions:', error);
            document.getElementById('sessions-tbody').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">Error cargando sesiones</td></tr>';
        }
    }
    
    function updateSessionsTable(sessions) {
        const tbody = document.getElementById('sessions-tbody');
        tbody.innerHTML = '';
        
        if (sessions && sessions.length > 0) {
            sessions.forEach(session => {
                const isCurrent = session.isCurrent || false;
                
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <i class="fas ${session.deviceType === 'mobile' ? 'fa-mobile-alt' : 'fa-desktop'} me-2"></i>
                            ${session.browser} / ${session.os}
                        </td>
                        <td>${session.location || 'N/A'}</td>
                        <td>${formatDate(session.loginTime)}</td>
                        <td>${formatDate(session.lastActivity)}</td>
                        <td>
                            <span class="badge ${isCurrent ? 'bg-success' : 'bg-secondary'}">
                                ${isCurrent ? 'Activa' : 'Inactiva'}
                            </span>
                        </td>
                        <td>
                            ${!isCurrent ? `
                                <button class="btn btn-sm btn-danger" onclick="terminateSession('${session.id}')">
                                    <i class="fas fa-times"></i> Cerrar
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No se encontraron sesiones</td></tr>';
        }
    }
    
    async function terminateSession(sessionId) {
        if (!confirm('¬øEst√°s seguro de que deseas cerrar esta sesi√≥n?')) return;
        
        try {
            await userService.terminateSession(sessionId);
            showAlert('Sesi√≥n terminada correctamente', 'success');
            loadUserSessions(); // Recargar la lista
        } catch (error) {
            console.error('Error terminating session:', error);
            showAlert('Error terminando la sesi√≥n', 'danger');
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        loadUserSessions();
        document.getElementById('btn-refresh-sessions').addEventListener('click', loadUserSessions);
    });
</script>

