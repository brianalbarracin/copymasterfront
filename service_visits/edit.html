<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Editar Visita T√©cnica</h4>
    <button class="btn btn-outline-secondary btn-sm" onclick="appLoad('service_requests/detail.html')">
      <i class="fas fa-arrow-left me-1"></i> Volver a Solicitud
    </button>
  </div>

  <!-- Informaci√≥n de la Solicitud Asociada -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Solicitud de Servicio Asociada</h6>
    </div>
    <div class="card-body">
      <div class="row" id="request-info">
        <div class="col-md-6">
          <strong>T√©cnico:</strong> <span id="request-technician">Cargando...</span><br>
          <strong>Solicitud #:</strong> <span id="request-number">Cargando...</span><br>
          <strong>Cliente:</strong> <span id="request-customer">Cargando...</span><br>
          <strong>M√°quina:</strong> <span id="request-machine">Cargando...</span>
        </div>
        <div class="col-md-6">
          <strong>Tipo de Servicio:</strong> <span id="request-type">Cargando...</span><br>
          <strong>Causa Ra√≠z:</strong> <span id="request-rootcause">Cargando...</span><br>
          <strong>Estado Actual:</strong> <span id="request-status">Cargando...</span>
        </div>
      </div>
    </div>
  </div>
  <input type="hidden" id="machine-id" name="machineId">
  <!-- Formulario de edici√≥n -->
  <form id="visit-form" class="row g-3" novalidate>
    <input type="hidden" name="serviceRequestId" id="service-request-id">

    <div class="col-md-6">
      <label class="form-label">T√©cnico asignado</label>
      <input type="text" class="form-control" id="technician-input" readonly>
      <input type="hidden" name="technicianId" id="technician-id">
    </div>

    <div class="col-md-6">
      <label class="form-label">Fecha y Hora de la Visita</label>
      <input type="datetime-local" class="form-control" name="visitDatetime" id="visit-datetime" required>
    </div>

    <div class="col-12">
      <label class="form-label">Notas de la Visita</label>
      <textarea class="form-control" name="visitNotes" id="visit-notes" rows="4"></textarea>
    </div>


    <!-- Causa Ra√≠z -->
    <div class="col-12">
      <label class="form-label">Causa Ra√≠z (Diagn√≥stico)</label>
      <select class="form-select" name="rootCauseId" id="root-cause-select">
        <option value="">Seleccione una causa ra√≠z (opcional)</option>
        <!-- Las opciones se cargar√°n con JavaScript -->
      </select>
      <div id="root-cause-categories" class="mt-2"></div>

      <!-- Mostrar causa ra√≠z actual si existe -->
      <div id="current-root-cause" class="mt-2" style="display: none;">
        <div class="alert alert-info p-2">
          <small>
            <strong>Causa ra√≠z actual:</strong>
            <span id="current-root-cause-text"></span>
          </small>
        </div>
      </div>
    </div>
    <!-- Lectura existente (solo si hay meterReading) -->
    <div id="existing-meter-section" style="display:none" class="mb-3">
      <div class="card bg-light">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-lock me-2"></i>Lectura del Contador Existente</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <strong>Lectura:</strong> <span id="existing-reading-value"></span>
            </div>
            <div class="col-md-6">
              <strong>Notas:</strong> <span id="existing-reading-notes"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lectura del contador -->
    <div class="col-12">
      <div class="card" id="meter-reading-card">
        <div class="card-header">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chk-meter" name="takeMeterReading">
            <label class="form-check-label" for="chk-meter">
              <strong>¬øSe tom√≥ lectura del contador?</strong>
            </label>
          </div>
        </div>
        <div class="card-body" id="meter-fields" style="display:none">
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">Lectura Blanco/Negro</label>
              <input type="number" class="form-control" name="reading" id="meter-reading" min="0">
            </div>

            <div class="col-md-6">
              <label class="form-label">Lectura Color</label>
              <input type="number" class="form-control" name="colorReading" id="color-reading" min="0">
            </div>
            <div class="col-md-6 mt-3">
              <label class="form-label">Lectura Scanner</label>
              <input type="number" class="form-control" name="scannerReading" id="scanner-reading" min="0">
            </div>

            <div class="col-md-6 mt-3">
              <label class="form-label">Notas de la lectura</label>
              <input type="text" class="form-control" name="readingNotes" id="reading-notes"
                placeholder="Observaciones sobre la lectura">
            </div>


          </div>
        </div>
      </div>
    </div>

    <!-- Lectura de niveles de toner -->
    <div class="col-12">
      <div class="card" id="toner-reading-card">
        <div class="card-header">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chk-toner" name="takeTonerReading">
            <label class="form-check-label" for="chk-toner">
              <strong>¬øSe tom√≥ lectura de niveles de toner?</strong>
            </label>
          </div>
        </div>
        <div class="card-body" id="toner-fields" style="display:none">
          <div class="row">
            <div class="col-md-3">
              <label class="form-label">Nivel K (Negro)</label>
              <input type="number" class="form-control" name="tonerLevelK" id="toner-level-k" min="0" max="100"
                placeholder="0-100%">
              <div class="form-text">0% = vac√≠o, 100% = lleno</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Nivel C (Cian)</label>
              <input type="number" class="form-control" name="tonerLevelC" id="toner-level-c" min="0" max="100"
                placeholder="0-100%">
            </div>
            <div class="col-md-3">
              <label class="form-label">Nivel M (Magenta)</label>
              <input type="number" class="form-control" name="tonerLevelM" id="toner-level-m" min="0" max="100"
                placeholder="0-100%">
            </div>
            <div class="col-md-3">
              <label class="form-label">Nivel Y (Amarillo)</label>
              <input type="number" class="form-control" name="tonerLevelY" id="toner-level-y" min="0" max="100"
                placeholder="0-100%">
            </div>
            <div class="col-12 mt-3">
              <label class="form-label">Notas sobre niveles de toner</label>
              <input type="text" class="form-control" name="tonerNotes" id="toner-notes"
                placeholder="Observaciones sobre los niveles de toner">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lectura existente de toner (solo si hay tonerReading) -->
    <div id="existing-toner-section" style="display:none" class="mb-3">
      <div class="card bg-light">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-lock me-2"></i>Lectura de Toner Existente</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <strong>K (Negro):</strong> <span id="existing-toner-k"></span>%
            </div>
            <div class="col-md-3">
              <strong>C (Cian):</strong> <span id="existing-toner-c"></span>%
            </div>
            <div class="col-md-3">
              <strong>M (Magenta):</strong> <span id="existing-toner-m"></span>%
            </div>
            <div class="col-md-3">
              <strong>Y (Amarillo):</strong> <span id="existing-toner-y"></span>%
            </div>
            <div class="col-12 mt-2">
              <strong>Notas:</strong> <span id="existing-toner-notes"></span>
            </div>
          </div>
        </div>
      </div>
    </div>



    <!-- Estado de resoluci√≥n -->
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="solved" id="solved">
            <label class="form-check-label" for="solved">
              <strong>¬øSolicitud resuelta?</strong>
            </label>
          </div>
        </div>
        <div class="card-body" id="resolution-fields" style="display:none">
          <div class="mb-2">
            <label class="form-label">Descripci√≥n de la soluci√≥n</label>
            <textarea class="form-control" name="resolution" rows="3"
              placeholder="Describa c√≥mo se resolvi√≥ el problema"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Repuestos utilizados -->
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chk-parts">
            <label class="form-check-label" for="chk-parts">
              <strong>¬øSe utilizaron repuestos?</strong>
            </label>
          </div>
        </div>
        <div class="card-body" id="parts-container" style="display:none">
          <div id="parts-list">
            <!-- Los repuestos se a√±adir√°n aqu√≠ din√°micamente -->
          </div>
          <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btn-add-part">
            <i class="fas fa-plus me-1"></i> A√±adir otro repuesto
          </button>
        </div>
      </div>
    </div>

    <!-- Repuestos ya existentes -->
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Repuestos ya registrados en esta visita</h6>
        </div>
        <div class="card-body">
          <div id="existing-parts-list">
            <p class="text-muted">Cargando repuestos existentes...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12">
      <button class="btn btn-success" type="submit" id="btn-save">
        <i class="fas fa-save me-1"></i> Actualizar Visita
      </button>
      <button class="btn btn-outline-secondary" type="button" onclick="appLoad('service_requests/detail.html')">
        <i class="fas fa-times me-1"></i> Cancelar
      </button>
    </div>
  </form>
</div>

<script>
  (async function initEditVisit() {


    const API = API_BASE.replace(/\/$/, '');
    const visitId = sessionStorage.getItem("selectedVisitId");
    const requestId = sessionStorage.getItem("selectedRequestId");

    const chkMeter = document.getElementById("chk-meter");
    const meterFields = document.getElementById("meter-fields");
    const chkParts = document.getElementById("chk-parts");
    const partsContainer = document.getElementById("parts-container");
    const partsList = document.getElementById("parts-list");
    const btnAddPart = document.getElementById("btn-add-part");
    const existingPartsList = document.getElementById("existing-parts-list");
    const chkSolved = document.getElementById("solved");
    const resolutionFields = document.getElementById("resolution-fields");

    if (!visitId || !requestId) {
      showAlert("No se encontr√≥ la visita seleccionada.", "danger");
      return appLoad("service_requests/list.html");
    }

    // Toggle lectura
    chkMeter.addEventListener("change", e => {
      meterFields.style.display = e.target.checked ? "block" : "none";
    });

    // Toggle resoluci√≥n
    chkSolved.addEventListener("change", e => {
      resolutionFields.style.display = e.target.checked ? "block" : "none";
    });

    // Toggle lectura de toner
    const chkToner = document.getElementById("chk-toner");
    const tonerFields = document.getElementById("toner-fields");
    const existingTonerSection = document.getElementById("existing-toner-section");

    chkToner.addEventListener("change", e => {
      tonerFields.style.display = e.target.checked ? "block" : "none";
    });

    // Toggle repuestos
    chkParts.addEventListener("change", e => {
      partsContainer.style.display = e.target.checked ? "block" : "none";
      if (e.target.checked && partsList.children.length === 0) {
        addPartSelector();
      }
    });

    // A√±adir selector de repuestos
    btnAddPart.addEventListener("click", addPartSelector);

    // Funci√≥n para a√±adir un selector de repuestos
    async function addPartSelector() {
      try {
        const res = await fetch(`${API}/parts`);
        const parts = (await res.json()).data || [];

        const partItem = document.createElement("div");
        partItem.classList.add("part-item", "mb-2", "p-2", "border", "rounded");

        partItem.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <select class="form-select part-select" name="partId" required>
            <option value="">-- Seleccione repuesto --</option>
            ${parts.map(p => `<option value="${p.id}">${p.name} (${p.sku || 'N/A'}) - Stock: ${p.stock || 0}</option>`).join('')}
          </select>
          <input type="number" class="form-control" name="quantity" placeholder="Cantidad" min="1" value="1" style="width: 100px;">
          <button type="button" class="btn btn-sm btn-outline-danger remove-part">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;

        partsList.appendChild(partItem);

        // A√±adir evento para eliminar repuesto
        partItem.querySelector('.remove-part').addEventListener('click', function () {
          partItem.remove();
        });
      } catch (error) {
        console.error("Error cargando repuestos:", error);
        showAlert("Error al cargar la lista de repuestos", "danger");
      }
    }

    // Cargar lista de t√©cnicos

    // Cargar informaci√≥n del service-request
    async function loadRequestInfo() {
      try {
        const req = await serviceRequestService.get(requestId);
        document.getElementById("service-request-id").value = req.id;
        document.getElementById("request-number").textContent = req.requestNumber || req.id;
        document.getElementById("request-type").textContent = req.serviceType || "N/A";
        document.getElementById("request-rootcause").textContent = req.rootCause || "N/A";
        document.getElementById("request-status").textContent = req.status || "N/A";

        if (req.customerId) {
          const cust = await customerService.get(req.customerId);
          document.getElementById("request-customer").textContent = cust?.name || "N/A";
        }

        if (req.machineId) {
          const mach = await machineService.get(req.machineId);
          document.getElementById("request-machine").textContent =
            mach ? `${mach.brand || ''} ${mach.model || ''} (${mach.companySerial || 'N/A'})` : "N/A";
        }
      } catch (err) {
        console.error("Error cargando request:", err);
        showAlert("Error al cargar informaci√≥n de la solicitud", "danger");
      }
    }

    // Cargar datos de la visita
    async function loadVisitData() {
      try {
        const res = await fetch(`${API}/visits/request/${requestId}`)
        if (res.ok) {

          const json = await res.json();
          const visits = json.data || json;
          const visit = visits.find(v => v.id === parseInt(visitId));

          if (!visit) {
            console.warn("‚ö†Ô∏è No se encontr√≥ la visita con ID", visitId);
            return;
          }



          console.log("üëâ Visita cargada:", visit); // üëà ver todo el objeto
          console.log("üëâ TechnicianId recibido:", visit.technicianId);
          // Llenar formulario con datos existentes
          document.getElementById("visit-notes").value = visit.visitNotes || "";
          document.getElementById("visit-datetime").value = visit.visitDatetime ?
            new Date(visit.visitDatetime).toISOString().slice(0, 16) :
            new Date().toISOString().slice(0, 16);

          console.log("üëâ meterReading object:", visit.meterReading);
          console.log("üëâ Todas las propiedades de visit:", Object.keys(visit));

          if (visit.reading || visit.colorReading || visit.scannerReading) {
            // Mostrar el bloque de la card
            meterFields.style.display = "block";

            // Rellenar los valores
            // ---- LECTURA B/N ----
            if (visit.reading) {
              document.getElementById("meter-reading").value = visit.reading;
            }
            document.getElementById("meter-reading").readOnly = true;

            // ---- LECTURA COLOR ----
            if (visit.colorReading) {
              document.getElementById("color-reading").value = visit.colorReading;
            }
            document.getElementById("color-reading").readOnly = true;

            // ---- LECTURA SCANNER ----
            if (visit.scannerReading) {
              document.getElementById("scanner-reading").value = visit.scannerReading;
            }
            document.getElementById("scanner-reading").readOnly = true;

            // ---- NOTAS ----
            if (visit.readingNotes) {
              document.getElementById("reading-notes").value = visit.readingNotes;
            }
            document.getElementById("reading-notes").readOnly = true;

            // El checkbox se deshabilita (queda apagado y sin posibilidad de marcar)
            chkMeter.checked = false;
            chkMeter.disabled = true;

            // (Opcional) agregar un aviso visual
            /* const badge = document.createElement("span");
             badge.className = "badge bg-info ms-2";
             badge.textContent = "Lectura registrada (bloqueada)";
             chkMeter.closest(".card-header").appendChild(badge);*/

          }

          if (visit.colorReading) {
            const colorInput = document.getElementById("color-reading");
            colorInput.value = visit.colorReading;
            colorInput.readOnly = true;
          }

          if (visit.scannerReading) {
            const scannerInput = document.getElementById("scanner-reading");
            scannerInput.value = visit.scannerReading;
            scannerInput.readOnly = true;
          }


          if (visit.takeTonerReading || visit.tonerLevelK != null || visit.tonerLevelC != null ||
            visit.tonerLevelM != null || visit.tonerLevelY != null) {

            // Mostrar secci√≥n de lectura existente
            existingTonerSection.style.display = "block";
            document.getElementById("existing-toner-k").textContent = visit.tonerLevelK || "0";
            document.getElementById("existing-toner-c").textContent = visit.tonerLevelC || "0";
            document.getElementById("existing-toner-m").textContent = visit.tonerLevelM || "0";
            document.getElementById("existing-toner-y").textContent = visit.tonerLevelY || "0";
            document.getElementById("existing-toner-notes").textContent = visit.tonerNotes || "Sin notas";

            // Bloquear campos de entrada
            document.getElementById("toner-level-k").value = visit.tonerLevelK || "";
            document.getElementById("toner-level-k").readOnly = true;
            document.getElementById("toner-level-c").value = visit.tonerLevelC || "";
            document.getElementById("toner-level-c").readOnly = true;
            document.getElementById("toner-level-m").value = visit.tonerLevelM || "";
            document.getElementById("toner-level-m").readOnly = true;
            document.getElementById("toner-level-y").value = visit.tonerLevelY || "";
            document.getElementById("toner-level-y").readOnly = true;
            document.getElementById("toner-notes").value = visit.tonerNotes || "";
            document.getElementById("toner-notes").readOnly = true;

            // Deshabilitar checkbox
            chkToner.checked = false;
            chkToner.disabled = true;
            tonerFields.style.display = "block";
          }



          // Seleccionar t√©cnico
          if (visit.technicianId) {
            document.getElementById("technician-id").value = visit.technicianId;

            try {
              const tech = await technicianService.get(visit.technicianId);
              document.getElementById("request-technician").textContent =
                tech ? tech.fullName : "Sin asignar";
              document.getElementById("technician-input").value =
                tech ? tech.fullName : "";
            } catch (err) {
              console.error("Error cargando t√©cnico:", err);
              document.getElementById("request-technician").textContent =
                "Error cargando t√©cnico";
            }
          }

          await loadRootCausesForEdit(visit);

          // Configurar estado de resoluci√≥n
          if (visit.solved) {
            chkSolved.checked = true;
            resolutionFields.style.display = "block";
          }

          // Configurar lectura del contador
          /*if (visit.takeMeterReading || visit.reading) {
            chkMeter.checked = true;
            meterFields.style.display = "block";
            document.getElementById("meter-reading").value = visit.reading || "";
            document.getElementById("reading-notes").value = visit.readingNotes || "";
          }*/

          // Configurar repuestos si existen
          if (visit.partsUsed && Object.keys(visit.partsUsed).length > 0) {
            chkParts.checked = true;
            partsContainer.style.display = "block";
            // Aqu√≠ podr√≠as cargar los repuestos existentes si tu backend los devuelve
          }
        }
      } catch (err) {
        console.error("Error cargando visita:", err);
        showAlert("Error al cargar datos de la visita", "danger");
      }
    }

    // Cargar repuestos ya existentes
    // Cargar repuestos ya existentes
    async function loadExistingParts() {
      try {
        const res = await fetch(`${API}/visit-parts/visit/${visitId}`);
        if (res.ok) {
          const parts = await res.json();
          existingPartsList.innerHTML = "";

          if (parts.length > 0) {
            parts.forEach(p => {
              const partDiv = document.createElement("div");
              partDiv.className = "d-flex justify-content-between align-items-center p-2 border-bottom";
              partDiv.innerHTML = `
            <div>
              <strong>${p.name || "Repuesto ID: " + p.partId}</strong>
              <br><small class="text-muted">Cantidad: ${p.qty}</small>
            </div>
            <small class="text-muted">Serial: ${p.serialNumber || "N/A"} | Costo: ${p.cost || "N/A"}</small>
          `;
              existingPartsList.appendChild(partDiv);
            });
          } else {
            existingPartsList.innerHTML = '<p class="text-muted">No hay repuestos registrados para esta visita</p>';
          }
        }
      } catch (err) {
        console.error("Error cargando repuestos existentes:", err);
        existingPartsList.innerHTML = '<p class="text-muted">Error al cargar repuestos existentes</p>';
      }
    }


    async function loadRootCausesForEdit(visit) {
      console.log("üîç Cargando causas ra√≠z para edici√≥n...");

      try {
        const groupedCauses = await rootCauseService.getGrouped();
        const select = document.getElementById('root-cause-select');
        const categoriesDiv = document.getElementById('root-cause-categories');
        const currentRootCauseDiv = document.getElementById('current-root-cause');
        const currentRootCauseText = document.getElementById('current-root-cause-text');

        // Limpiar select
        select.innerHTML = '<option value="">Seleccione una causa ra√≠z (opcional)</option>';

        if (!groupedCauses || Object.keys(groupedCauses).length === 0) {
          categoriesDiv.innerHTML = '<div class="alert alert-warning">No hay causas ra√≠z configuradas</div>';
          return;
        }

        // Crear botones de categor√≠as
        let categoriesHtml = '<div class="btn-group flex-wrap" role="group">';
        for (const [category, causes] of Object.entries(groupedCauses)) {
          categoriesHtml += `
            <button type="button" class="btn btn-outline-secondary btn-sm m-1" 
                    onclick="filterRootCausesForEdit('${category}')">
                ${category}
            </button>
            `;
        }
        categoriesHtml += '</div>';
        categoriesDiv.innerHTML = categoriesHtml;

        // Almacenar todas las causas para filtrado
        window.allRootCausesEdit = [];
        for (const [category, causes] of Object.entries(groupedCauses)) {
          causes.forEach(cause => {
            window.allRootCausesEdit.push({
              id: cause.id,
              name: cause.name,
              category: category
            });

            // Agregar al select
            const option = document.createElement('option');
            option.value = cause.id;
            option.textContent = `${category} - ${cause.name}`;
            option.setAttribute('data-category', category);
            select.appendChild(option);
          });
        }

        // Si la visita ya tiene una causa ra√≠z, seleccionarla
        if (visit.rootCauseId) {
          console.log("üëâ Visit tiene rootCauseId:", visit.rootCauseId);
          select.value = visit.rootCauseId;

          // Mostrar informaci√≥n de la causa ra√≠z actual
          if (visit.rootCauseName) {
            currentRootCauseDiv.style.display = 'block';
            currentRootCauseText.textContent =
              `${visit.rootCauseCategory || ''} - ${visit.rootCauseName}`;
          }
        }

      } catch (err) {
        console.error("‚ùå Error cargando causas ra√≠z para edici√≥n:", err);
        loadHardcodedRootCausesForEdit(visit);
      }
    }


    // Funci√≥n para filtrar causas por categor√≠a
    function filterRootCausesForEdit(category) {
      const select = document.getElementById('root-cause-select');
      select.innerHTML = '<option value="">Seleccione una causa ra√≠z (opcional)</option>';

      if (!window.allRootCausesEdit) return;

      // Filtrar por categor√≠a y agregar al select
      const filteredCauses = window.allRootCausesEdit.filter(cause => cause.category === category);
      filteredCauses.forEach(cause => {
        const option = document.createElement('option');
        option.value = cause.id;
        option.textContent = `${cause.category} - ${cause.name}`;
        select.appendChild(option);
      });
    }

    // Funci√≥n de respaldo con datos hardcodeados
    function loadHardcodedRootCausesForEdit(visit) {
      console.log("‚ö†Ô∏è Cargando causas ra√≠z hardcodeadas para edici√≥n...");

      const groupedCauses = {
        "CONTADORES / LECTURAS": [
          { id: 1, name: "CONTADOR", category: "CONTADORES / LECTURAS" },
          { id: 2, name: "TOMA DE CONTADORES", category: "CONTADORES / LECTURAS" },
          { id: 3, name: "LECTURA DE CONTADOR", category: "CONTADORES / LECTURAS" }
        ],
        "TONER / TINTA": [
          { id: 6, name: "RECARGA TONER", category: "TONER / TINTA" },
          { id: 8, name: "TONER", category: "TONER / TINTA" }
        ]
      };

      const select = document.getElementById('root-cause-select');
      const categoriesDiv = document.getElementById('root-cause-categories');
      const currentRootCauseDiv = document.getElementById('current-root-cause');
      const currentRootCauseText = document.getElementById('current-root-cause-text');

      select.innerHTML = '<option value="">Seleccione una causa ra√≠z (opcional)</option>';

      let categoriesHtml = '<div class="btn-group flex-wrap" role="group">';
      for (const [category, causes] of Object.entries(groupedCauses)) {
        categoriesHtml += `
        <button type="button" class="btn btn-outline-secondary btn-sm m-1" 
                onclick="filterRootCausesForEdit('${category}')">
            ${category}
        </button>
        `;

        causes.forEach(cause => {
          if (!window.allRootCausesEdit) window.allRootCausesEdit = [];
          window.allRootCausesEdit.push(cause);

          const option = document.createElement('option');
          option.value = cause.id;
          option.textContent = `${category} - ${cause.name}`;
          select.appendChild(option);
        });
      }
      categoriesHtml += '</div>';

      categoriesDiv.innerHTML = categoriesHtml +
        '<div class="alert alert-info mt-2"><small>‚ö†Ô∏è Usando datos de prueba</small></div>';

      // Si la visita ya tiene una causa ra√≠z, seleccionarla
      if (visit && visit.rootCauseId) {
        select.value = visit.rootCauseId;
        if (visit.rootCauseName) {
          currentRootCauseDiv.style.display = 'block';
          currentRootCauseText.textContent =
            `${visit.rootCauseCategory || ''} - ${visit.rootCauseName}`;
        }
      }
    }






    // Inicializar la p√°gina
    await Promise.all([
      loadRequestInfo(),
      loadVisitData(),
      loadExistingParts()
    ]);

    // Manejar env√≠o del formulario
    document.getElementById("visit-form").addEventListener("submit", async e => {
      e.preventDefault();
      const btn = document.getElementById("btn-save");
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Guardando...';

      try {
        const formData = new FormData(document.getElementById("visit-form"));
        const rawDate = formData.get("visitDatetime");
        const dto = {
          serviceRequestId: parseInt(requestId),
          technicianId: parseInt(document.getElementById("technician-id").value),
          visitDatetime: rawDate ? new Date(rawDate).toISOString() : null,
          visitNotes: formData.get("visitNotes") || null,
          solved: chkSolved.checked,

          rootCauseId: document.getElementById("root-cause-select").value ?
            parseInt(document.getElementById("root-cause-select").value) : null,
          takeMeterReading: chkMeter.checked,
          reading: chkMeter.checked ?
            (formData.get("reading") ? parseInt(formData.get("reading")) : null) : null,
          readingNotes: chkMeter.checked ? formData.get("readingNotes") || null : null,
          colorReading: chkMeter.checked ?
            (formData.get("colorReading") ? parseInt(formData.get("colorReading")) : null) : null,

          scannerReading: chkMeter.checked ?
            (formData.get("scannerReading") ? parseInt(formData.get("scannerReading")) : null) : null,

          takeTonerReading: chkToner.checked,
          tonerLevelK: chkToner.checked ?
            (formData.get("tonerLevelK") ? parseInt(formData.get("tonerLevelK")) : null) : null,
          tonerLevelC: chkToner.checked ?
            (formData.get("tonerLevelC") ? parseInt(formData.get("tonerLevelC")) : null) : null,
          tonerLevelM: chkToner.checked ?
            (formData.get("tonerLevelM") ? parseInt(formData.get("tonerLevelM")) : null) : null,
          tonerLevelY: chkToner.checked ?
            (formData.get("tonerLevelY") ? parseInt(formData.get("tonerLevelY")) : null) : null,
          tonerNotes: chkToner.checked ? formData.get("tonerNotes") || null : null
        };

        // Recopilar informaci√≥n de repuestos
        if (chkParts.checked) {
          const partSelects = partsList.querySelectorAll(".part-select");
          for (const select of partSelects) {
            if (select.value) {
              const quantityInput = select.closest('.d-flex').querySelector('input[name="quantity"]');
              const quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;

              const dtoPart = {
                serviceVisitId: parseInt(visitId),
                partId: parseInt(select.value),
                qty: quantity
              };

              await fetch(`${API}/visit-parts`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dtoPart)
              });
            }
          }
        }

        // 1) Actualizar visita
        const updateRes = await fetch(`${API}/visits/${visitId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(dto)
        });

        if (!updateRes.ok) {
          const errorText = await updateRes.text();
          throw new Error(`Error actualizando visita: ${errorText}`);
        }

        // 2) Actualizar estado del service request si est√° resuelto
        if (chkSolved.checked) {
          await fetch(`${API}/service-requests/${requestId}/status?status=resuelto`, {
            method: "PUT"
          });
        }

        showAlert("Visita actualizada correctamente", "success");
        setTimeout(() => {
          appLoad("service_requests/detail.html");
        }, 1500);

      } catch (err) {
        console.error(err);
        showAlert(err.message || "Error al actualizar la visita", "danger");
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Actualizar Visita';
      }
    });

  })();
</script>
<style>
  .disabled-card {
    opacity: 0.6;
    pointer-events: none;
  }
</style>