<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Editar Visita Técnica</h4>
    <button class="btn btn-outline-secondary btn-sm" onclick="appLoad('service_requests/detail.html')">
      <i class="fas fa-arrow-left me-1"></i> Volver a Solicitud
    </button>
  </div>

  <!-- Información de la Solicitud Asociada -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Solicitud de Servicio Asociada</h6>
    </div>
    <div class="card-body">
      <div class="row" id="request-info">
        <div class="col-md-6">
          <strong>Solicitud #:</strong> <span id="request-number">Cargando...</span><br>
          <strong>Cliente:</strong> <span id="request-customer">Cargando...</span><br>
          <strong>Máquina:</strong> <span id="request-machine">Cargando...</span>
        </div>
        <div class="col-md-6">
          <strong>Tipo de Servicio:</strong> <span id="request-type">Cargando...</span><br>
          <strong>Causa Raíz:</strong> <span id="request-rootcause">Cargando...</span><br>
          <strong>Estado Actual:</strong> <span id="request-status">Cargando...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario -->
  <form id="visit-form" class="row g-3 needs-validation" novalidate>
    <input type="hidden" name="serviceRequestId" id="service-request-id">

    <div class="col-md-6">
      <label class="form-label">Técnico asignado</label>
      <input type="text" class="form-control" id="technician-name" readonly>
    </div>

    <div class="col-md-6">
      <label class="form-label">Fecha y Hora de la Visita *</label>
      <input type="datetime-local" class="form-control" name="visitDatetime" id="visit-datetime" required>
      <div class="invalid-feedback">Por favor ingrese la fecha y hora de la visita</div>
    </div>

    <div class="col-12">
      <label class="form-label">Notas de la Visita *</label>
      <textarea class="form-control" name="visitNotes" id="visit-notes" rows="4" required></textarea>
      <div class="invalid-feedback">Por favor ingrese las notas de la visita</div>
    </div>

    <!-- Lectura -->
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chk-meter">
            <label class="form-check-label" for="chk-meter">
              <strong>¿Se tomó lectura del contador?</strong>
            </label>
          </div>
        </div>
        <div class="card-body" id="meter-fields" style="display:none">
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">Lectura *</label>
              <input type="number" class="form-control" id="meter-reading" min="0">
            </div>
            <div class="col-md-6">
              <label class="form-label">Notas de la lectura</label>
              <input type="text" class="form-control" id="reading-notes" placeholder="Observaciones">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Resuelto -->
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="solved">
            <label class="form-check-label" for="solved">
              <strong>¿Solicitud resuelta?</strong>
            </label>
          </div>
        </div>
        <div class="card-body" id="resolution-fields" style="display:none">
          <label class="form-label">Descripción de la solución</label>
          <textarea class="form-control" id="resolution" rows="3" placeholder="Describa cómo se resolvió el problema"></textarea>
        </div>
      </div>
    </div>

    <!-- Repuestos -->
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chk-parts">
            <label class="form-check-label" for="chk-parts">
              <strong>¿Se utilizaron repuestos?</strong>
            </label>
          </div>
        </div>
        <div class="card-body" id="parts-container" style="display:none">
          <div id="parts-list"></div>
          <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btn-add-part">
            <i class="fas fa-plus me-1"></i> Añadir otro repuesto
          </button>
        </div>
      </div>
    </div>

    <!-- Repuestos existentes -->
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">
          <h6 class="mb-0">Repuestos ya registrados</h6>
        </div>
        <div class="card-body" id="existing-parts-list">
          <p class="text-muted">Cargando...</p>
        </div>
      </div>
    </div>

    <div class="col-12">
      <button class="btn btn-success" type="submit" id="btn-save">
        <i class="fas fa-save me-1"></i> Actualizar Visita
      </button>
      <button class="btn btn-outline-secondary" type="button" onclick="appLoad('service_requests/detail.html')">
        <i class="fas fa-times me-1"></i> Cancelar
      </button>
    </div>
  </form>
</div>

<script>
(async function initEditVisit(){
  const API = API_BASE.replace(/\/$/, '');
  const visitId = sessionStorage.getItem("selectedVisitId");
  const requestId = sessionStorage.getItem("selectedRequestId");

  if(!visitId || !requestId){
    showAlert("No se encontró la visita seleccionada.", "danger");
    return appLoad("service_requests/list.html");
  }

  const chkMeter = document.getElementById("chk-meter");
  const meterFields = document.getElementById("meter-fields");
  const chkSolved = document.getElementById("solved");
  const resolutionFields = document.getElementById("resolution-fields");
  const chkParts = document.getElementById("chk-parts");
  const partsContainer = document.getElementById("parts-container");
  const partsList = document.getElementById("parts-list");
  const btnAddPart = document.getElementById("btn-add-part");
  const existingPartsList = document.getElementById("existing-parts-list");

  // toggle
  chkMeter.addEventListener("change", e => meterFields.style.display = e.target.checked ? "block" : "none");
  chkSolved.addEventListener("change", e => resolutionFields.style.display = e.target.checked ? "block" : "none");
  chkParts.addEventListener("change", e => {
    partsContainer.style.display = e.target.checked ? "block" : "none";
    if(e.target.checked && partsList.children.length === 0) addPartSelector();
  });
  btnAddPart.addEventListener("click", addPartSelector);

  // agregar selector de repuestos
  async function addPartSelector(){
    const res = await fetch(`${API}/parts`);
    const parts = (await res.json()).data || [];
    const div = document.createElement("div");
    div.className = "d-flex align-items-center gap-2 mb-2";
    div.innerHTML = `
      <select class="form-select part-select" required>
        <option value="">-- Seleccione repuesto --</option>
        ${parts.map(p => `<option value="${p.id}">${p.name} (${p.sku || 'N/A'})</option>`).join("")}
      </select>
      <button type="button" class="btn btn-sm btn-outline-danger remove-part"><i class="fas fa-trash"></i></button>
    `;
    div.querySelector(".remove-part").onclick = () => div.remove();
    partsList.appendChild(div);
  }

  async function loadRequestInfo(){
    const req = await serviceRequestService.get(requestId);
    document.getElementById("service-request-id").value = req.id;
    document.getElementById("request-number").textContent = req.requestNumber || req.id;
    document.getElementById("request-type").textContent = req.serviceType || "N/A";
    document.getElementById("request-rootcause").textContent = req.rootCause || "N/A";
    document.getElementById("request-status").textContent = req.status || "N/A";
    if(req.customerId){
      const cust = await customerService.get(req.customerId);
      document.getElementById("request-customer").textContent = cust?.name || "N/A";
    }
    if(req.machineId){
      const mach = await machineService.get(req.machineId);
      document.getElementById("request-machine").textContent = `${mach?.brand || ""} ${mach?.model || ""} (${mach?.companySerial || "N/A"})`;
    }
  }

  async function loadVisitData(){
    const res = await fetch(`${API}/visits/${visitId}`);
    const visit = (await res.json()).data || await res.json();
    document.getElementById("visit-notes").value = visit.visitNotes || "";
    document.getElementById("visit-datetime").value = visit.visitDatetime ? new Date(visit.visitDatetime).toISOString().slice(0,16) : new Date().toISOString().slice(0,16);
    if(visit.technicianId){
      const tech = await technicianService.get(visit.technicianId);
      document.getElementById("technician-name").value = tech?.fullName || "N/A";
    }
    if(visit.solved){ chkSolved.checked = true; resolutionFields.style.display = "block"; }
    if(visit.takeMeterReading){
      chkMeter.checked = true; meterFields.style.display = "block";
      document.getElementById("meter-reading").value = visit.reading || "";
      document.getElementById("reading-notes").value = visit.readingNotes || "";
    }
  }

  async function loadExistingParts(){
    const res = await fetch(`${API}/visit-parts?visitId=${visitId}`);
    if(!res.ok){ existingPartsList.innerHTML = "<p class='text-muted'>Error cargando repuestos</p>"; return; }
    const data = (await res.json()).data || [];
    if(!data.length){ existingPartsList.innerHTML = "<p class='text-muted'>No hay repuestos registrados</p>"; return; }
    existingPartsList.innerHTML = "";
    for(const vp of data){
      const part = await fetch(`${API}/parts/${vp.partId}`).then(r=>r.json()).then(r=>r.data||r);
      const div = document.createElement("div");
      div.className = "p-2 border-bottom";
      div.innerHTML = `<strong>${part?.name || "Parte ID "+vp.partId}</strong><br><small class="text-muted">Fecha: ${vp.date}</small>`;
      existingPartsList.appendChild(div);
    }
  }

  await Promise.all([loadRequestInfo(), loadVisitData(), loadExistingParts()]);

  // submit
  document.getElementById("visit-form").addEventListener("submit", async e=>{
    e.preventDefault();
    const form = e.target;
    if(!form.checkValidity()){ e.stopPropagation(); form.classList.add("was-validated"); return; }

    const btn = document.getElementById("btn-save");
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Guardando...';

    try {
      const dto = {
        serviceRequestId: parseInt(requestId),
        visitNotes: document.getElementById("visit-notes").value,
        visitDatetime: document.getElementById("visit-datetime").value,
        solved: chkSolved.checked,
        takeMeterReading: chkMeter.checked,
        reading: chkMeter.checked ? parseInt(document.getElementById("meter-reading").value) : null,
        readingNotes: chkMeter.checked ? document.getElementById("reading-notes").value : null
      };

      await fetch(`${API}/visits/${visitId}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(dto)
      });

      if(chkParts.checked){
        const selects = partsList.querySelectorAll(".part-select");
        for(const sel of selects){
          if(sel.value){
            await fetch(`${API}/visit-parts`, {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({
                visitId: parseInt(visitId),
                partId: parseInt(sel.value),
                date: new Date().toISOString()
              })
            });
          }
        }
      }

      showAlert("Visita actualizada correctamente","success");
      setTimeout(()=>appLoad("service_requests/detail.html"),1500);
    } catch(err){
      console.error(err);
      showAlert("Error al guardar la visita","danger");
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save me-1"></i> Actualizar Visita';
    }
  });
})();
</script>

<style>
  .form-control:invalid,
  .form-select:invalid { border-color: #dc3545; }
  .form-control:valid,
  .form-select:valid { border-color: #198754; }
  #request-info strong { color: #0f9d58; min-width: 120px; display: inline-block; }
</style>