<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Editar Visita T√©cnica</h4>
    <button class="btn btn-outline-secondary btn-sm" onclick="appLoad('service_requests/detail.html')">
      <i class="fas fa-arrow-left me-1"></i> Volver a Solicitud
    </button>
  </div>

  <form id="visit-form" class="row g-3">
    <input type="hidden" name="id" id="visit-id">
    <input type="hidden" name="serviceRequestId" id="service-request-id">

    <div class="col-md-6">
      <label class="form-label">T√©cnico *</label>
      <select class="form-select" id="technicians" name="technicianId" required>
        <option value="">Seleccione un t√©cnico</option>
      </select>
      <div class="invalid-feedback">Seleccione un t√©cnico</div>
    </div>

    <div class="col-md-6">
      <label class="form-label">Fecha y Hora de la Visita *</label>
      <input type="datetime-local" class="form-control" name="visitDatetime" id="visit-datetime" required>
    </div>

    <div class="col-12">
      <label class="form-label">Notas *</label>
      <textarea class="form-control" name="visitNotes" id="visit-notes" rows="4" required></textarea>
    </div>

    <div class="col-12">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="solved" id="solved">
        <label class="form-check-label" for="solved">
          <strong>¬øSolicitud resuelta?</strong>
        </label>
      </div>
    </div>

    <div class="col-12">
      <button class="btn btn-success" type="submit" id="btn-submit">
        <i class="fas fa-save me-1"></i> Guardar Cambios
      </button>
      <button class="btn btn-outline-secondary" type="button" onclick="appLoad('service_requests/detail.html')">
        <i class="fas fa-times me-1"></i> Cancelar
      </button>
    </div>
  </form>
</div>

<script>
(async function () {
  const params = new URLSearchParams(location.search);
  const visitId = params.get("id");
  if (!visitId) {
    showAlert("No se encontr√≥ la visita.", "danger");
    appLoad("service_requests/detail.html");
    return;
  }

  const form = document.getElementById("visit-form");
  const btnSubmit = document.getElementById("btn-submit");
  const techniciansSelect = document.getElementById("technicians");

  try {
    // üîπ Cargar t√©cnicos
    const technicians = await technicianService.list();
    techniciansSelect.innerHTML = '<option value="">Seleccione un t√©cnico</option>';
    technicians.forEach(tech => {
      if (tech.active !== false) {
        techniciansSelect.innerHTML += `
          <option value="${tech.id}">
            ${tech.fullName}${tech.specialty ? " - " + tech.specialty : ""}
          </option>`;
      }
    });

    // üîπ Cargar datos de la visita
    const visit = await serviceVisitService.get(visitId);
    if (!visit) throw new Error("Visita no encontrada");

    document.getElementById("visit-id").value = visit.id;
    document.getElementById("service-request-id").value = visit.serviceRequestId;

    if (visit.visitDatetime) {
      const dt = new Date(visit.visitDatetime);
      dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
      document.getElementById("visit-datetime").value = dt.toISOString().slice(0, 16);
    }

    document.getElementById("technicians").value = visit.technicianId || "";
    document.getElementById("visit-notes").value = visit.visitNotes || "";
    document.getElementById("solved").checked = visit.solved === true;

  } catch (err) {
    console.error("Error cargando visita:", err);
    showAlert("Error cargando visita: " + err.message, "danger");
  }

  // üîπ Submit
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!form.checkValidity()) {
      form.classList.add("was-validated");
      return;
    }

    btnSubmit.disabled = true;
    btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Guardando...';

    try {
      const formData = new FormData(form);
      const dto = {
        id: parseInt(formData.get("id")),
        serviceRequestId: parseInt(formData.get("serviceRequestId")),
        technicianId: parseInt(formData.get("technicianId")),
        visitDatetime: formData.get("visitDatetime"),
        visitNotes: formData.get("visitNotes"),
        solved: formData.get("solved") === "on"
      };

      console.log("Enviando update:", dto);

      const updated = await serviceVisitService.update(dto.id, dto);
      if (updated && updated.id) {
        showAlert("Visita actualizada correctamente", "success");
        setTimeout(() => appLoad("service_requests/detail.html"), 1200);
      } else {
        throw new Error("No se recibi√≥ confirmaci√≥n del servidor");
      }

    } catch (err) {
      console.error("Error actualizando visita:", err);
      showAlert("Error actualizando visita: " + err.message, "danger");
      btnSubmit.disabled = false;
      btnSubmit.innerHTML = '<i class="fas fa-save me-1"></i> Guardar Cambios';
    }
  });
})();
</script>
