<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Editar Visita Técnica</h4>
    <button class="btn btn-outline-secondary btn-sm" onclick="appLoad('service_requests/detail.html')">
      <i class="fas fa-arrow-left me-1"></i> Volver a Solicitud
    </button>
  </div>

  <!-- Información de la Solicitud Asociada -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Solicitud de Servicio Asociada</h6>
    </div>
    <div class="card-body">
      <div class="row" id="request-info">
        <div class="col-md-6">
          <strong>Solicitud #:</strong> <span id="request-number">Cargando...</span><br>
          <strong>Cliente:</strong> <span id="request-customer">Cargando...</span><br>
          <strong>Máquina:</strong> <span id="request-machine">Cargando...</span>
        </div>
        <div class="col-md-6">
          <strong>Tipo de Servicio:</strong> <span id="request-type">Cargando...</span><br>
          <strong>Causa Raíz:</strong> <span id="request-rootcause">Cargando...</span><br>
          <strong>Estado Actual:</strong> <span id="request-status">Cargando...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario de edición -->
  <form id="visit-form" class="row g-3" novalidate>
    <input type="hidden" name="serviceRequestId" id="service-request-id">

    <div class="col-md-6">
      <label class="form-label">Técnico asignado</label>
      <input type="text" id="technician-name" class="form-control" readonly>
    </div>

    <div class="col-md-6">
      <label class="form-label">Fecha y Hora de la Visita</label>
      <input type="text" id="visit-datetime" class="form-control" readonly>
    </div>

    <div class="col-12">
      <label class="form-label">Notas de la Visita</label>
      <textarea class="form-control" name="visitNotes" id="visit-notes" rows="4"></textarea>
    </div>

    <!-- Lectura -->
    <div class="col-12">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="chk-meter">
        <label class="form-check-label" for="chk-meter">¿Se tomó lectura?</label>
      </div>
    </div>
    <div class="col-md-6" id="meter-field" style="display:none;">
      <label class="form-label">Lectura del contador</label>
      <input type="number" class="form-control" id="meter-reading">
    </div>

    <!-- Resuelto -->
    <div class="col-12">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="solved" id="solved">
        <label class="form-check-label" for="solved">¿Solicitud resuelta?</label>
      </div>
    </div>

    <!-- Repuestos -->
    <div class="col-12">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="chk-parts">
        <label class="form-check-label">¿Requiere repuestos?</label>
      </div>
      <div id="parts-container" class="mt-2" style="display:none;"></div>
    </div>

    <!-- Repuestos ya existentes -->
    <div class="col-12">
      <label class="form-label">Repuestos ya registrados en esta visita</label>
      <ul id="existing-parts" class="list-group"></ul>
    </div>

    <div class="col-12">
      <button class="btn btn-success" type="submit" id="btn-save">
        <i class="fas fa-save me-1"></i> Actualizar Visita
      </button>
      <button class="btn btn-outline-secondary" type="button" onclick="appLoad('service_requests/detail.html')">
        <i class="fas fa-times me-1"></i> Cancelar
      </button>
    </div>
  </form>
</div>

<script>
(async function initEditVisit() {
  const API = API_BASE.replace(/\/$/, '');
  const visitId = sessionStorage.getItem("selectedVisitId");
  const requestId = sessionStorage.getItem("selectedRequestId");

  const chkMeter = document.getElementById("chk-meter");
  const meterField = document.getElementById("meter-field");
  const chkParts = document.getElementById("chk-parts");
  const partsContainer = document.getElementById("parts-container");
  const existingPartsList = document.getElementById("existing-parts");

  if (!visitId || !requestId) {
    showAlert("No se encontró la visita seleccionada.", "danger");
    return appLoad("service_requests/list.html");
  }

  // toggle lectura
  chkMeter.addEventListener("change", e=>{
    meterField.style.display = e.target.checked ? "block" : "none";
  });

  // toggle parts
  chkParts.addEventListener("change", e=>{
    if(e.target.checked){
      partsContainer.style.display = "block";
      partsContainer.innerHTML = "";
      addPartSelector();
    } else {
      partsContainer.innerHTML = "";
      partsContainer.style.display = "none";
    }
  });

  async function addPartSelector(){
    const res = await fetch(`${API}/parts`);
    const parts = (await res.json()).data || [];
    const wrapper = document.createElement("div");
    wrapper.classList.add("d-flex","mb-2","gap-2");
    const select = document.createElement("select");
    select.classList.add("form-select");
    select.innerHTML = '<option value="">-- Seleccione repuesto --</option>' +
      parts.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    const btnAdd = document.createElement("button");
    btnAdd.type = "button";
    btnAdd.className = "btn btn-sm btn-secondary";
    btnAdd.innerText = "+";
    btnAdd.onclick = () => addPartSelector();
    wrapper.appendChild(select);
    wrapper.appendChild(btnAdd);
    partsContainer.appendChild(wrapper);
  }

  // cargar info del request
  try {
    const req = await serviceRequestService.get(requestId);
    document.getElementById("service-request-id").value = req.id;
    document.getElementById("request-number").textContent = req.requestNumber || req.id;
    document.getElementById("request-type").textContent = req.serviceType || "N/A";
    document.getElementById("request-rootcause").textContent = req.rootCause || "N/A";
    document.getElementById("request-status").textContent = req.status || "N/A";

    if (req.customerId) {
      const cust = await customerService.get(req.customerId);
      document.getElementById("request-customer").textContent = cust?.name || "N/A";
    }
    if (req.machineId) {
      const mach = await machineService.get(req.machineId);
      document.getElementById("request-machine").textContent =
        `${mach?.companySerial || "N/A"} - ${mach?.model || ""}`;
    }
  } catch(err){ console.error("Error cargando request:", err); }

  // cargar info de la visita
  let machineIdForReading = null;
  try {
    const res = await fetch(`${API}/visits/${visitId}`);
    if(res.ok){
      const visit = (await res.json()).data || await res.json();
      document.getElementById("technician-name").value = visit.technician?.fullName || "N/A";
      document.getElementById("visit-datetime").value = visit.visitDatetime || "";
      document.getElementById("visit-notes").value = visit.visitNotes || "";
      document.getElementById("solved").checked = !!visit.solved;
      if(visit.takeMeterReading){
        chkMeter.checked = true;
        meterField.style.display = "block";
        document.getElementById("meter-reading").value = visit.meterReading || "";
      }
    }
  } catch(err){ console.error("Error cargando visita:", err); }

  // cargar repuestos ya existentes
  try {
    const res = await fetch(`${API}/visit-parts?visitId=${visitId}`);
    if(res.ok){
      const list = (await res.json()).data || [];
      existingPartsList.innerHTML = "";
      if(list.length){
        list.forEach(vp=>{
          const li = document.createElement("li");
          li.className = "list-group-item";
          li.textContent = `${vp.part?.name || "Parte"} (registrado el ${new Date(vp.date).toLocaleString()})`;
          existingPartsList.appendChild(li);
        });
      } else {
        existingPartsList.innerHTML = "<li class='list-group-item text-muted'>Sin repuestos registrados</li>";
      }
    }
  } catch(err){ console.error("Error cargando repuestos:", err); }

  // submit
  document.getElementById("visit-form").addEventListener("submit", async e=>{
    e.preventDefault();
    const btn = document.getElementById("btn-save");
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Guardando...';

    try {
      const dto = {
        visitNotes: document.getElementById("visit-notes").value,
        solved: document.getElementById("solved").checked,
        takeMeterReading: chkMeter.checked
      };

      // actualizar visita
      const updateRes = await fetch(`${API}/visits/${visitId}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(dto)
      });
      if(!updateRes.ok) throw new Error("Error actualizando visita");

      // crear lectura si aplica
      if(chkMeter.checked && document.getElementById("meter-reading").value){
        const req = await serviceRequestService.get(requestId);
        machineIdForReading = req.machineId;
        await fetch(`${API}/meter-readings`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            machineId: machineIdForReading,
            reading: Number(document.getElementById("meter-reading").value),
            readingDate: new Date().toISOString(),
            notes: `Lectura visita ${visitId}`
          })
        });
      }

      // crear visit-parts si aplica
      if(chkParts.checked){
        const selects = partsContainer.querySelectorAll("select");
        for(const sel of selects){
          if(sel.value){
            await fetch(`${API}/visit-parts`, {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({
                visitId: Number(visitId),
                partId: Number(sel.value),
                date: new Date().toISOString()
              })
            });
          }
        }
      }

      showAlert("Visita actualizada correctamente", "success");
      setTimeout(()=> appLoad("service_requests/detail.html"), 1200);
    } catch(err){
      console.error(err);
      showAlert("Error actualizando visita: " + err.message, "danger");
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save me-1"></i> Actualizar Visita';
    }
  });

})();
</script>