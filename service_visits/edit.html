<div class="card p-3">
    <h4>Editar Visita Técnica</h4>
    <form id="visit-edit-form">
        <div class="mb-3">
            <label class="form-label">Técnico</label>
            <select class="form-select" name="technicianId" id="technicianId"></select>
        </div>

        <div class="mb-3">
            <label>Notas</label>
            <textarea class="form-control" name="visitNotes"></textarea>
        </div>

        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="chk-meter" />
            <label class="form-check-label" for="chk-meter">¿Se tomó medida del contador?</label>
        </div>

        <div id="meter-fields" style="display:none">
            <input type="number" class="form-control mb-2" name="readingValue" placeholder="Valor de la lectura" />
        </div>

        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="chk-meter" />
            <label class="form-check-label" for="chk-meter">¿Se tomó medida del contador?</label>
        </div>

        <div id="meter-fields" style="display:none">
            <input type="number" class="form-control mb-2" name="reading" placeholder="Valor de la lectura" />
            <textarea class="form-control" name="readingNotes" placeholder="Notas de la medición"></textarea>
        </div>


        <button class="btn btn-success">Guardar Cambios</button>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(location.search);
        const visitId = params.get("id");

        // Mostrar campos de medición al marcar el checkbox
        document.getElementById("chk-meter").addEventListener("change", e => {
            document.getElementById("meter-fields").style.display = e.target.checked ? "block" : "none";
        });

        // Cargar datos de la visita
        const v = await fetch(`/visits/${visitId}`).then(r => r.json());

        const form = document.getElementById("visit-edit-form");
        form.technicianId.value = v.technicianId || "";
        form.visitNotes.value = v.visitNotes || "";
        form.solved.checked = v.solved || false;

        // Guardar cambios
        form.addEventListener("submit", async e => {
            e.preventDefault();
            const dto = {
                technicianId: form.technicianId.value,
                visitNotes: form.visitNotes.value,
                solved: form.solved.checked,
                takeMeterReading: document.getElementById("chk-meter").checked,
                readingValue: form.readingValue.value || null
            };

            await fetch(`/visits/${visitId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dto)
            });

            showAlert("Visita actualizada", "success");
            appLoad(`service_requests/detail.html`);
        });
    });
</script>