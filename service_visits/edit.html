<div class="card p-3">
  <h4>Editar Visita Técnica</h4>
  <form id="visit-form">
    <div class="mb-3">
      <label class="form-label">Técnico</label>
      <select class="form-select" id="technicians" name="technicianId"></select>
    </div>

    <div class="mb-3">
      <label>Notas</label>
      <textarea class="form-control" name="visitNotes"></textarea>
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="chk-meter">
      <label class="form-check-label" for="chk-meter">¿Se tomó lectura del contador?</label>
    </div>

    <div id="meter-fields" style="display:none">
      <input type="number" class="form-control mb-2" name="meterBefore" placeholder="Lectura antes">
      <input type="number" class="form-control" name="meterAfter" placeholder="Lectura después">
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" name="solved" id="solved">
      <label class="form-check-label" for="solved">¿Resuelto?</label>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary" id="btn-save">Actualizar Visita</button>
      <button type="button" class="btn btn-secondary" id="btn-cancel">Cancelar</button>
    </div>
  </form>
</div>

<script>
(async function() {
  const API = (typeof API_BASE !== "undefined") ? API_BASE.replace(/\/$/, '') : "";
  const params = new URLSearchParams(location.search);
  const visitId = params.get("id") || sessionStorage.getItem("selectedVisitId");
  const requestId = sessionStorage.getItem("selectedRequestId");
  const form = document.getElementById("visit-form");
  const techniciansSelect = document.getElementById("technicians");
  const chkMeter = document.getElementById("chk-meter");
  const meterFields = document.getElementById("meter-fields");
  const btnSave = document.getElementById("btn-save");
  const btnCancel = document.getElementById("btn-cancel");

  if (!visitId || !requestId) {
    showAlert("No se encontró la visita seleccionada.", "danger");
    return appLoad("service_requests/detail.html");
  }
  window.__VID = visitId;

  // Cancelar → vuelve al detalle
  btnCancel.addEventListener("click", () => appLoad("service_requests/detail.html"));

  // Toggle del contador
  chkMeter.addEventListener("change", e => {
    meterFields.style.display = e.target.checked ? "block" : "none";
  });

  // Cargar técnicos
  try {
    let techs = [];
    if (typeof technicianService !== "undefined" && technicianService.list) {
      techs = await technicianService.list();
    } else {
      const res = await fetch(API + "/technicians");
      const json = await res.json();
      techs = json?.data || json || [];
    }
    techniciansSelect.innerHTML = '<option value="">-- Seleccione técnico --</option>' +
      techs.map(t => `<option value="${t.id}">${t.fullName || t.name || t.identification}</option>`).join('');
  } catch(err) {
    console.error("Error cargando técnicos:", err);
    techniciansSelect.innerHTML = "<option value=''>-- Error cargando técnicos --</option>";
  }

  // Cargar visita actual
  try {
    const res = await fetch(`${API}/visits/${visitId}`);
    if (!res.ok) throw new Error("Error obteniendo visita");
    const v = (await res.json())?.data || await res.json();

    form.technicianId.value = v.technicianId || "";
    form.visitNotes.value = v.visitNotes || "";
    form.solved.checked = !!v.solved;

    if (v.meterReadingBefore != null || v.meterReadingAfter != null) {
      chkMeter.checked = true;
      meterFields.style.display = "block";
      form.meterBefore.value = v.meterReadingBefore || "";
      form.meterAfter.value = v.meterReadingAfter || "";
    }
  } catch(err) {
    console.error("Error cargando visita:", err);
    showAlert("Error cargando datos de la visita", "danger");
  }

  // Actualizar visita
  form.addEventListener("submit", async e => {
    e.preventDefault();
    btnSave.disabled = true;
    btnSave.innerText = "Actualizando...";

    try {
      const fd = new FormData(form);
      const dto = {
        technicianId: fd.get("technicianId") ? Number(fd.get("technicianId")) : null,
        visitNotes: fd.get("visitNotes") || null,
        solved: form.solved.checked,
        takeMeterReading: chkMeter.checked,
        meterReadingBefore: chkMeter.checked ? (fd.get("meterBefore") ? Number(fd.get("meterBefore")) : null) : null,
        meterReadingAfter: chkMeter.checked ? (fd.get("meterAfter") ? Number(fd.get("meterAfter")) : null) : null,
        reading: chkMeter.checked && fd.get("meterAfter") ? Number(fd.get("meterAfter")) : null,
        readingNotes: chkMeter.checked ? "Lectura actualizada desde frontend" : null
      };

      // Actualizar visita
      const updateRes = await fetch(`${API}/visits/${visitId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dto)
      });

      if (!updateRes.ok) {
        const txt = await updateRes.text().catch(()=>null);
        throw new Error("Error actualizando visita: " + (txt || updateRes.status));
      }

      // Si se resolvió, actualizar status del service_request a "CERRADO"
      if (form.solved.checked) {
        await fetch(`${API}/service_requests/${requestId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: "CERRADO" })
        });
      }

      showAlert("Visita actualizada correctamente", "success");
      appLoad("service_requests/detail.html");

    } catch(err) {
      console.error(err);
      showAlert(err.message || "Error actualizando visita", "danger");
      btnSave.disabled = false;
      btnSave.innerText = "Actualizar Visita";
    }
  });

})();
</script>
