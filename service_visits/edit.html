<div class="card p-3">
  <h4>Editar Visita Técnica</h4>
  
  <!-- Información del request -->
  <div class="mb-3">
    <label class="form-label">Cliente</label>
    <input type="text" id="cliente" class="form-control" readonly>
  </div>
  <div class="mb-3">
    <label class="form-label">Máquina</label>
    <input type="text" id="maquina" class="form-control" readonly>
  </div>
  <div class="mb-3">
    <label class="form-label">Técnico asignado</label>
    <input type="text" id="tecnicoAsignado" class="form-control" readonly>
  </div>

  <form id="visit-form">
    <div class="mb-3">
      <label class="form-label">Notas de la visita</label>
      <textarea class="form-control" name="visitNotes"></textarea>
    </div>

    <!-- Lectura -->
    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="chk-meter">
      <label class="form-check-label" for="chk-meter">¿Se tomó lectura?</label>
    </div>
    <div id="meter-fields" style="display:none">
      <input type="number" class="form-control mb-2" name="meterBefore" placeholder="Lectura antes">
      <input type="number" class="form-control" name="meterAfter" placeholder="Lectura después">
    </div>

    <!-- Resuelto -->
    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" name="solved">
      <label class="form-check-label">¿Resuelto?</label>
    </div>

    <!-- Repuestos -->
    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="chk-parts">
      <label class="form-check-label">¿Requiere repuestos?</label>
    </div>
    <div id="parts-container" style="display:none"></div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary" id="btn-save">Actualizar Visita</button>
      <button type="button" class="btn btn-secondary" id="btn-cancel">Cancelar</button>
    </div>
  </form>
</div>

<script>
(async function(){
  const API = API_BASE.replace(/\/$/, '');
  const params = new URLSearchParams(location.search);
  const visitId = params.get("id") || sessionStorage.getItem("selectedVisitId");
  const requestId = sessionStorage.getItem("selectedRequestId");

  const form = document.getElementById("visit-form");
  const chkMeter = document.getElementById("chk-meter");
  const meterFields = document.getElementById("meter-fields");
  const chkParts = document.getElementById("chk-parts");
  const partsContainer = document.getElementById("parts-container");
  const btnCancel = document.getElementById("btn-cancel");
  const btnSave = document.getElementById("btn-save");

  if (!visitId || !requestId) {
    showAlert("No se encontró la visita seleccionada.", "danger");
    return appLoad("service_requests/detail.html");
  }

  // Cancelar
  btnCancel.addEventListener("click", () => appLoad("service_requests/detail.html"));

  // Toggle lectura
  chkMeter.addEventListener("change", e=>{
    meterFields.style.display = e.target.checked ? "block" : "none";
  });

  // Toggle repuestos
  chkParts.addEventListener("change", e=>{
    if(e.target.checked){
      partsContainer.style.display = "block";
      partsContainer.innerHTML = "";
      addPartSelector();
    } else {
      partsContainer.innerHTML = "";
      partsContainer.style.display = "none";
    }
  });

  // Añadir un selector de parts
  async function addPartSelector(){
    const res = await fetch(`${API}/parts`);
    const parts = (await res.json()).data || [];

    const wrapper = document.createElement("div");
    wrapper.classList.add("d-flex","mb-2","gap-2");

    const select = document.createElement("select");
    select.classList.add("form-select");
    select.innerHTML = '<option value="">-- Seleccione repuesto --</option>' +
      parts.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

    const btnAdd = document.createElement("button");
    btnAdd.type = "button";
    btnAdd.className = "btn btn-sm btn-secondary";
    btnAdd.innerText = "+";
    btnAdd.onclick = () => addPartSelector();

    wrapper.appendChild(select);
    wrapper.appendChild(btnAdd);
    partsContainer.appendChild(wrapper);
  }

  // Cargar info del service-request
  try {
    const res = await fetch(`${API}/service-requests/${requestId}`);
    if(res.ok){
      const data = (await res.json()).data || await res.json();
      document.getElementById("cliente").value = data.client?.fullName || data.client?.name || "N/A";
      document.getElementById("maquina").value = data.machine?.serial || data.machine?.name || "N/A";
      document.getElementById("tecnicoAsignado").value = data.technician?.fullName || data.technician?.name || "N/A";
    }
  } catch(err){ console.error("Error cargando request:", err); }

  // Cargar visita
  let machineIdForReading = null;
  try {
    const res = await fetch(`${API}/visits/${visitId}`);
    if(res.ok){
      const visit = (await res.json()).data || await res.json();
      form.visitNotes.value = visit.visitNotes || "";
      form.solved.checked = !!visit.solved;
      if (visit.meterReadingBefore != null || visit.meterReadingAfter != null){
        chkMeter.checked = true;
        meterFields.style.display = "block";
        form.meterBefore.value = visit.meterReadingBefore || "";
        form.meterAfter.value = visit.meterReadingAfter || "";
      }
    }
  } catch(err){ console.error("Error cargando visita:", err); }

  // Guardar visita
  form.addEventListener("submit", async e=>{
    e.preventDefault();
    btnSave.disabled = true;
    btnSave.innerText = "Actualizando...";

    try {
      const fd = new FormData(form);
      const dto = {
        visitNotes: fd.get("visitNotes") || null,
        solved: form.solved.checked,
        takeMeterReading: chkMeter.checked,
        meterReadingBefore: chkMeter.checked ? (fd.get("meterBefore") ? Number(fd.get("meterBefore")) : null) : null,
        meterReadingAfter: chkMeter.checked ? (fd.get("meterAfter") ? Number(fd.get("meterAfter")) : null) : null,
      };

      // 1) Actualizar visita
      const updateRes = await fetch(`${API}/visits/${visitId}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(dto)
      });
      if(!updateRes.ok) throw new Error("Error actualizando visita");

      // 2) Crear lectura si aplica
      if(chkMeter.checked && fd.get("meterAfter")){
        const reqRes = await fetch(`${API}/service-requests/${requestId}`);
        if(reqRes.ok){
          const reqData = (await reqRes.json()).data || await reqRes.json();
          machineIdForReading = reqData?.machineId || reqData?.machine?.id;
        }
        if(machineIdForReading){
          await fetch(`${API}/meter-readings`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
              machineId: machineIdForReading,
              reading: Number(fd.get("meterAfter")),
              readingDate: new Date().toISOString(),
              notes: `Lectura creada desde visita ${visitId}`
            })
          });
        }
      }

      // 3) Crear visit-parts si aplica
      if(chkParts.checked){
        const selects = partsContainer.querySelectorAll("select");
        for(const sel of selects){
          if(sel.value){
            await fetch(`${API}/visit-parts`, {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({
                visitId: Number(visitId),
                partId: Number(sel.value),
                date: new Date().toISOString()
              })
            });
          }
        }
      }

      showAlert("Visita actualizada correctamente", "success");
      appLoad("service_requests/detail.html");
    } catch(err){
      console.error(err);
      showAlert(err.message || "Error al actualizar", "danger");
      btnSave.disabled = false;
      btnSave.innerText = "Actualizar Visita";
    }
  });
})();
</script>
