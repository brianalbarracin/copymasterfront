<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Nueva Visita Técnica</h4>
    <button class="btn btn-outline-secondary btn-sm" onclick="appLoad('service_requests/detail.html')">
      <i class="fas fa-arrow-left me-1"></i> Volver a Solicitud
    </button>
  </div>

  <!-- Información de la Solicitud Asociada -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Solicitud de Servicio Asociada</h6>
    </div>
    <div class="card-body">
      <div class="row" id="request-info">
        <div class="col-md-6">
          <strong>Solicitud #:</strong> <span id="request-number">Cargando...</span><br>
          <strong>Cliente:</strong> <span id="request-customer">Cargando...</span><br>
          <strong>Máquina:</strong> <span id="request-machine">Cargando...</span>
        </div>
        <div class="col-md-6">
          <strong>Tipo de Servicio:</strong> <span id="request-type">Cargando...</span><br>
          <strong>Causa Raíz:</strong> <span id="request-rootcause">Cargando...</span><br>
          <strong>Estado Actual:</strong> <span id="request-status">Cargando...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario nueva visita -->
  <form id="visit-form" class="row g-3" novalidate>
    <input type="hidden" name="serviceRequestId" id="service-request-id">
    
    <div class="col-md-6">
      <label class="form-label">Técnico *</label>
      <select class="form-select" id="technicians" name="technicianId" required>
        <option value="">Seleccione un técnico</option>
      </select>
      <div class="invalid-feedback">Por favor seleccione un técnico</div>
    </div>

    <div class="col-md-6">
      <label class="form-label">Fecha y Hora de la Visita *</label>
      <input type="datetime-local" class="form-control" name="visitDatetime" id="visit-datetime" required>
      <div class="invalid-feedback">Por favor ingrese la fecha y hora de la visita</div>
    </div>

    <div class="col-12">
      <label class="form-label">Notas de la Visita *</label>
      <textarea class="form-control" name="visitNotes" id="visit-notes" rows="4" placeholder="Describa los trabajos realizados, observaciones, repuestos utilizados, etc." required></textarea>
      <div class="invalid-feedback">Por favor ingrese las notas de la visita</div>
    </div>

    <div class="col-12">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="solved" id="solved">
        <label class="form-check-label" for="solved">
          <strong>¿Solicitud resuelta?</strong> (Marcar si el problema fue solucionado completamente)
        </label>
      </div>
    </div>

    <div class="col-12">
      <button class="btn btn-success" type="submit" id="btn-submit">
        <i class="fas fa-save me-1"></i> Registrar Visita
      </button>
      <button class="btn btn-outline-secondary" type="button" onclick="appLoad('service_requests/detail.html')">
        <i class="fas fa-times me-1"></i> Cancelar
      </button>
    </div>
  </form>
</div>

<script>


(async function initNewVisit() {
  const requestId = sessionStorage.getItem("selectedRequestId");
  if (!requestId) {
    showAlert("No se encontró la solicitud seleccionada.", "danger");
    appLoad("service_requests/list.html");
    return;
  }

  // set id en hidden
  document.getElementById('service-request-id').value = requestId;

  // set datetime default
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  document.getElementById('visit-datetime').value = now.toISOString().slice(0, 16);

  try {
    await loadRequestInfo(requestId);
    await loadTechnicians();
  } catch (err) {
    console.error("Error inicializando:", err);
    showAlert("Error al cargar datos iniciales", "danger");
  }

  document.getElementById("visit-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;

    if (!form.checkValidity()) {
      e.stopPropagation();
      form.classList.add("was-validated");
      return;
    }

    const btn = document.getElementById("btn-submit");
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Guardando...';

    try {
      const visitData = {
        serviceRequestId: parseInt(requestId),
        technicianId: parseInt(document.getElementById("technicians").value),
        visitDatetime: document.getElementById("visit-datetime").value,
        visitNotes: document.getElementById("visit-notes").value,
        solved: document.getElementById("solved").checked
      };

      console.log("Enviando visita:", visitData);

      const visitResult = await serviceVisitService.create(visitData);

      if (visitResult?.id) {
        try {
          await serviceRequestService.update(requestId, { status: "EN_PROCESO" });
        } catch (err2) {
          console.warn("No se pudo actualizar solicitud:", err2);
        }

        showAlert("Visita registrada correctamente", "success");
        setTimeout(() => appLoad("service_requests/detail.html"), 1500);
      } else {
        throw new Error("Respuesta inválida del servidor");
      }
    } catch (err) {
      console.error("Error registrando visita:", err);
      showAlert("Error registrando visita: " + (err.message || "Error desconocido"), "danger");
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save me-1"></i> Registrar Visita';
    }
  });
})();

async function loadRequestInfo(requestId) {
  const req = await serviceRequestService.get(requestId);
  if (!req) throw new Error("Solicitud no encontrada");

  document.getElementById("request-number").textContent = req.requestNumber || req.id;
  document.getElementById("request-type").textContent = req.serviceType || "N/A";
  document.getElementById("request-rootcause").textContent = req.rootCause || "N/A";
  document.getElementById("request-status").textContent = req.status || "N/A";

  if (req.customerId) {
    try {
      const cust = await customerService.get(req.customerId);
      document.getElementById("request-customer").textContent = cust?.name || "Cliente no disponible";
    } catch {
      document.getElementById("request-customer").textContent = "Error cargando cliente";
    }
  } else {
    document.getElementById("request-customer").textContent = "No asignado";
  }

  if (req.machineId) {
    try {
      const mach = await machineService.get(req.machineId);
      document.getElementById("request-machine").textContent =
        `${mach?.companySerial || "N/A"} - ${mach?.model || ""}`;
    } catch {
      document.getElementById("request-machine").textContent = "Error cargando máquina";
    }
  } else {
    document.getElementById("request-machine").textContent = "No asignada";
  }
}

async function loadTechnicians() {
  const list = await technicianService.list();
  const sel = document.getElementById("technicians");
  sel.innerHTML = '<option value="">Seleccione un técnico</option>';
  if (list?.length) {
    list.forEach(t => {
      if (t.active !== false) {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = `${t.fullName}${t.specialty ? " - " + t.specialty : ""}`;
        sel.appendChild(opt);
      }
    });
  }
}
</script>

<style>
.form-control:invalid, .form-select:invalid { border-color: #dc3545; }
.form-control:valid, .form-select:valid { border-color: #198754; }
#request-info strong { color: #0f9d58; min-width: 120px; display: inline-block; }
</style>