<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Nueva Visita Técnica</h4>
    <button class="btn btn-outline-secondary btn-sm" onclick="appLoad('service_requests/detail.html')">
      <i class="fas fa-arrow-left me-1"></i> Volver a Solicitud
    </button>
  </div>

  <!-- Información de la Solicitud Asociada -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Solicitud de Servicio Asociada</h6>
    </div>
    <div class="card-body">
      <div class="row" id="request-info">
        <div class="col-md-6">
          <strong>Solicitud #:</strong> <span id="request-number">Cargando...</span><br>
          <strong>Cliente:</strong> <span id="request-customer">Cargando...</span><br>
          <strong>Máquina:</strong> <span id="request-machine">Cargando...</span>
        </div>
        <div class="col-md-6">
          <strong>Tipo de Servicio:</strong> <span id="request-type">Cargando...</span><br>
          <strong>Causa Raíz:</strong> <span id="request-rootcause">Cargando...</span><br>
          <strong>Estado Actual:</strong> <span id="request-status">Cargando...</span>
        </div>
      </div>
    </div>
  </div>

  <form id="visit-form" class="row g-3">
    <input type="hidden" name="serviceRequestId" id="service-request-id">
    
    <div class="col-md-6">
      <label class="form-label">Técnico *</label>
      <select class="form-select" id="technicians" name="technicianId" required>
        <option value="">Seleccione un técnico</option>
        <!-- Las opciones se cargarán dinámicamente -->
      </select>
      <div class="invalid-feedback">Por favor seleccione un técnico</div>
    </div>

    <div class="col-md-6">
      <label class="form-label">Fecha y Hora de la Visita *</label>
      <input type="datetime-local" class="form-control" name="visitDatetime" id="visit-datetime" required>
      <div class="invalid-feedback">Por favor ingrese la fecha y hora de la visita</div>
    </div>

    <div class="col-12">
      <label class="form-label">Notas de la Visita *</label>
      <textarea class="form-control" name="visitNotes" rows="4" placeholder="Describa los trabajos realizados, observaciones, repuestos utilizados, etc." required></textarea>
      <div class="invalid-feedback">Por favor ingrese las notas de la visita</div>
    </div>

    <div class="col-12">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="solved" id="solved" value="true">
        <label class="form-check-label" for="solved">
          <strong>¿Solicitud resuelta?</strong> (Marcar si el problema fue solucionado completamente)
        </label>
      </div>
    </div>

    <div class="col-12">
      <button class="btn btn-success" type="submit" id="btn-submit">
        <i class="fas fa-save me-1"></i> Registrar Visita
      </button>
      <button class="btn btn-outline-secondary" type="button" onclick="appLoad('service_requests/detail.html')">
        <i class="fas fa-times me-1"></i> Cancelar
      </button>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const requestId = sessionStorage.getItem("selectedRequestId");
  
  if (!requestId) {
    showAlert("No se encontró la solicitud seleccionada.", "danger");
    appLoad("service_requests/list.html");
    return;
  }

  // Elementos del DOM
  const form = document.getElementById("visit-form");
  const techniciansSelect = document.getElementById("technicians");
  const btnSubmit = document.getElementById("btn-submit");
  const requestInfo = document.getElementById("request-info");

  // Establecer fecha y hora actual por defecto
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  document.getElementById('visit-datetime').value = now.toISOString().slice(0, 16);

  // Establecer el ID de la solicitud en el formulario
  document.getElementById('service-request-id').value = requestId;

  try {
    // Cargar información de la solicitud
    await loadRequestInfo(requestId);
    
    // Cargar lista de técnicos
    await loadTechnicians();
    
  } catch (error) {
    console.error("Error inicializando formulario:", error);
    showAlert("Error al cargar los datos del formulario", "danger");
  }

  // Manejar envío del formulario
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    if (!form.checkValidity()) {
      e.stopPropagation();
      form.classList.add('was-validated');
      return;
    }

    btnSubmit.disabled = true;
    btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Guardando...';

    try {
      const formData = new FormData(form);
      const visitData = {
        serviceRequestId: parseInt(requestId),
        technicianId: parseInt(formData.get("technicianId")),
        visitDatetime: formData.get("visitDatetime"),
        visitNotes: formData.get("visitNotes"),
        solved: formData.get("solved") === "true"
      };

      console.log("Datos de la visita a enviar:", visitData);

      // Crear la visita
      const visitResult = await serviceVisitService.create(visitData);
      
      if (visitResult && visitResult.id) {
        // Actualizar el estado de la solicitud a "EN_PROCESO"
        try {
          await serviceRequestService.update(requestId, { 
            status: "EN_PROCESO" 
          });
          console.log("Estado de la solicitud actualizado a EN_PROCESO");
        } catch (updateError) {
          console.warn("No se pudo actualizar el estado de la solicitud:", updateError);
        }

        showAlert("Visita técnica registrada correctamente", "success");
        
        // Redirigir al detalle de la solicitud después de 1.5 segundos
        setTimeout(() => {
          appLoad("service_requests/detail.html");
        }, 1500);
      } else {
        throw new Error("No se recibió confirmación del servidor");
      }

    } catch (error) {
      console.error("Error registrando visita:", error);
      showAlert("Error al registrar la visita: " + (error.message || "Error desconocido"), "danger");
      btnSubmit.disabled = false;
      btnSubmit.innerHTML = '<i class="fas fa-save me-1"></i> Registrar Visita';
    }
  });
});

async function loadRequestInfo(requestId) {
  try {
    const request = await serviceRequestService.get(requestId);
    
    if (!request) {
      throw new Error("Solicitud no encontrada");
    }

    // Actualizar información de la solicitud
    document.getElementById("request-number").textContent = request.requestNumber || request.id;
    document.getElementById("request-type").textContent = request.serviceType || "N/A";
    document.getElementById("request-rootcause").textContent = request.rootCause || "N/A";
    document.getElementById("request-status").textContent = request.status || "N/A";

    // Cargar información del cliente si está disponible
    if (request.customerId) {
      try {
        const customer = await customerService.get(request.customerId);
        document.getElementById("request-customer").textContent = customer?.name || "Cliente no disponible";
      } catch (error) {
        document.getElementById("request-customer").textContent = "Error cargando cliente";
      }
    } else {
      document.getElementById("request-customer").textContent = "No asignado";
    }

    // Cargar información de la máquina si está disponible
    if (request.machineId) {
      try {
        const machine = await machineService.get(request.machineId);
        document.getElementById("request-machine").textContent = 
          `${machine?.companySerial || "N/A"} - ${machine?.model || ""}`;
      } catch (error) {
        document.getElementById("request-machine").textContent = "Error cargando máquina";
      }
    } else {
      document.getElementById("request-machine").textContent = "No asignada";
    }

  } catch (error) {
    console.error("Error cargando información de la solicitud:", error);
    document.getElementById("request-info").innerHTML = 
      '<div class="col-12 text-center text-danger">Error cargando información de la solicitud</div>';
  }
}

async function loadTechnicians() {
  try {
    const technicians = await technicianService.list();
    const techniciansSelect = document.getElementById("technicians");
    
    techniciansSelect.innerHTML = '<option value="">Seleccione un técnico</option>';
    
    if (technicians && technicians.length > 0) {
      technicians.forEach(tech => {
        if (tech.active !== false) { // Solo técnicos activos
          const option = document.createElement("option");
          option.value = tech.id;
          option.textContent = `${tech.fullName}${tech.specialty ? ` - ${tech.specialty}` : ''}`;
          techniciansSelect.appendChild(option);
        }
      });
      
      if (techniciansSelect.options.length === 1) {
        techniciansSelect.innerHTML = '<option value="">No hay técnicos disponibles</option>';
      }
    } else {
      techniciansSelect.innerHTML = '<option value="">No se encontraron técnicos</option>';
    }
  } catch (error) {
    console.error("Error cargando técnicos:", error);
    document.getElementById("technicians").innerHTML = 
      '<option value="">Error cargando técnicos</option>';
    showAlert("Error al cargar la lista de técnicos", "warning");
  }
}
</script>

<style>
.form-control:invalid, .form-select:invalid {
  border-color: #dc3545;
}

.form-control:valid, .form-select:valid {
  border-color: #198754;
}

#request-info strong {
  color: #0f9d58;
  min-width: 120px;
  display: inline-block;
}
</style>