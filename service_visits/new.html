<div class="card p-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Nueva Visita T√©cnica</h4>
    <button class="btn btn-outline-secondary btn-sm" onclick="appLoad('service_requests/detail.html')">
      <i class="fas fa-arrow-left me-1"></i> Volver a Solicitud
    </button>
  </div>

  <!-- Informaci√≥n de la Solicitud Asociada -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h6 class="mb-0">Solicitud de Servicio Asociada</h6>
    </div>
    <div class="card-body">
      <div class="row" id="request-info">
        <div class="col-md-6">
          <strong>Solicitud #:</strong> <span id="request-number">Cargando...</span><br>
          <strong>Cliente:</strong> <span id="request-customer">Cargando...</span><br>
          <strong>M√°quina:</strong> <span id="request-machine">Cargando...</span>
        </div>
        <div class="col-md-6">
          <strong>Tipo de Servicio:</strong> <span id="request-type">Cargando...</span><br>
          <strong>Causa Ra√≠z:</strong> <span id="request-rootcause">Cargando...</span><br>
          <strong>Estado Actual:</strong> <span id="request-status">Cargando...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario nueva visita -->
  <form id="visit-form" class="row g-3" novalidate>
    <input type="hidden" name="serviceRequestId" id="service-request-id">

    <div class="col-md-6">
      <label class="form-label">T√©cnico *</label>
      <select class="form-select" id="technicians" name="technicianId" required>
        <option value="">Seleccione un t√©cnico</option>
      </select>
      <div class="invalid-feedback">Por favor seleccione un t√©cnico</div>
    </div>

    <div class="col-md-6">
      <label class="form-label">Fecha y Hora de la Visita *</label>
      <input type="datetime-local" class="form-control" name="visitDatetime" id="visit-datetime" required>
      <div class="invalid-feedback">Por favor ingrese la fecha y hora de la visita</div>
    </div>


    <div class="col-12">
      <label class="form-label">Causa Ra√≠z (Diagn√≥stico) *</label>
      <select class="form-select" name="rootCauseId" id="root-cause-select" required>
        <option value="">Seleccione una causa ra√≠z</option>
        <!-- Las opciones se cargar√°n con JavaScript -->
      </select>
      <div id="root-cause-categories" class="mt-2"></div>
    </div>

    <div class="col-12">
      <label class="form-label">Notas de la Visita *</label>
      <textarea class="form-control" name="visitNotes" id="visit-notes" rows="4"
        placeholder="Describa los trabajos realizados, observaciones, repuestos utilizados, etc." required></textarea>
      <div class="invalid-feedback">Por favor ingrese las notas de la visita</div>
    </div>

    <div class="col-12">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="solved" id="solved">
        <label class="form-check-label" for="solved">
          <strong>¬øSolicitud resuelta?</strong> (Marcar si el problema fue solucionado completamente)
        </label>
      </div>
    </div>

    <div class="col-12">
      <button class="btn btn-success" type="submit" id="btn-submit">
        <i class="fas fa-save me-1"></i> Registrar Visita
      </button>
      <button class="btn btn-outline-secondary" type="button" onclick="appLoad('service_requests/detail.html')">
        <i class="fas fa-times me-1"></i> Cancelar
      </button>
    </div>
  </form>
</div>

<script>


  (async function initNewVisit() {
    const requestId = sessionStorage.getItem("selectedRequestId");
    if (!requestId) {
      showAlert("No se encontr√≥ la solicitud seleccionada.", "danger");
      appLoad("service_requests/list.html");
      return;
    }

    // set id en hidden
    document.getElementById('service-request-id').value = requestId;

    // set datetime default
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('visit-datetime').value = now.toISOString().slice(0, 16);

    try {
      await loadRequestInfo(requestId);
      await loadTechnicians();
      await loadRootCausesForVisit();
    } catch (err) {
      console.error("Error inicializando:", err);
      showAlert("Error al cargar datos iniciales", "danger");
    }

    document.getElementById("visit-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;

      if (!form.checkValidity()) {
        e.stopPropagation();
        form.classList.add("was-validated");
        return;
      }

      const btn = document.getElementById("btn-submit");
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Guardando...';

      try {
        const visitData = {
          serviceRequestId: parseInt(requestId),
          technicianId: parseInt(document.getElementById("technicians").value),
          visitDatetime: document.getElementById("visit-datetime").value + "-05:00",
          visitNotes: document.getElementById("visit-notes").value,
          solved: document.getElementById("solved").checked
        };

        console.log("Enviando visita:", visitData);

        const visitResult = await serviceVisitService.create(visitData);

        if (visitResult?.id) {
          try {
            await fetch(`${API_BASE}/service-requests/${requestId}/status?status=EN_PROCESO`, {
              method: "PUT"
            });
          } catch (err2) {
            console.warn("No se pudo actualizar solicitud:", err2);
          }

          showAlert("Visita registrada correctamente", "success");
          setTimeout(() => appLoad("service_requests/detail.html"), 1500);
        } else {
          throw new Error("Respuesta inv√°lida del servidor");
        }
      } catch (err) {
        console.error("Error registrando visita:", err);
        showAlert("Error registrando visita: " + (err.message || "Error desconocido"), "danger");
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-1"></i> Registrar Visita';
      }
    });
  })();

  async function loadRequestInfo(requestId) {
    const req = await serviceRequestService.get(requestId);
    if (!req) throw new Error("Solicitud no encontrada");

    document.getElementById("request-number").textContent = req.requestNumber || req.id;
    document.getElementById("request-type").textContent = req.serviceType || "N/A";
    document.getElementById("request-rootcause").textContent = req.rootCause || "N/A";
    document.getElementById("request-status").textContent = req.status || "N/A";

    if (req.customerId) {
      try {
        const cust = await customerService.get(req.customerId);
        document.getElementById("request-customer").textContent = cust?.name || "Cliente no disponible";
      } catch {
        document.getElementById("request-customer").textContent = "Error cargando cliente";
      }
    } else {
      document.getElementById("request-customer").textContent = "No asignado";
    }

    if (req.machineId) {
      try {
        const mach = await machineService.get(req.machineId);
        document.getElementById("request-machine").textContent =
          `${mach?.companySerial || "N/A"} - ${mach?.model || ""}`;
      } catch {
        document.getElementById("request-machine").textContent = "Error cargando m√°quina";
      }
    } else {
      document.getElementById("request-machine").textContent = "No asignada";
    }
  }

  async function loadTechnicians() {
    const list = await technicianService.list();
    const sel = document.getElementById("technicians");
    sel.innerHTML = '<option value="">Seleccione un t√©cnico</option>';
    if (list?.length) {
      list.forEach(t => {
        if (t.active !== false) {
          const opt = document.createElement("option");
          opt.value = t.id;
          opt.textContent = `${t.fullName}${t.specialty ? " - " + t.specialty : ""}`;
          sel.appendChild(opt);
        }
      });
    }
  }

async function loadRootCausesForVisit() {
    console.log("üîç Cargando causas ra√≠z para visita...");
    
    try {
        const groupedCauses = await rootCauseService.getGrouped();
        const select = document.getElementById('root-cause-select');
        const categoriesDiv = document.getElementById('root-cause-categories');
        
        // Limpiar select
        select.innerHTML = '<option value="">Seleccione una causa ra√≠z</option>';
        
        if (!groupedCauses || Object.keys(groupedCauses).length === 0) {
            categoriesDiv.innerHTML = '<div class="alert alert-warning">No hay causas ra√≠z configuradas</div>';
            return;
        }
        
        // Crear botones de categor√≠as
        let categoriesHtml = '<div class="btn-group flex-wrap" role="group">';
        for (const [category, causes] of Object.entries(groupedCauses)) {
            categoriesHtml += `
            <button type="button" class="btn btn-outline-secondary btn-sm m-1" 
                    onclick="filterRootCausesForVisit('${category}')">
                ${category}
            </button>
            `;
        }
        categoriesHtml += '</div>';
        categoriesDiv.innerHTML = categoriesHtml;
        
        // Almacenar todas las causas para filtrado
        window.allRootCausesVisit = [];
        for (const [category, causes] of Object.entries(groupedCauses)) {
            causes.forEach(cause => {
                window.allRootCausesVisit.push({
                    id: cause.id,
                    name: cause.name,
                    category: category
                });
                
                // Agregar al select
                const option = document.createElement('option');
                option.value = cause.id;
                option.textContent = `${category} - ${cause.name}`;
                option.setAttribute('data-category', category);
                select.appendChild(option);
            });
        }
        
    } catch (err) {
        console.error("‚ùå Error cargando causas ra√≠z para visita:", err);
        loadHardcodedRootCausesForVisit();
    }
}


// Funci√≥n para filtrar causas por categor√≠a
function filterRootCausesForVisit(category) {
    const select = document.getElementById('root-cause-select');
    select.innerHTML = '<option value="">Seleccione una causa ra√≠z</option>';
    
    if (!window.allRootCausesVisit) return;
    
    // Filtrar por categor√≠a y agregar al select
    const filteredCauses = window.allRootCausesVisit.filter(cause => cause.category === category);
    filteredCauses.forEach(cause => {
        const option = document.createElement('option');
        option.value = cause.id;
        option.textContent = `${cause.category} - ${cause.name}`;
        select.appendChild(option);
    });
}

// Funci√≥n de respaldo con datos hardcodeados
function loadHardcodedRootCausesForVisit() {
    console.log("‚ö†Ô∏è Cargando causas ra√≠z hardcodeadas para visita...");
    
    const groupedCauses = {
        "CONTADORES / LECTURAS": [
            { id: 1, name: "CONTADOR", category: "CONTADORES / LECTURAS" },
            { id: 2, name: "TOMA DE CONTADORES", category: "CONTADORES / LECTURAS" }
        ],
        "TONER / TINTA": [
            { id: 6, name: "RECARGA TONER", category: "TONER / TINTA" },
            { id: 8, name: "TONER", category: "TONER / TINTA" }
        ]
    };
    
    const select = document.getElementById('root-cause-select');
    const categoriesDiv = document.getElementById('root-cause-categories');
    
    select.innerHTML = '<option value="">Seleccione una causa ra√≠z</option>';
    
    let categoriesHtml = '<div class="btn-group flex-wrap" role="group">';
    for (const [category, causes] of Object.entries(groupedCauses)) {
        categoriesHtml += `
        <button type="button" class="btn btn-outline-secondary btn-sm m-1" 
                onclick="filterRootCausesForVisit('${category}')">
            ${category}
        </button>
        `;
        
        causes.forEach(cause => {
            if (!window.allRootCausesVisit) window.allRootCausesVisit = [];
            window.allRootCausesVisit.push(cause);
            
            const option = document.createElement('option');
            option.value = cause.id;
            option.textContent = `${category} - ${cause.name}`;
            select.appendChild(option);
        });
    }
    categoriesHtml += '</div>';
    
    categoriesDiv.innerHTML = categoriesHtml + 
        '<div class="alert alert-info mt-2"><small>‚ö†Ô∏è Usando datos de prueba</small></div>';
}





</script>

<style>
  .form-control:invalid,
  .form-select:invalid {
    border-color: #dc3545;
  }

  .form-control:valid,
  .form-select:valid {
    border-color: #198754;
  }

  #request-info strong {
    color: #0f9d58;
    min-width: 120px;
    display: inline-block;
  }
</style>