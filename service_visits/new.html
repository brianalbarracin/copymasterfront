<div class="card p-3"> 
  <h4>Nueva Visita Técnica</h4>
  <form id="visit-form">
    <div class="mb-3">
      <label class="form-label">Técnico</label>
      <select class="form-select" id="technicians" name="technicianId"></select>
    </div>

    <div class="mb-3">
      <label>Notas</label>
      <textarea class="form-control" name="visitNotes"></textarea>
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="chk-meter">
      <label class="form-check-label" for="chk-meter">¿Se tomó lectura del contador?</label>
    </div>

    <div id="meter-fields" style="display:none">
      <input type="number" class="form-control mb-2" name="meterBefore" placeholder="Lectura antes">
      <input type="number" class="form-control" name="meterAfter" placeholder="Lectura después">
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" name="solved" id="solved">
      <label class="form-check-label" for="solved">¿Resuelto?</label>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-success" id="btn-save">Guardar Visita</button>
      <button type="button" class="btn btn-secondary" id="btn-cancel">Cancelar</button>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const API = (typeof API_BASE !== "undefined") ? API_BASE.replace(/\/$/, '') : "";
  const requestId = sessionStorage.getItem("selectedRequestId");

  if (!requestId) {
    showAlert("No se encontró la solicitud seleccionada.", "danger");
    return appLoad("service_requests/list.html");
  }

  const techniciansSelect = document.getElementById("technicians");
  const chkMeter = document.getElementById("chk-meter");
  const meterFields = document.getElementById("meter-fields");
  const form = document.getElementById("visit-form");
  const btnSave = document.getElementById("btn-save");
  const btnCancel = document.getElementById("btn-cancel");

  // cancelar → vuelve al detalle
  btnCancel.addEventListener("click", () => {
    appLoad("service_requests/detail.html");
  });

  // cargar técnicos
  try {
    let techs = [];
    if (typeof technicianService !== "undefined" && technicianService.list) {
      techs = await technicianService.list();
    } else {
      const res = await fetch(API + "/technicians");
      const json = await res.json();
      techs = json?.data || json || [];
    }
    techniciansSelect.innerHTML = techs.map(t => 
      `<option value="${t.id}">${t.fullName || t.name || t.identification || t.id}</option>`
    ).join("") || "<option value=''>-- No hay técnicos --</option>";
  } catch (err) {
    console.error("Error cargando técnicos:", err);
    techniciansSelect.innerHTML = "<option value=''>-- Error cargando técnicos --</option>";
  }

  // toggle de campos de contador
  chkMeter.addEventListener("change", (e) => {
    meterFields.style.display = e.target.checked ? "block" : "none";
  });

  // guardar visita
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    btnSave.disabled = true;
    btnSave.innerText = "Guardando...";

    try {
      const fd = new FormData(form);
      const dto = {
        serviceRequestId: Number(requestId),
        technicianId: fd.get("technicianId") ? Number(fd.get("technicianId")) : null,
        visitNotes: fd.get("visitNotes") || null,
        solved: form.solved.checked === true,
        meterReadingBefore: chkMeter.checked ? (fd.get("meterBefore") ? Number(fd.get("meterBefore")) : null) : null,
        meterReadingAfter: chkMeter.checked ? (fd.get("meterAfter") ? Number(fd.get("meterAfter")) : null) : null,
      };

      if (!dto.technicianId) {
        showAlert("Selecciona un técnico.", "warning");
        btnSave.disabled = false;
        btnSave.innerText = "Guardar Visita";
        return;
      }

      // crear visita
      const createRes = await fetch(API + "/visits", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dto)
      });

      if (!createRes.ok) {
        const txt = await createRes.text().catch(()=>null);
        throw new Error("Error creando visita: " + (txt || createRes.status));
      }

      // actualizar estado de la solicitud
      await fetch(`${API}/service-requests/${requestId}/status`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: "EN_PROCESO" })
      }).catch(()=>console.warn("No se pudo actualizar estado"));

      showAlert("Visita creada correctamente", "success");
      appLoad("service_requests/detail.html");

    } catch (err) {
      console.error(err);
      showAlert(err.message || "Error creando visita", "danger");
      btnSave.disabled = false;
      btnSave.innerText = "Guardar Visita";
    }
  });
});
</script>